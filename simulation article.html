<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ru" xml:lang="ru"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Манаенков Александр">

<title>You’re going to Brazil или Считаем размер выборки для A/B-теста в бразильском маркетплейсе</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="simulation article_files/libs/clipboard/clipboard.min.js"></script>
<script src="simulation article_files/libs/quarto-html/quarto.js"></script>
<script src="simulation article_files/libs/quarto-html/popper.min.js"></script>
<script src="simulation article_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="simulation article_files/libs/quarto-html/anchor.min.js"></script>
<link href="simulation article_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="simulation article_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="simulation article_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="simulation article_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="simulation article_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="simulation article_files/libs/kePrint-0.0.1/kePrint.js"></script>

<link href="simulation article_files/libs/lightable-0.0.1/lightable.css" rel="stylesheet">


  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Оглавление</h2>
   
  <ul>
  <li><a href="#прелюдия" id="toc-прелюдия" class="nav-link active" data-scroll-target="#прелюдия">0. Прелюдия</a>
  <ul>
  <li><a href="#для-кого-эта-статья" id="toc-для-кого-эта-статья" class="nav-link" data-scroll-target="#для-кого-эта-статья">0.1 Для кого эта статья?</a></li>
  <li><a href="#что-и-как-будем-делать" id="toc-что-и-как-будем-делать" class="nav-link" data-scroll-target="#что-и-как-будем-делать">0.2 Что и как будем делать?</a>
  <ul>
  <li><a href="#почему-r" id="toc-почему-r" class="nav-link" data-scroll-target="#почему-r">0.2.1 Почему R?</a></li>
  <li><a href="#почему-quarto" id="toc-почему-quarto" class="nav-link" data-scroll-target="#почему-quarto">0.2.2 Почему Quarto?</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#знакомимся-с-данными" id="toc-знакомимся-с-данными" class="nav-link" data-scroll-target="#знакомимся-с-данными">1. Знакомимся с данными</a>
  <ul>
  <li><a href="#метрики-и-их-динамика" id="toc-метрики-и-их-динамика" class="nav-link" data-scroll-target="#метрики-и-их-динамика">1.1 Метрики и их динамика</a></li>
  <li><a href="#ratio-или-не-ratio" id="toc-ratio-или-не-ratio" class="nav-link" data-scroll-target="#ratio-или-не-ratio">1.2 Ratio или не ratio?</a></li>
  </ul></li>
  <li><a href="#размер-выборки-по-формулам" id="toc-размер-выборки-по-формулам" class="nav-link" data-scroll-target="#размер-выборки-по-формулам">2. Размер выборки по формулам</a>
  <ul>
  <li><a href="#sec-ref_bernoulli" id="toc-sec-ref_bernoulli" class="nav-link" data-scroll-target="#sec-ref_bernoulli">2.1 Доля успехов как общая пропорция</a></li>
  <li><a href="#доля-успехов-как-пропорция-на-пользователя" id="toc-доля-успехов-как-пропорция-на-пользователя" class="nav-link" data-scroll-target="#доля-успехов-как-пропорция-на-пользователя">2.2 Доля успехов как пропорция на пользователя</a></li>
  <li><a href="#доля-успехов-линеаризованная" id="toc-доля-успехов-линеаризованная" class="nav-link" data-scroll-target="#доля-успехов-линеаризованная">2.3 Доля успехов линеаризованная</a></li>
  </ul></li>
  <li><a href="#симуляции-подготовка" id="toc-симуляции-подготовка" class="nav-link" data-scroll-target="#симуляции-подготовка">3. Симуляции: подготовка</a>
  <ul>
  <li><a href="#число-заказов-на-пользователя" id="toc-число-заказов-на-пользователя" class="nav-link" data-scroll-target="#число-заказов-на-пользователя">3.1 Число заказов на пользователя</a>
  <ul>
  <li><a href="#бутстрап-симуляции" id="toc-бутстрап-симуляции" class="nav-link" data-scroll-target="#бутстрап-симуляции">3.1.1 Бутстрап-симуляции</a></li>
  <li><a href="#распределение-пуассона" id="toc-распределение-пуассона" class="nav-link" data-scroll-target="#распределение-пуассона">3.1.2 Распределение Пуассона</a>
  <ul class="collapse">
  <li><a href="#лишние-нули" id="toc-лишние-нули" class="nav-link" data-scroll-target="#лишние-нули">3.1.2.1 Лишние нули</a></li>
  <li><a href="#некорректная-дисперсия" id="toc-некорректная-дисперсия" class="nav-link" data-scroll-target="#некорректная-дисперсия">3.1.2.2 Некорректная дисперсия</a></li>
  </ul></li>
  <li><a href="#распределение-конвея-максвелла-пуассона" id="toc-распределение-конвея-максвелла-пуассона" class="nav-link" data-scroll-target="#распределение-конвея-максвелла-пуассона">3.1.3 Распределение Конвея-Максвелла-Пуассона</a></li>
  </ul></li>
  <li><a href="#вероятность-успешного-заказа-на-пользователя" id="toc-вероятность-успешного-заказа-на-пользователя" class="nav-link" data-scroll-target="#вероятность-успешного-заказа-на-пользователя">3.2 Вероятность успешного заказа на пользователя</a></li>
  <li><a href="#число-и-доля-успешных-доставок-на-пользователя" id="toc-число-и-доля-успешных-доставок-на-пользователя" class="nav-link" data-scroll-target="#число-и-доля-успешных-доставок-на-пользователя">3.3 Число и доля успешных доставок на пользователя</a></li>
  <li><a href="#как-будем-действовать" id="toc-как-будем-действовать" class="nav-link" data-scroll-target="#как-будем-действовать">3.4 Как будем действовать</a></li>
  </ul></li>
  <li><a href="#симуляции-реализация" id="toc-симуляции-реализация" class="nav-link" data-scroll-target="#симуляции-реализация">4. Симуляции: реализация</a>
  <ul>
  <li><a href="#неправильный-тест" id="toc-неправильный-тест" class="nav-link" data-scroll-target="#неправильный-тест">4.1 “Неправильный” тест</a>
  <ul>
  <li><a href="#fpr" id="toc-fpr" class="nav-link" data-scroll-target="#fpr">4.1.1 FPR</a></li>
  <li><a href="#мощность" id="toc-мощность" class="nav-link" data-scroll-target="#мощность">4.1.2 Мощность</a></li>
  </ul></li>
  <li><a href="#средняя-доля-на-пользователя" id="toc-средняя-доля-на-пользователя" class="nav-link" data-scroll-target="#средняя-доля-на-пользователя">4.2 Средняя доля на пользователя</a>
  <ul>
  <li><a href="#fpr-1" id="toc-fpr-1" class="nav-link" data-scroll-target="#fpr-1">4.2.1 FPR</a></li>
  <li><a href="#мощность-1" id="toc-мощность-1" class="nav-link" data-scroll-target="#мощность-1">4.2.2 Мощность</a></li>
  </ul></li>
  <li><a href="#линеаризованная-доля" id="toc-линеаризованная-доля" class="nav-link" data-scroll-target="#линеаризованная-доля">4.3 Линеаризованная доля</a>
  <ul>
  <li><a href="#fpr-2" id="toc-fpr-2" class="nav-link" data-scroll-target="#fpr-2">4.3.1 FPR</a></li>
  <li><a href="#мощность-2" id="toc-мощность-2" class="nav-link" data-scroll-target="#мощность-2">4.3.2 Мощность</a></li>
  <li><a href="#кривая-мощности" id="toc-кривая-мощности" class="nav-link" data-scroll-target="#кривая-мощности">4.3.3 Кривая мощности</a></li>
  </ul></li>
  <li><a href="#линеаризованная-доля-варианты-пуассона" id="toc-линеаризованная-доля-варианты-пуассона" class="nav-link" data-scroll-target="#линеаризованная-доля-варианты-пуассона">4.4 Линеаризованная доля: варианты Пуассона</a>
  <ul>
  <li><a href="#fpr-неправильный-тест-распределение" id="toc-fpr-неправильный-тест-распределение" class="nav-link" data-scroll-target="#fpr-неправильный-тест-распределение">4.4.1 FPR (неправильный тест, распределение)</a></li>
  <li><a href="#fpr-линеаризация-кривая" id="toc-fpr-линеаризация-кривая" class="nav-link" data-scroll-target="#fpr-линеаризация-кривая">4.4.1 FPR (линеаризация, кривая)</a></li>
  <li><a href="#мощность-линеаризация-кривая" id="toc-мощность-линеаризация-кривая" class="nav-link" data-scroll-target="#мощность-линеаризация-кривая">4.4.2 Мощность (линеаризация, кривая)</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#выводы" id="toc-выводы" class="nav-link" data-scroll-target="#выводы">5. Выводы</a></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">You’re going to Brazil или Считаем размер выборки для A/B-теста в бразильском маркетплейсе</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Автор</div>
    <div class="quarto-title-meta-contents">
             <p>Манаенков Александр </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="прелюдия" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="прелюдия">0. Прелюдия</h2>
<p>Однажды мы в <a href="https://karpov.courses/">karpov.courses</a> решили обновить блок продуктовой аналитики на курсе “<a href="https://karpov.courses/analytics">Аналитик данных</a>”. Поменялось много чего, но среди прочего в конце блока появился итоговый проект, где студенты должны были самостоятельно проанализировать данные какого-то <a href="https://www.kaggle.com/datasets/olistbr/brazilian-ecommerce">бразильского маркетплейса</a> . И одна из (бывших)<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> задач этого проекта – рассчитать необходимый размер выборки для будущего эксперимента (АБ-теста).</p>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;В итоге эта задача оказалась слишком сложной для начинающих аналитиков без опыта подобного анализа, поэтому мы её убрали. Тем полезнее этот документ.</p></div></div><p>Расчёт необходимого размера выборки – важная вещь и в научных, и в индустриальных исследованиях. Знание того, как много данных нам нужно собрать, чтобы быть уверенными в результатах, дорогого стоит. Однако так ли легко это сделать?</p>
<p>Очень часто в изучении какой-то темы можно встретить три этапа:</p>
<ol type="1">
<li>“Господи, это что такое? Не понимаю.”</li>
<li>“А, так вот что это такое! Я уловил идею!”</li>
<li>“АААААААААААААААААААА КАК ЖЕ ВСЁ СЛОЖНО <em>падает в бездну человеческого невежества</em>”</li>
</ol>
<p>Расчёт размера выборки в этом плане не исключение. Эти три пункта в таком случае выглядят вот так:</p>
<ol type="1">
<li>“Да как его считать-то? Какой функцией, что в этой функции надо указать, откуда вообще брать значения этих чисел?”</li>
<li>“А, понятненько. Вот тут указываем ошибку I рода, вот тут указываем мощность, вот тут минимальное различие. Не везде понятно, как это различие считать, но для t-критерия это легко - просто делим ожидаемое различие в средних на стандартное отклонение метрики. Подумать надо, конечно, но в целом процедура простая.”</li>
<li>“У КАЖДОЙ ФОРМУЛЫ ЕСТЬ ДОПУЩЕНИЯ КАК МЫ МОЖЕМ ЗНАТЬ ЧТО ОНИ СОБЛЮДАЮТСЯ ЧТО ДЕЛАТЬ ЕСЛИ ЭТО НЕ ТАК АААААААААААА <em>падает в бездну различий между статистикой и реальным миром”</em></li>
</ol>
<p>Все студенты гарантированно начинают с 1 стадии. Мы надеемся, что заинтересованный в статистике и A/B-тестах студент вскорости дойдёт до 2 стадии. Беда в том, что я сам уже давно нахожусь в 3 стадии и знаю, что формулам расчёта размера выборки нельзя слепо верить. Как писал в своём блоге нейроучёный Guillaume D. Rousselet, “<a href="https://garstats.wordpress.com/2017/11/28/your-power-is-lower-than-you-think/">Your power is lower what you think</a>” – реальный размер выборки может быть совсем не тем, каким мы его ожидаем, и очень часто он должен быть выше.</p>
<p>Как в таком случае понять, сколько на самом деле надо? Идеального ответа, конечно же, нет, но есть близкий к этому - путём <strong>симуляции данных</strong>. Логика простая<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>:</p>
<div class="no-row-height column-margin column-container"><div id="fn2"><p><sup>2</sup>&nbsp;Да, я люблю нумерованные списки. Что вы мне сделаете? Ничего.</p></div></div><ol type="1">
<li>Имитируем данные, идентичные натуральным</li>
<li>Используем на этих данных интересующий нас статистический критерий</li>
<li>Смотрим, насколько хорошо он с этими данными справляется</li>
</ol>
<p>Так можно проверять много чего, но в контексте расчёта размера выборки идея простая: варьируем размер этих симулированных данных, смотрим, для какого размера данных наш тест становится достаточно чувствительным.</p>
<p>Естественно, “идея простая” не значит “реализация простая” – как-никак мы пытаемся симулировать процесс того, как эти данные могли возникнуть, что намного сложнее подставления чисел в формулу. К тому же нам всё ещё приходится делать допущение, что созданная нами имитация процесса отражает все необходимые его характеристики, иначе в точность расчётов верить нельзя. Но это лучший вариант из возможных.</p>
<section id="для-кого-эта-статья" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="для-кого-эта-статья">0.1 Для кого эта статья?</h3>
<p>Пожалуй, моя главная целевая аудитория – это студенты karpov.courses и им сочувствующие. В целом эта штука может быть интересна всем, кто когда-нибудь пытался самостоятельно считать размер выборки или в целом любит статистический анализ данных.</p>
<p>По ходу текста я буду приводить краткие справки на тему релевантных этой работе идей. Однако это не учебник по статистике, и поэтому для совсем неискушённого в этих вопросах читателя этот текст будет сложноват. Поэтому назову несколько вещей, которые я ожидаю от читающих этот трактат. Вы хотя бы примерно должны понимать:</p>
<ol type="1">
<li>Что я вообще такое написал в вводной части;</li>
<li>Каким образом формируются экспериментальные группы в A/B-тестах;</li>
<li>Что такое среднее и дисперсия/стандартное отклонение;</li>
<li>Что такое распределения данных;</li>
<li>Что такое статистические тесты и какие они бывают (если знаете, что такое t-критерий – супер);</li>
<li>В чём заключается смысл p-value и как его использовать<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>;</li>
<li>(желательно) Английский язык – многие материалы, на которые я буду давать ссылки, являются англоязычными, и владение английским в целом будет очень полезно для понимания происходящего;</li>
<li>(очень желательно) Как писать код для анализа данных – если у вас есть опыт работы с тем же Python, то структура работы для вас будет более понятной. В какой-то момент у меня будет много комментариев по поводу написанного мной кода, и для читателей без какого-либо опыта программирования это будет восприниматься как шум. Впрочем, надеюсь, что даже в таком случае общая идея работы останется понятной.</li>
</ol>
<div class="no-row-height column-margin column-container"><div id="fn3"><p><sup>3</sup>&nbsp;Это самый коварный пункт, так как p-value довольно часто ложно интерпретируют. Я ожидаю хотя бы самого смутного понимания, как оно фигурирует в принятии решений на основе статистики, но дополнительно приложу ссылку на <a href="https://www.ohri.ca/newsroom/seminars/SeminarUploads/1829%5CSuggested%20Reading%20-%20Nov%203,%202014.pdf">разбор самых частых мифов про p-value</a>.</p></div></div></section>
<section id="что-и-как-будем-делать" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="что-и-как-будем-делать">0.2 Что и как будем делать?</h3>
<p>У нас есть данные, которые содержат в себе информацию о заказах пользователей и их статусе. В частности, нас интересует доля неотменённых заказов и сколько наблюдений нам нужно, чтобы зафиксировать изменение этой доли на 1%. Сначала мы попробуем оценить размер выборки несколькими формулами, затем перейдём к симуляциям и по итогу сравним результаты.</p>
<p>В качестве инструмента анализа я использую здесь язык R и его пакеты. Сама html-страничка, которую вы сейчас читаете, сделана с использованием Quatro. Ниже я кратко сформулирую, почему я пользуюсь именно ими, а не Python/Jupyter Notebook.</p>
<section id="почему-r" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="почему-r">0.2.1 Почему R?</h4>
<p><a href="https://www.r-project.org/">R</a> – один из двух наиболее известных языков программирования, используемых для анализа данных (наряду с Python). Однако исторически сложилось так, что R в большей степени распространён в социальных науках и медицинских исследованиях, в то время как в индустрии доминирует Python (особенно на территории России и стран СНГ). Так почему в этой работе используется именно R, а не Python - особенно учитывая, что в karpov.courses мы учим именно Python?</p>
<p>Первая причина на момент написания этой работы уже неактуальна – чтобы будущие студенты karpov.courses не списывали отсюда решение задания. Хотя сообразительный студент всё ещё сможет переложить реализованные здесь идеи на Python, это всё ещё требует самостоятельной работы и в моих глазах уже не является читерством. Слабые студенты же сделать это вряд ли смогут, даже с помощью ChatGPT<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>. Опять же, так как это больше не задание проекта, это уже не столь принципиально.</p>
<div class="no-row-height column-margin column-container"><div id="fn4"><p><sup>4</sup>&nbsp;Если вы решите это сделать и у вас получатся хоть какие-то осмысленные результаты – напишите мне!</p></div></div><p>Вторая причина предельно простая: я <strong>очень люблю R как инструмент анализа данных</strong>. Наверное, будь я программистом по образованию, моё мнение было бы иное – однако я по образованию психолог и подхожу к вопросу именно как исследователь в поисках удобного инструмента. И так вышло, что для многих вещей, связанных со статистикой, мне R кажется намного более удобным, чем Python. К тому же я R знаю гораздо дольше (это мой первый язык программирования) и поэтому для меня он комфортнее как минимум ввиду большей привычности.</p>
<p>Третья причина отчасти связана с предыдущей: ряд вещей, которые мне пригодятся в этой работе, на Python либо реализованы кривенько, либо не реализованы вообще (или я просто не знаю, как их сделать). Соответственно, грех не воспользоваться инструментом, который эти возможности даёт.</p>
<p>Наконец, не исключаю, что после чтения этой работы кто-то сам заинтересуется R как инструментом аналитики. В таком случае это будет мой небольшой вклад в русскоязычное R-коммьюнити :)</p>
</section>
<section id="почему-quarto" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="почему-quarto">0.2.2 Почему Quarto?</h4>
<p><a href="https://quarto.org/">Quatro</a> – это ПО для создания отчётности в ряде различных форматов. HTML, Word и PDF являются стандартными вариантами, но в Quatro также можно делать презентации, дашборды, статьи и другие подобные вещи. По сути это потомок <a href="https://rmarkdown.rstudio.com/">RMarkdown</a>, существовавшего для этих же целей, но привязанного только к R. Quarto же поддерживает ещё Python, Julia и Observable.</p>
<p>Технически я мог бы сделать эту работу в Jupyter Notebook – как я уже делал это <a href="https://github.com/allomulder/monte_carlo_shenanigans/blob/main/1.%20%D0%9A%D0%BE%D0%BD%D0%B2%D0%B5%D1%80%D1%81%D0%B8%D1%8F%20%D0%B8%20%D1%80%D0%B0%D0%B7%D0%BC%D0%B5%D1%80%20%D0%B2%D1%8B%D0%B1%D0%BE%D1%80%D0%BA%D0%B8.ipynb">ранее</a>. Хотя это в первую очередь инструмент для питонистов, R он тоже поддерживает<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>. Однако Quarto как инструмент отчётности позволяет делать много приятных вещей, связанных с оформлением повествования, которые в Jupyter приходится делать либо путём редактирования HTML, либо вообще нельзя сделать.</p>
<div class="no-row-height column-margin column-container"><div id="fn5"><p><sup>5</sup>&nbsp;Само название <a href="https://en.wikipedia.org/wiki/Project_Jupyter">Jupyter</a> происходит от названий трёх языков программирования, которые он поддерживает: <strong>Ju</strong>lia, <strong>Pyt</strong>hon, <strong>R</strong>.</p></div><div id="fn6"><p><sup>6</sup>&nbsp;Есть также ряд пакетов, которые тут не импортированы, но я всё ещё использую их функции (в R так можно). Как правило, это пакеты, которые мне нужны 1-2 раза и не так важны для повествования, но их функционал важен для моего кода. В коде они представлены в виде <code>название_пакета::название_функции()</code>.</p></div></div><p>Одна из таких вещей – это возможность сворачивать код (на блогерском жаргоне “прятать под катом”). Приведу сразу же пример: если вы тыкнете на название “Основные импорты” ниже, то увидите список основных пакетов, используемых в этой работе<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>:</p>
<div class="cell">
<details class="code-fold">
<summary>Основные импорты</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse) <span class="co">#подготовка данных и визуализация</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra) <span class="co">#форматирование табличек</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pwr) <span class="co">#мощность по формулам</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork) <span class="co">#склеивание нескольких графиков в один</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(COMPoissonReg) <span class="co">#для распределения CMP</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(extraDistr) <span class="co">#дополнительные функции распределений</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(furrr) <span class="co">#для исполнения функций параллельно</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(progressr) <span class="co">#шкала прогресса</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co">#а заодно шрифты для заголовка и подписей к графикам</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>title_theme <span class="ot">&lt;-</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">family =</span> <span class="st">"Formular"</span>, </span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">face =</span> <span class="st">"bold"</span>, </span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">size =</span> <span class="dv">20</span>), </span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>                     <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">family =</span> <span class="st">"Input Mono"</span>, </span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">face =</span> <span class="st">"bold"</span>, </span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">size =</span> <span class="dv">15</span>), </span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>                     <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">family =</span> <span class="st">"Input Mono"</span>, </span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">face =</span> <span class="st">"bold"</span>, </span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">size =</span> <span class="dv">16</span>))</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Большая часть кода далее также будет свёрнута, но вы можете развернуть и посмотреть на него, если вам интересны детали. В некоторых местах код полностью спрятан (если он совсем не важен для повествования), а в некоторых виден сразу (если он является частью повествования).</p>
<p>Есть и другие прикольные вещи, которые я тут активно эксплуатирую<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>. Я не буду обращать на них ваше внимание, но если вдруг у вас в голове проскочит мысль “о, как интересно выглядит, как это было сделано?” или вам даже просто понравится формат этой работы – обязательно загляните в документацию Quarto. Возможно, вам тоже понравится с этим работать.</p>
<div class="no-row-height column-margin column-container"><div id="fn7"><p><sup>7</sup>&nbsp;Например, вот эти сноски на полях. Сюда я буду помещать дополнительные материалы или просто единичные высказывания на тему.</p></div></div><p>Теперь, когда мы всё проговорили, время приступать к анализу!</p>
</section>
</section>
</section>
<section id="знакомимся-с-данными" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="знакомимся-с-данными">1. Знакомимся с данными</h2>
<p>Прежде чем заниматься всякой разной статистикой, стоит понять, с чем мы вообще работаем. Оригинальный набор данных состоит аж из 9 файлов с разными полями (в нашем курсе используется 3, что тоже много), но нам понадобятся всего 4 поля. Они представлены ниже:</p>
<div class="cell">
<details class="code-fold">
<summary>Данные</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#читаем данные </span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>orders <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"Data/olist_orders_dataset.csv"</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>users <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"Data/olist_customers_dataset.csv"</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">#объединяем в единую табличку</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>orders <span class="sc">%&gt;%</span> </span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(users, <span class="at">by =</span> <span class="st">"customer_id"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(customer_unique_id, order_id, </span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>         order_status, order_purchase_timestamp) <span class="ot">-&gt;</span> df</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co">#избавляемся от лишних переменных</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(orders)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(users)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co">#выводим первые 7 строк в виде таблички</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_material</span>(<span class="at">font_size =</span> <span class="dv">12</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class=" lightable-material" style="font-size: 12px; font-family: &quot;Source Sans Pro&quot;, helvetica, sans-serif; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;"> customer_unique_id </th>
   <th style="text-align:left;"> order_id </th>
   <th style="text-align:left;"> order_status </th>
   <th style="text-align:left;"> order_purchase_timestamp </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> 7c396fd4830fd04220f754e42b4e5bff </td>
   <td style="text-align:left;"> e481f51cbdc54678b7cc49136f2d6af7 </td>
   <td style="text-align:left;"> delivered </td>
   <td style="text-align:left;"> 2017-10-02 10:56:33 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> af07308b275d755c9edb36a90c618231 </td>
   <td style="text-align:left;"> 53cdb2fc8bc7dce0b6741e2150273451 </td>
   <td style="text-align:left;"> delivered </td>
   <td style="text-align:left;"> 2018-07-24 20:41:37 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 3a653a41f6f9fc3d2a113cf8398680e8 </td>
   <td style="text-align:left;"> 47770eb9100c2d0c44946d9cf07ec65d </td>
   <td style="text-align:left;"> delivered </td>
   <td style="text-align:left;"> 2018-08-08 08:38:49 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 7c142cf63193a1473d2e66489a9ae977 </td>
   <td style="text-align:left;"> 949d5b44dbf5de918fe9c16f97b45f8a </td>
   <td style="text-align:left;"> delivered </td>
   <td style="text-align:left;"> 2017-11-18 19:28:06 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 72632f0f9dd73dfee390c9b22eb56dd6 </td>
   <td style="text-align:left;"> ad21c59c0840e6cb83a9ceb5573f8159 </td>
   <td style="text-align:left;"> delivered </td>
   <td style="text-align:left;"> 2018-02-13 21:18:39 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 80bb27c7c16e8f973207a5086ab329e2 </td>
   <td style="text-align:left;"> a4591c265e18cb1dcee52889e2d8acc3 </td>
   <td style="text-align:left;"> delivered </td>
   <td style="text-align:left;"> 2017-07-09 21:57:05 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p><br>
Что означает каждое поле?</p>
<ul>
<li><p><strong>customer_unique_id</strong> — уникальный идентификационный номер клиента (id или айдишник). По этому полю мы можем понять, кто именно делал заказ, при этом не привязываясь к конкретным именам и не нарушая анонимности покупателя.</p></li>
<li><p><strong>order_id</strong> — аналогично, но для заказов.</p></li>
<li><p><strong>order_status</strong> — статус заказа. Он может принимать следующие значения:</p>
<ul>
<li><p><em>created</em> – создан</p></li>
<li><p><em>approved</em> – подтверждён</p></li>
<li><p><em>invoiced</em> – выставлен счёт</p></li>
<li><p><em>processing</em> – в процессе сборки</p></li>
<li><p><em>shipped</em> – отгружен со склада</p></li>
<li><p><em>delivered</em> – доставлен покупателю</p></li>
<li><p><em>unavailable</em> – недоступен</p></li>
<li><p><em>canceled</em> – отменён</p></li>
</ul></li>
<li><p><strong>order_purchase_timestamp</strong> — время покупки заказа.</p></li>
</ul>
<p>Всего в этом наборе данных 99441 строка. Примечательно, что уникальных заказов в нём также 99441. Это важное наблюдение – оно означает, что в данных указан только последний статус заказа, без его истории. Из-за этого мы теряем часть информации<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>, но в то же время это упрощает нам подготовку данных.</p>
<div class="no-row-height column-margin column-container"><div id="fn8"><p><sup>8</sup>&nbsp;Например, мы не можем сказать, в какой момент происходила отмена заказа – только сам факт, что его в итоге отменили. В реальной жизни знание точек “отвала” пользователей критически важно, так как позволяет локализовать проблему и точечно искать пути её решения.</p></div></div><p>Прежде чем идти дальше, стоит определиться, какие заказы мы будем считать отменёнными; пусть это будут статусы <em>canceled</em> и <em>unavailable</em>. Соответственно, остальные статусы заказов мы будем считать неотменёнными/успешными.</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Внимание!
</div>
</div>
<div class="callout-body-container callout-body">
<p>Фактически мы делаем допущение, что все остальные заказы, у которых ещё нет статуса <em>delivered</em>, в конечном итоге будут успешно доставлены. С этим можно не согласиться и считать неотменёнными заказами только те, которые явно были доставлены – но здесь мы поступим так.</p>
</div>
</div>
<p>Добавим в нашу табличку два дополнительных поля:</p>
<ul>
<li><p><strong>success</strong> — был ли заказ успешным (1) или его отменили (0).</p></li>
<li><p><strong>ym</strong> — год и месяц создания заказа. Так нам будет удобнее смотреть на месячную динамику показателей бизнеса.</p></li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Новые колонки</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">success =</span> <span class="dv">1</span> <span class="sc">-</span> (order_status <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"canceled"</span>, <span class="st">"unavailable"</span>)),</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">ym =</span> lubridate<span class="sc">::</span><span class="fu">format_ISO8601</span>(order_purchase_timestamp, </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">precision =</span> <span class="st">"ym"</span>)) <span class="ot">-&gt;</span> df</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(success, ym) <span class="sc">%&gt;%</span> </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_material</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>, </span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>                 <span class="at">font_size =</span> <span class="dv">16</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class=" lightable-material" style="font-size: 16px; font-family: &quot;Source Sans Pro&quot;, helvetica, sans-serif; width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:center;"> success </th>
   <th style="text-align:center;"> ym </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:center;"> 1 </td>
   <td style="text-align:center;"> 2017-10 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 1 </td>
   <td style="text-align:center;"> 2018-07 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 1 </td>
   <td style="text-align:center;"> 2018-08 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 1 </td>
   <td style="text-align:center;"> 2017-11 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 1 </td>
   <td style="text-align:center;"> 2018-02 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 1 </td>
   <td style="text-align:center;"> 2017-07 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p><br>
С базовой подготовкой данных закончили – давайте теперь смотреть, как жил наш маркетплейс всё это время.</p>
<section id="метрики-и-их-динамика" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="метрики-и-их-динамика">1.1 Метрики и их динамика</h3>
<p>Для начала сконцентрируемся на двух показателях (метриках) – количестве заказов в месяц и доле успешных заказов в месяц.</p>
<div class="cell">
<details class="code-fold">
<summary>Помесячные метрики</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_orders =</span> <span class="fu">n</span>(), </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">total_successes =</span> <span class="fu">sum</span>(success), </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">.by =</span> ym) <span class="sc">%&gt;%</span> </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ratio =</span> total_successes <span class="sc">/</span> total_orders) <span class="sc">%&gt;%</span> </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(ym) <span class="ot">-&gt;</span> month_metrics</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Первым делом нарисуем общее число заказов в месяц. Получаем вот такой линейный график:</p>
<div class="cell">
<details class="code-fold">
<summary>Рисуем:</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>month_metrics <span class="sc">%&gt;%</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ym =</span> lubridate<span class="sc">::</span><span class="fu">parse_date_time</span>(ym, <span class="st">"Y-m"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> ym, <span class="at">y =</span> total_orders, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"#FC563C"</span>, <span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span> </span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as.numeric</span>(<span class="fu">as_datetime</span>(<span class="st">"2018-08-01"</span>)), </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">linetype =</span> <span class="dv">3</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Месяц"</span>, <span class="at">y =</span> <span class="st">"Число заказов"</span>, </span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Месячная динамика числа заказов"</span>) <span class="sc">+</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  see<span class="sc">::</span><span class="fu">theme_lucid</span>(<span class="at">axis.text.size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  title_theme</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/orders%20per%20month-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Что мы можем сказать по этому графику?</p>
<ul>
<li><p>Первые заказы начали появляться в конце 2016 года.</p></li>
<li><p>Весь 2017 год число заказов в месяц постепенно росло.</p></li>
<li><p>В 2018 году число заказов вышло на плато – каждый месяц мы наблюдаем примерно одинаковое число заказов. Так продолжается до августа 2018 (указан вертикальным пунктиром).</p></li>
<li><p>После этой даты происходит резкое падение числа заказов – пользователи словно потеряли интерес к маркетплейсу.</p></li>
</ul>
<p>Теперь посмотрим на долю успешных заказов. Даст ли эта метрика дополнительное понимание ситуации?</p>
<div class="cell">
<details class="code-fold">
<summary>Рисуем:</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>month_metrics <span class="sc">%&gt;%</span> </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ym =</span> lubridate<span class="sc">::</span><span class="fu">parse_date_time</span>(ym, <span class="st">"Y-m"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> ym, <span class="at">y =</span> ratio, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"deepskyblue"</span>, <span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span> </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as.numeric</span>(<span class="fu">as_datetime</span>(<span class="st">"2018-08-01"</span>)), </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">linetype =</span> <span class="dv">3</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Месяц"</span>, <span class="at">y =</span> <span class="st">"Доля успешных заказов"</span>, </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Месячная динамика доли успешных заказов"</span>) <span class="sc">+</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  see<span class="sc">::</span><span class="fu">theme_lucid</span>(<span class="at">axis.text.size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  title_theme</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/ratio%20per%20month-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>О чём нам это говорит:</p>
<ul>
<li><p>Сначала (в 2016 году) примерно половина заказов в итоге отменялась.</p></li>
<li><p>В 2017 году доля успешных заказов быстро стабилизируется на довольно высоком уровне.</p></li>
<li><p>В сентябре 2018 доля успешных заказов резко падает, как и число всех заказов.</p></li>
</ul>
<p>Вряд ли одновременное падение обеих этих метрик является случайным совпадением. Возможная причина – сбой на платформе маркетплейса, не позволяющий делать заказы; это объяснило бы тот факт, что в целом число заказов резко уменьшилось, а немногие оформленные заказы по большей части отменились.</p>
<p>Давайте взглянем на ту же ситуацию в разрезе пользовательской активности – в конце концов, заказы не берутся из ниоткуда, их делают пользователи. Было бы интересно глянуть, сколько заказов <strong>в среднем</strong> делает <strong>один пользователь</strong> в месяц. Аналогично с долей успешных заказов – вероятно, что у некоторых пользователей заказы отменяются чаще, чем у других.</p>
<div class="cell">
<details class="code-fold">
<summary>Помесячные метрики на пользователя</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_orders =</span> <span class="fu">n</span>(), </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">total_successes =</span> <span class="fu">sum</span>(success), </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">.by =</span> <span class="fu">c</span>(customer_unique_id, ym)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ratio =</span> total_successes <span class="sc">/</span> total_orders) <span class="sc">%&gt;%</span> </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean_orders =</span> <span class="fu">mean</span>(total_orders), </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean_ratio =</span> <span class="fu">mean</span>(ratio), </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">.by =</span> ym) <span class="sc">%&gt;%</span> </span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(ym) <span class="ot">-&gt;</span> month_user_metrics</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Начнём со среднего числа заказов на пользователя:</p>
<div class="cell">
<details class="code-fold">
<summary>Рисуем:</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>month_user_metrics <span class="sc">%&gt;%</span> </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ym =</span> lubridate<span class="sc">::</span><span class="fu">parse_date_time</span>(ym, <span class="st">"Y-m"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> ym, <span class="at">y =</span> mean_orders, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"#FC563C"</span>, <span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span> </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as.numeric</span>(<span class="fu">as_datetime</span>(<span class="st">"2018-08-01"</span>)), </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">linetype =</span> <span class="dv">3</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Месяц"</span>, <span class="at">y =</span> <span class="st">"Среднее число заказов"</span>, </span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Месячная динамика числа заказов</span><span class="sc">\n</span><span class="st">на пользователя"</span>) <span class="sc">+</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  see<span class="sc">::</span><span class="fu">theme_lucid</span>(<span class="at">axis.text.size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  title_theme</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/mean%20orders%20per%20month-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Что мы здесь видим:</p>
<ul>
<li><p>Большую часть времени пользователи в среднем делают всего один заказ в месяц. Само по себе это скорее нормально, но определённые подозрения тут быть могут<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a>.</p></li>
<li><p>В сентябре 2018 число заказов резко подскакивает вверх. Либо кто-то многократно пытался создать заказ, либо это боты.</p></li>
</ul>
<div class="no-row-height column-margin column-container"><div id="fn9"><p><sup>9</sup>&nbsp;Как я продемонстрирую дальше, большинство пользователей делают один заказ <strong>в принципе</strong> и больше не возвращаются. И это уже серьёзная проблема: это значит, что вся выручка маркетплейса держится на притоке новых пользователей, и в долгосрочной перспективе это приведёт к гибели бизнеса. Возможно, именно это и происходит 2018-09.</p></div></div><p>А вот как выглядит средняя доля успешных заказов на пользователя:</p>
<div class="cell">
<details class="code-fold">
<summary>Рисуем:</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>month_user_metrics <span class="sc">%&gt;%</span> </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ym =</span> lubridate<span class="sc">::</span><span class="fu">parse_date_time</span>(ym, <span class="st">"Y-m"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> ym, <span class="at">y =</span> mean_ratio, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"deepskyblue"</span>, <span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span> </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as.numeric</span>(<span class="fu">as_datetime</span>(<span class="st">"2018-08-01"</span>)), </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">linetype =</span> <span class="dv">3</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Месяц"</span>, <span class="at">y =</span> <span class="st">"Средняя доля успешных заказов"</span>, </span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Месячная динамика доли успешных заказов</span><span class="sc">\n</span><span class="st">на пользователя"</span>) <span class="sc">+</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  see<span class="sc">::</span><span class="fu">theme_lucid</span>(<span class="at">axis.text.size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  title_theme</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/mean%20ratio%20per%20month-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Визуально практически не отличается от просто доли успешных заказов. В целом неудивительно, учитывая, что в среднем каждый пользователь делает всего один заказ в месяц.</p>
</section>
<section id="ratio-или-не-ratio" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="ratio-или-не-ratio">1.2 Ratio или не ratio?</h3>
<p>Прежде чем мы перейдём к расчёту размера выборки, важно обсудить одну характерную особенность метрики “доля успешных заказов”, очень важную с точки зрения статистического анализа.</p>
<p>Представьте себе три ситуации:</p>
<ol type="1">
<li>У нас есть 30 пользователей, которые сделали 1 заказ</li>
<li>У нас есть 1 пользователь, который сделал 30 заказов</li>
<li>У нас есть 5 пользователей, которые сделали 6 заказов</li>
</ol>
<p>Задача – понять предпочтения пользователей нашего продукта. Являются ли эти три варианта одинаковыми с этой точки зрения? Подумайте про себя, после чего читайте дальше.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>Конечно же, нет. Если нас интересуют не конкретные пользователи, а в целом пользователи нашего продукта (<em>генеральная совокупность, ГС</em>), то первый вариант будет отражать картину гораздо точнее. Проблема остальных вариантов будет в том, что у каждого пользователя будут какие-то свои предпочтения<a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a> – и это отразится на заказах, которые будут в чём-то похожи друг на друга. Возможно, у них будет похожая стоимость, или похожее содержимое, или похожая вероятность их отмены – заказы каждого отдельного пользователя будут коррелировать между собой. Иначе говоря, нарушится одно из важных условий большинства статистических тестов – <strong>независимость наблюдений</strong>.</p>
<div class="no-row-height column-margin column-container"><div id="fn10"><p><sup>10</sup>&nbsp;Соответственно, ситуация не будет проблематичной, если у нас все пользователи ведут себя одинаково. В большинстве случаев это нереалистичное допущение.</p></div></div><div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Неформальное определение
</div>
</div>
<div class="callout-body-container callout-body">
<p><em>Независимость наблюдений (independence of observations)</em> – ситуация, когда отдельные наблюдения ничего не говорят друг о друге (не коррелируют между собой). Является важным условием применимости статистических тестов.</p>
</div>
</div>
<p>Сама по себе такая ситуация абсолютно нормальная и даже ожидаемая, но требует специального учёта при анализе данных. Конкретно наш случай довольно характерен для аналитики и имеет своё название – <strong>метрика-отношение</strong><a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn11"><p><sup>11</sup>&nbsp;На Хабре есть несколько статей, посвящённых вопросу: <a href="https://habr.com/ru/companies/X5Tech/articles/740476/">раз</a>, <a href="https://habr.com/ru/companies/ozontech/articles/712306/">два</a>, <a href="https://habr.com/ru/companies/kuper/articles/768826/">три</a>.</p></div></div><div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Неформальное определение
</div>
</div>
<div class="callout-body-container callout-body">
<p><em>Метрика-отношение (ratio metric)</em> – метрика, являющая отношением двух других метрик. Например, средний чек является отношением выручки и числа заказов, а CTR является отношением числа кликов на рекламные баннеры к числу просмотров рекламных баннеров.</p>
</div>
</div>
<p>В принципе, практически любая метрика может быть выражена как метрика-отношение. Например, достаточно распространённая в бизнесе метрика конверсии (в разных её вариантах) является вот таким отношением:</p>
<p><span class="math display">\[
\frac{\text{число целевых действий}}{\text{число пользователей}}
\]</span></p>
<p>Рассмотрим такую штуку как конверсия в покупку. У нас есть какое-то количество новых посетителей сайта, которые могут приобрести товар, а могут не приобрести (это и есть целевое действие). Соответственно, конверсия в покупку – это число приобретений товаров/число посетителей сайта.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Обратите внимание
</div>
</div>
<div class="callout-body-container callout-body">
<p>В конверсии числитель всегда меньше либо равен знаменателю – соответственно, она принимает значения от 0 до 1. Учитывается <strong>только первый раз</strong>, когда происходит целевое событие – в этом заключается отличие между конверсией в покупку и числом заказов на пользователя.</p>
</div>
</div>
<p>Однако конверсия как метрика-отношение обладает важным свойством: <strong>дисперсией у неё обладает только числитель</strong>. Число пользователей у нас всегда фиксировано, как и число попыток на пользователя: варьируется только число целевых действий. Проблемы начинаются тогда, когда <strong>дисперсией обладают и числитель, и знаменатель</strong>.</p>
<p>Давайте ещё раз взглянем на нашу метрику “доля успешных заказов”:</p>
<p><span class="math display">\[
\frac{\text{число успешных заказов}}{\text{число всех заказов}}
\]</span></p>
<p>Каждый пользователь может сделать 1, 2, 3 или больше заказов за свою жизнь – соответственно, число заказов будет варьировать между пользователями и обладать дисперсией. Число успешных заказов тоже будет варьировать между пользователями – и дисперсия этой метрики будет отличаться от дисперсии общего числа заказов<a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a>. Если специально не учитывать это при анализе, то у нас могут быть серьёзные проблемы.</p>
<div class="no-row-height column-margin column-container"><div id="fn12"><p><sup>12</sup>&nbsp;Однако между дисперсией числителя и знаменателя вполне может быть корреляция, что и эксплуатируется разными продвинутыми методами анализа таких метрик.</p></div></div><p>Есть ли такая проблема у нас? Давайте посмотрим, сколько заказов у нас приходится на одного пользователя:</p>
<div class="cell">
<details class="code-fold">
<summary>Общие метрики на пользователя</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_orders =</span> <span class="fu">n</span>(), </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">total_successes =</span> <span class="fu">sum</span>(success), </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">.by =</span> customer_unique_id) <span class="sc">%&gt;%</span> </span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ratio =</span> total_successes <span class="sc">/</span> total_orders) <span class="ot">-&gt;</span> user_metrics</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>user_metrics <span class="sc">%&gt;%</span> </span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(total_orders) <span class="sc">%&gt;%</span> </span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">perc =</span> formattable<span class="sc">::</span><span class="fu">percent</span>(n <span class="sc">/</span> <span class="fu">sum</span>(n), <span class="at">digits =</span> <span class="dv">3</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Количество заказов"</span>, <span class="st">"Частота"</span>, <span class="st">"Процент"</span>), <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_material</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>, </span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>                 <span class="at">font_size =</span> <span class="dv">16</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class=" lightable-material" style="font-size: 16px; font-family: &quot;Source Sans Pro&quot;, helvetica, sans-serif; width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:center;"> Количество заказов </th>
   <th style="text-align:center;"> Частота </th>
   <th style="text-align:center;"> Процент </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:center;"> 1 </td>
   <td style="text-align:center;"> 93099 </td>
   <td style="text-align:center;"> 96.881% </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 2 </td>
   <td style="text-align:center;"> 2745 </td>
   <td style="text-align:center;"> 2.857% </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 3 </td>
   <td style="text-align:center;"> 203 </td>
   <td style="text-align:center;"> 0.211% </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 4 </td>
   <td style="text-align:center;"> 30 </td>
   <td style="text-align:center;"> 0.031% </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 5 </td>
   <td style="text-align:center;"> 8 </td>
   <td style="text-align:center;"> 0.008% </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 6 </td>
   <td style="text-align:center;"> 6 </td>
   <td style="text-align:center;"> 0.006% </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 7 </td>
   <td style="text-align:center;"> 3 </td>
   <td style="text-align:center;"> 0.003% </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 9 </td>
   <td style="text-align:center;"> 1 </td>
   <td style="text-align:center;"> 0.001% </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 17 </td>
   <td style="text-align:center;"> 1 </td>
   <td style="text-align:center;"> 0.001% </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>Хорошо видно, что примерно 97% пользователей сделало всего один заказ за всё время существования маркетплейса. Примерно 3% пользователей сделали два заказа, а пользователи с б<strong>о</strong>льшим числом заказов составляют меньше процента от всей выборки.</p>
<p>Перед нами встаёт противоречие:</p>
<ol type="1">
<li>У нас есть пользователи с числом заказов &gt;1, что делает наш показатель метрикой-отношением в её проблематичной форме (у знаменателя есть своя дисперсия).</li>
<li>Однако таких пользователей очень мало, и по большей части наша метрика ведёт себя как конверсия.</li>
</ol>
<p>Скажется ли это на качестве оценки размера выборки? Валидно ли анализировать эти данные как конверсию или всё-таки не стоит? Об этом читайте дальше.</p>
</section>
</section>
<section id="размер-выборки-по-формулам" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="размер-выборки-по-формулам">2. Размер выборки по формулам</h2>
<p>Настало время перейти к теме самой работы – к расчёту размера выборки! Для начала попробуем подойти к проблеме “простым путём”, а именно посчитать размер выборки с использованием готовых формул. В этом нам поможет пакет <code>pwr</code><a href="#fn13" class="footnote-ref" id="fnref13" role="doc-noteref"><sup>13</sup></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn13"><p><sup>13</sup>&nbsp;<a href="https://cran.r-project.org/web/packages/pwr/">Документация</a></p></div></div><p>Но прежде чем мы пойдём дальше, время выдать гору важных определений, которые нам пригодятся для понимания ситуации.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Единица анализа (Analysis Unit)
</div>
</div>
<div class="callout-body-container callout-body">
<p>Сущность, относительно который считается и анализируется метрика. Например, число заказов можно посчитать на пользователя, а можно посчитать на единицу времени (например, месяц) – единицей анализа в таком случае будут пользователи и месяца соответственно.</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Единица рандомизации (Randomization Unit)
</div>
</div>
<div class="callout-body-container callout-body">
<p>Сущность, которая в процессе эксперимента (A/B-теста) случайным образом распределяется по контрольным и экспериментальным группам. Чаще всего такой единицей являются пользователи (часть пользователей попадает в контроль, часть в тест) – однако рандомизация может быть и по другой единице.</p>
<p>Продолжая пример из прошлой заметки – если бы мы случайным образом в некоторые месяца помещали всех пользователей в тестовую группу, а в другие месяца – в контрольную группу, то единицей рандомизации был бы месяц<a href="#fn14" class="footnote-ref" id="fnref14" role="doc-noteref"><sup>14</sup></a>.</p>
<p>Если единица анализа и единица рандомизации совпадают, то мы можем гарантировать независимость наблюдений.</p>
</div>
</div>
<div class="no-row-height column-margin column-container"><div id="fn14"><p><sup>14</sup>&nbsp;Скорее всего, это будет очень плохой и неудобный A/B-тест, но теоретически это возможно.</p></div></div><div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Ошибка I рода (Type I Error)
</div>
</div>
<div class="callout-body-container callout-body">
<p>Статистическая ошибка, при которой мы отвергаем нулевую гипотезу, хотя она верна – иными словами, получаем <em>ложноположительный</em> результат.</p>
<p>Когда вы диагностируете абсолютно здоровому пациенту рак, вы допускаете похожую ошибку; когда вы считаете нововведение эффективным, хотя оно бесполезно – тоже.</p>
<p>Вероятность ошибки I рода обозначается буквой <span class="math inline">\(\alpha\)</span>.</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Частота ложноположительных результатов (False Positive Rate, FPR)
</div>
</div>
<div class="callout-body-container callout-body">
<p>Фактическая оценка того, какая доля экспериментов в итоге оказывается ложноположительной.</p>
<p>В идеале с увеличением числа экспериментов FPR должна приближаться к значению <span class="math inline">\(\alpha\)</span>, но как и любая выборочная оценка, FPR может варьировать вокруг истинного значения <span class="math inline">\(\alpha\)</span>.</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Ошибка II рода (Type II Error)
</div>
</div>
<div class="callout-body-container callout-body">
<p>Статистическая ошибка, при которой мы не отвергаем нулевую гипотезу, хотя она ложна – иными словами, получаем <em>ложноотрицательный</em> результат.</p>
<p>Когда вы не замечаете у смертельно больного человека признаков заболевания, вы допускаете похожую ошибку; когда вы упускаете реально полезное нововведение для вашего бизнеса – тоже.</p>
<p>Вероятность ошибки II рода обозначается буквой <span class="math inline">\(\beta\)</span>.</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Мощность (Power)
</div>
</div>
<div class="callout-body-container callout-body">
<p>Способность отвернуть нулевую гипотезу, если она неверна – иначе говоря, получить <em>истинноположительный</em> результат. Ещё другими словами – способность обнаружить статистически значимый эффект нововведения.</p>
<p>По факту это ошибка II рода наоборот и считается как <span class="math inline">\(1 - \beta\)</span>.</p>
<p>Оценённую на основе множества экспериментов мощность можно назвать TPR (True Positive Rate), но обычно с этим не заморачиваются и просто называют это мощностью.</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Минимальный размер эффекта (Minimum Detectable Effect, MDE)
</div>
</div>
<div class="callout-body-container callout-body">
<p>Минимальное различие между группами, которое с определённой вероятностью (мощность) будет считаться статистически значимым для данного размера выборки и уровня значимости.</p>
<p>Обычно выбирается на основе исторических данных или в результате обсуждения с заинтересованными лицами (например, минимальный прирост выручки, при котором доходы с нововведения покроют убытки от его реализации).</p>
<p>В расчётах MDE важно учитывать не только величину различия, но и дисперсию метрики – чем “шумнее” показатель (выше дисперсия), тем сложнее будет обнаружить различие и тем больше должна быть выборка.</p>
</div>
</div>
<p>Наша задача – обнаружить потенциальное различие в доле успешных заказов величиной в 1%. Для этого нам стоит понять, какова вообще доля успешных заказов, а также какова их дисперсия.</p>
<p>Долю успешных заказов мы можем представить как число успешных заказов/число всех заказов, но в таком случае единицей анализа будет заказ. Так как мы планируем в качестве единицы рандомизации взять пользователей<a href="#fn15" class="footnote-ref" id="fnref15" role="doc-noteref"><sup>15</sup></a>, то это приведёт к потенциальной зависимости наблюдений и неточной оценке дисперсии метрики.</p>
<div class="no-row-height column-margin column-container"><div id="fn15"><p><sup>15</sup>&nbsp;Можно было бы делать рандомизацию по заказам, но этот случай мы рассматривать не будем.</p></div><div id="fn16"><p><sup>16</sup>&nbsp;Это простой, но на самом деле не очень хороший способ решения проблемы. Причины этого обсуждаются в статьях по метрикам-отношениям, указанных выше. Более корректный способ работы с такими метриками мы обсудим позже.</p></div></div><p>Поэтому дисперсию мы будем считать по метрике “доля успешных заказов на пользователя” – так как единица анализа и единица рандомизации в данном случае совпадают, то проблем с зависимостью наблюдений у нас не будет<a href="#fn16" class="footnote-ref" id="fnref16" role="doc-noteref"><sup>16</sup></a>. Дисперсию мы оценим двумя показателями – <strong>стандартным отклонением (standard deviation, SD)</strong> и <strong>медианным абсолютным отклонением (median absolute deviation, MAD)</strong>.</p>
<p>Показатель SD, скорее всего, в представлении не нуждается. MAD является аналогом SD, более устойчивым к выбросам, и считается по этой формуле:</p>
<p><span class="math display">\[
median(|X_i - \tilde{X}|) \cdot 1.4826
\]</span></p>
<p>Здесь:</p>
<ul>
<li><p><span class="math inline">\(X_i\)</span> – наблюдение <span class="math inline">\(i\)</span> из выборки <span class="math inline">\(X\)</span>.</p></li>
<li><p><span class="math inline">\(\tilde{X}\)</span> – мера центральной тенденции по выборке (в нашем случае медиана).</p></li>
<li><p><span class="math inline">\(1.4826\)</span> – константа; при её использовании значение MAD совпадёт с SD, если данные нормально распределены.</p></li>
</ul>
<p>Посмотрим, что у нас получилось:</p>
<div class="cell">
<details class="code-fold">
<summary>Матожидание и дисперсия по пользователям</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>user_metrics <span class="sc">%&gt;%</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_ratio =</span> <span class="fu">sum</span>(total_successes) <span class="sc">/</span> <span class="fu">sum</span>(total_orders), </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean =</span> <span class="fu">mean</span>(ratio), <span class="at">median =</span> <span class="fu">median</span>(ratio), </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd =</span> <span class="fu">sd</span>(ratio), <span class="at">mad =</span> <span class="fu">mad</span>(ratio)) <span class="sc">%&gt;%</span> </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="fu">c</span>(<span class="st">"Глобальная доля"</span>, </span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"Средняя доля на пользователя"</span>, </span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"Медианная доля на пользователя"</span>,</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"SD доли на пользователя"</span>, </span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"MAD доли на пользователя"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Показатель"</span>, </span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"Значение"</span>), </span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">align =</span> <span class="st">"c"</span>, <span class="at">digits =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_material</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>, </span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>                 <span class="at">font_size =</span> <span class="dv">16</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class=" lightable-material" style="font-size: 16px; font-family: &quot;Source Sans Pro&quot;, helvetica, sans-serif; width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:center;"> Показатель </th>
   <th style="text-align:center;"> Значение </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:center;"> Глобальная доля </td>
   <td style="text-align:center;"> 0.988 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> Средняя доля на пользователя </td>
   <td style="text-align:center;"> 0.988 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> Медианная доля на пользователя </td>
   <td style="text-align:center;"> 1.000 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> SD доли на пользователя </td>
   <td style="text-align:center;"> 0.108 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> MAD доли на пользователя </td>
   <td style="text-align:center;"> 0.000 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>Итого имеем следующее:</p>
<ul>
<li><p>Доля успешных заказов равна 98.8% – это число одинаково вне зависимости от того, считаем ли мы долю глобально по заказам или как среднюю долю на пользователя.</p></li>
<li><p>Медианная доля равна 100% – учитывая, что большая часть пользователей сделала всего 1 заказ, а доля успехов высока, то это ожидаемый результат.</p></li>
<li><p>MAD также близко к 0%, что объясняется этим же. SD намного шире.</p></li>
</ul>
<p>Для сравнения давайте также посмотрим на значение и дисперсию этой доли по месяцам. Сразу оговорюсь, что дисперсию по месяцам не стоит серьёзно рассматривать в расчётах мощности – так как статистический анализ мы будем делать по пользователям.</p>
<div class="cell">
<details class="code-fold">
<summary>Матожидание и дисперсия по месяцам</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>month_metrics <span class="sc">%&gt;%</span> </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean =</span> <span class="fu">mean</span>(ratio), <span class="at">median =</span> <span class="fu">median</span>(ratio), </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">std =</span> <span class="fu">sd</span>(ratio), <span class="at">mad =</span> <span class="fu">mad</span>(ratio)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="fu">c</span>(<span class="st">"Средняя доля по месяцам"</span>, </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"Медианная доля по месяцам"</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"SD доли по месяцам"</span>, </span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"MAD доли по месяцам"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Показатель"</span>, </span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"Значение"</span>), </span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">align =</span> <span class="st">"c"</span>, <span class="at">digits =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_material</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>, </span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>                 <span class="at">font_size =</span> <span class="dv">16</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class=" lightable-material" style="font-size: 16px; font-family: &quot;Source Sans Pro&quot;, helvetica, sans-serif; width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:center;"> Показатель </th>
   <th style="text-align:center;"> Значение </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:center;"> Средняя доля по месяцам </td>
   <td style="text-align:center;"> 0.888 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> Медианная доля по месяцам </td>
   <td style="text-align:center;"> 0.986 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> SD доли по месяцам </td>
   <td style="text-align:center;"> 0.276 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> MAD доли по месяцам </td>
   <td style="text-align:center;"> 0.007 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>Здесь видим следующее:</p>
<ul>
<li><p>Медианная доля по месяцам выше средней доли по месяцам – прямое следствие того, что у нас есть аномальные месяца с крайне низкой долей успешности заказа.</p></li>
<li><p>Это же отражается в SD и MAD. MAD показывает, что большую часть времени доля успешности практически не менялась между месяцами, в то время как SD явно чувствительно к аномальным месяцам, описанным выше.</p></li>
</ul>
<p>Теперь, когда мы всё это посчитали, время переходить к размерам выборок. Посчитаем их тремя разными способами и посмотрим, что из этого выйдет.</p>
<section id="sec-ref_bernoulli" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="sec-ref_bernoulli">2.1 Доля успехов как общая пропорция</h3>
<p>Давайте для начала забудем всё, что я наговорил выше про метрики-отношения и единицы рандомизации. Сделаем вид, что вероятность успешности каждого заказа не зависит от пользователя, а значит, заказы можно считать независимыми наблюдениями. Соответственно, в таком случае их можно было бы анализировать как конверсию – иначе говоря, как обычные пропорции.</p>
<p>В таком случае нам пригодится функция <code>pwr.2p.test()</code>. Она считает размер выборки для <a href="https://www.statisticshowto.com/probability-and-statistics/hypothesis-testing/z-test/">z-теста пропорций</a> и имеет следующие основные аргументы<a href="#fn17" class="footnote-ref" id="fnref17" role="doc-noteref"><sup>17</sup></a>:</p>
<div class="no-row-height column-margin column-container"><div id="fn17"><p><sup>17</sup>&nbsp;Большинство функций пакета <code>pwr</code> имеет похожую структуру, поэтому эти аргументы справедливы и для других расчётов мощности.</p></div></div><ul>
<li><p><code>h</code> – значение MDE в стандартизованном виде (с учётом дисперсии метрики).</p></li>
<li><p><code>n</code> – размер выборки в каждой из групп.</p></li>
<li><p><code>sig.level</code> – уровень значимости <span class="math inline">\(\alpha\)</span>.</p></li>
<li><p><code>power</code> – уровень мощности <span class="math inline">\(1-\beta\)</span>.</p></li>
</ul>
<p>Если мы укажем 3 аргумента, то функция посчитает четвёртый. Иными словами, чтобы получить необходимый размер выборки, нам нужно указать MDE, <span class="math inline">\(\alpha\)</span> и мощность. С последними двумя всё относительно просто, так как мы можем взять их общепринятые значения: <span class="math inline">\(\alpha = 0.05, 1 - \beta = 0.8\)</span>. Но как посчитать стандартизованный MDE?</p>
<p>Для этого нам пригодится функция <code>ES.h()</code> – ей нужно просто указать две сравниваемые пропорции, и она даст нам стандартизованный размер эффекта<a href="#fn18" class="footnote-ref" id="fnref18" role="doc-noteref"><sup>18</sup></a>. Возьмём 0.988 в качестве первой доли, а в качестве второй доли возьмём сначала 0.998 (увеличение на 1%), а затем 0.978 (уменьшение на 1%) – и сравним результаты<a href="#fn19" class="footnote-ref" id="fnref19" role="doc-noteref"><sup>19</sup></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn18"><p><sup>18</sup>&nbsp;Этот размер эффекта известен как <span class="math inline">\(h\)</span> Коэна, и о нём можно почитать <a href="https://en.wikipedia.org/wiki/Cohen%27s_h">тут</a>.</p></div><div id="fn19"><p><sup>19</sup>&nbsp;Отсчёт ведётся от первого аргумента – если первый аргумент будет больше второго, то число будет положительное, и наоборот. Это принципиально только для знака различия.</p></div></div><div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>prop_up <span class="ot">&lt;-</span> <span class="fu">ES.h</span>(<span class="at">p1 =</span> <span class="fl">0.998</span>, <span class="at">p2 =</span> <span class="fl">0.988</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>prop_down <span class="ot">&lt;-</span> <span class="fu">ES.h</span>(<span class="at">p1 =</span> <span class="fl">0.978</span>, <span class="at">p2 =</span> <span class="fl">0.988</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Размер эффекта при росте пропорции: {round(prop_up, 3)}</span><span class="sc">\n</span><span class="st"> </span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="st">            Размер эффекта при уменьшении пропорции: {round(prop_down, 3)}"</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Размер эффекта при росте пропорции: 0.13
 
Размер эффекта при уменьшении пропорции: -0.078</code></pre>
</div>
</div>
<p>Здесь у вас может возникнуть два вопроса:</p>
<ol type="1">
<li>Почему MDE отличается не только по знаку, но и по абсолютному значению? Различие в обоих случаях 1% ведь?</li>
<li>Где происходит учёт дисперсии? Мы ведь просто указали две пропорции, дисперсию метрики мы не считали?</li>
</ol>
<p>На оба эти вопроса есть один ответ – потому что мы предполагаем, что наша метрика подчиняется <a href="https://en.wikipedia.org/wiki/Bernoulli_distribution"><strong>распределению Бернулли</strong></a>. Выглядит оно так:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/bernoulli-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Это очень простое распределение с одним параметром <span class="math inline">\(p\)</span>, отвечающим за вероятность успеха<a href="#fn20" class="footnote-ref" id="fnref20" role="doc-noteref"><sup>20</sup></a>. Важное следствие из этого – от <span class="math inline">\(p\)</span> зависит как среднее, так и дисперсия. Если точнее, то среднее как раз равно <span class="math inline">\(p\)</span>, а дисперсия равна <span class="math inline">\(p \cdot (1-p)\)</span>. Соответственно, вероятность успеха связана с дисперсией следующим образом:</p>
<div class="no-row-height column-margin column-container"><div id="fn20"><p><sup>20</sup>&nbsp;Часто можно встретить упоминание параметра <span class="math inline">\(q\)</span> – вероятности неудачи – но это просто короткий способ написать <span class="math inline">\(1 - p\)</span>.</p></div></div><div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/bernoulli%20variance-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Фактически чем ближе вероятность успеха к 0 или 1 – тем ниже дисперсия метрики. В свою очередь, при близкой к 0.5 вероятности успеха дисперсия выходит на свой пик. Это и даёт ответ на наши два вопроса:</p>
<ol type="1">
<li>Дисперсия метрики с пропорцией успехов 0.978 выше, чем с пропорцией успехов 0.998. Поэтому и стандартизованный MDE меньше – относительно более высокой дисперсии различие в 1% проявляет себя гораздо слабее.</li>
<li>Нам не нужно дополнительно указывать дисперсию – она как бы “закодирована” в саму пропорцию.</li>
</ol>
<p>Из этого следует, что обнаружить улучшение метрики нам будет проще, чем её падение. Хорошей идеей в таком случае будет выбрать наихудший, консервативный вариант – что метрика станет хуже на 1%. Исходя из этого, посчитаем размер выборки:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>(prop_power <span class="ot">&lt;-</span> <span class="fu">pwr.2p.test</span>(<span class="at">h =</span> <span class="fu">ES.h</span>(<span class="at">p1 =</span> <span class="fl">0.978</span>, <span class="at">p2 =</span> <span class="fl">0.988</span>), </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>                          <span class="at">sig.level =</span> <span class="fl">0.05</span>, <span class="at">power =</span> <span class="fl">0.8</span>))</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
     Difference of proportion power calculation for binomial distribution (arcsine transformation) 

              h = 0.07821698
              n = 2565.87
      sig.level = 0.05
          power = 0.8
    alternative = two.sided

NOTE: same sample sizes</code></pre>
</div>
</div>
<p>Как видите, функция в целом вернула всё то, что мы подали ей на вход<a href="#fn21" class="footnote-ref" id="fnref21" role="doc-noteref"><sup>21</sup></a>. Однако среди прочего она ещё и вернула размер выборки <code>n</code> – при округлении вверх мы получим 2566 человек в каждой группе<a href="#fn22" class="footnote-ref" id="fnref22" role="doc-noteref"><sup>22</sup></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn21"><p><sup>21</sup>&nbsp;Про аргумент <code>alternative</code> мы поговорим ниже.</p></div><div id="fn22"><p><sup>22</sup>&nbsp;Обратите внимание на фразу <code>NOTE: same sample sizes</code>. Эти расчёты предполагают, что контрольная и тестовая группа имеют одинаковые размеры – в противном случае нам бы пригодилась функция <code>pwr.2p2n.test()</code>.</p></div></div><p>Если на получившемся объекте применить функцию <code>plot()</code>, то мы дополнительно получим график связи размера выборки и предполагаемой мощности:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(prop_power)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/prop%20power%20plot-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Здесь хорошо видно, что связь размера выборки и мощности не является линейной – чем больше выборка, тем меньший прирост мощности будет давать каждый новый пользователь<a href="#fn23" class="footnote-ref" id="fnref23" role="doc-noteref"><sup>23</sup></a>. Также видно, что мощность не опускается до 0 – нижний порог мощности у нас равен <span class="math inline">\(\alpha\)</span>.</p>
<div class="no-row-height column-margin column-container"><div id="fn23"><p><sup>23</sup>&nbsp;Именно поэтому на практике редко когда считают мощность, близкую к 100% – для неё потребуется намного больше людей, чем может показаться на первый взгляд.</p></div></div><p>Давайте посмотрим, какой мощности мы достигнем, если соберём по 2700 человек в каждой группе:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pwr.2p.test</span>(<span class="at">h =</span> <span class="fu">ES.h</span>(<span class="at">p1 =</span> <span class="fl">0.978</span>, <span class="at">p2 =</span> <span class="fl">0.988</span>), </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">sig.level =</span> <span class="fl">0.05</span>, <span class="at">n =</span> <span class="dv">2700</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
     Difference of proportion power calculation for binomial distribution (arcsine transformation) 

              h = 0.07821698
              n = 2700
      sig.level = 0.05
          power = 0.8196189
    alternative = two.sided

NOTE: same sample sizes</code></pre>
</div>
</div>
<p>Как видите, теперь функция посчитала значение для аргумента <code>power</code> – мы получили мощность в 82%.</p>
<p>Наконец, давайте обсудим ещё один аргумент функции, на который я изначально не обратил ваше внимание – <code>alternative</code>. По умолчанию он имеет значение <code>'two-sided'</code>, что соответствует двустороннему z-тесту, проверяющему как рост, так и уменьшение метрики. В данном случае функция предполагает, что у нас может быть как 0.988 в контроле и 0.978 в тесте, так и наоборот – 0.978 в контроле и 0.988 в тесте.</p>
<p>Если мы уверены, что в контроле точно будет 0.988 и хотим сконцентрироваться именно на поиске отрицательных изменений, то мы можем сделать односторонний вариант z-теста<a href="#fn24" class="footnote-ref" id="fnref24" role="doc-noteref"><sup>24</sup></a>. Для этого нам нужно всего лишь указать значение альтернативы как <code>'less'</code> или <code>'greater'</code> – в зависимости от ожидаемого направления эффекта.</p>
<div class="no-row-height column-margin column-container"><div id="fn24"><p><sup>24</sup>&nbsp;Если мы АБСОЛЮТНО уверены, что истинное значение доли успехов равно 0.988, то мы можем даже прибегнуть к одно<strong>выборочному</strong> z-тесту и считать выборку функцией <code>pwr.p.test()</code>. Однако это очень серьёзное допущение и может легко выстрелить нам в ногу.</p></div></div><div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pwr.2p.test</span>(<span class="at">h =</span> <span class="fu">ES.h</span>(<span class="at">p1 =</span> <span class="fl">0.978</span>, <span class="at">p2 =</span> <span class="fl">0.988</span>), </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">sig.level =</span> <span class="fl">0.05</span>, <span class="at">power =</span> <span class="fl">0.8</span>, <span class="at">alternative =</span> <span class="st">"less"</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
     Difference of proportion power calculation for binomial distribution (arcsine transformation) 

              h = -0.07821698
              n = 2021.139
      sig.level = 0.05
          power = 0.8
    alternative = less

NOTE: same sample sizes</code></pre>
</div>
</div>
<p>Выбор такой альтернативы уменьшил необходимый размер выборки до 2022. Поэтому если нам очень этого захочется, то мы можем использовать именно односторонний тест – однако при этом мы пожертвуем возможностью обнаружить значимое улучшение метрики.</p>
<p>Ну и напоминаю, что это всё базируется на довольно хрупком допущении о независимости заказов. Давайте перейдём к двум вариантам, когда мы так не считаем.</p>
</section>
<section id="доля-успехов-как-пропорция-на-пользователя" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="доля-успехов-как-пропорция-на-пользователя">2.2 Доля успехов как пропорция на пользователя</h3>
<p>Вернёмся к метрике “доля успешных заказов на пользователя”. Так как теперь наша метрика может принимать не только значения 0-1, но и в диапазоне между ними, то тестом пропорций мы тут не отделаемся – нам нужен t-тест для сравнения средних. В этом нам поможет функция <code>pwr.t.test()</code> с примерно тем же набором аргументов – однако аргумент для MDE в ней называется уже не <code>h</code>, а <code>d</code>.</p>
<p>Это потому, что теперь мы считаем уже совсем другой размер эффекта под названием <span class="math inline">\(d\)</span> Коэна. Формула у него такая:</p>
<p><span class="math display">\[
d = \frac{\bar{x}_1 - \bar{x}_2}{s}
\]</span></p>
<p>Здесь:</p>
<ul>
<li><p><span class="math inline">\(\bar{x}_1\)</span> и <span class="math inline">\(\bar{x}_2\)</span> – средние.</p></li>
<li><p><span class="math inline">\(s\)</span> – мера стандартного отклонения.</p></li>
</ul>
<p>Способы того, как правильно считать <span class="math inline">\(s\)</span>, разнятся в зависимости от дизайна эксперимента. Однако в типичной ситуации расчёта мощности для двух независимых экспериментальных групп используют просто стандартное отклонение на исторических данных<a href="#fn25" class="footnote-ref" id="fnref25" role="doc-noteref"><sup>25</sup></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn25"><p><sup>25</sup>&nbsp;Такой подход даёт размер эффекта, известный как <span class="math inline">\(\Delta\)</span> Гласса. О нём и других вариациях <span class="math inline">\(d\)</span> Коэна можно почитать <a href="https://www.tqmp.org/RegularArticles/vol14-4/p242/p242.pdf">тут</a>.</p></div></div><p>Ранее мы уже получили значение SD, равное 0.108. Однако для сравнения также попробуем посчитать размер эффекта для мер разброса, посчитанных на основе месяцев – так будет наглядно видно, насколько сильно дисперсия влияет на оценку размера выборки:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>low_var <span class="ot">&lt;-</span> <span class="fu">pwr.t.test</span>(<span class="at">d =</span> (<span class="fl">0.988</span> <span class="sc">-</span> <span class="fl">0.978</span>)<span class="sc">/</span> <span class="fl">0.007</span>, <span class="at">sig.level =</span> <span class="fl">0.05</span>, <span class="at">power =</span> <span class="fl">0.8</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>mid_var <span class="ot">&lt;-</span> <span class="fu">pwr.t.test</span>(<span class="at">d =</span> (<span class="fl">0.988</span> <span class="sc">-</span> <span class="fl">0.978</span>)<span class="sc">/</span> <span class="fl">0.108</span>, <span class="at">sig.level =</span> <span class="fl">0.05</span>, <span class="at">power =</span> <span class="fl">0.8</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>high_var <span class="ot">&lt;-</span> <span class="fu">pwr.t.test</span>(<span class="at">d =</span> (<span class="fl">0.988</span> <span class="sc">-</span> <span class="fl">0.978</span>)<span class="sc">/</span> <span class="fl">0.276</span>, <span class="at">sig.level =</span> <span class="fl">0.05</span>, <span class="at">power =</span> <span class="fl">0.8</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Размер выборки для sd=0.007: {ceiling(low_var$n)}</span><span class="sc">\n</span><span class="st"> </span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="st">            Размер выборки для sd=0.108: {ceiling(mid_var$n)}</span><span class="sc">\n</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="st">            Размер выборки для sd=0.276: {ceiling(high_var$n)}"</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Размер выборки для sd=0.007: 9
 
Размер выборки для sd=0.108: 1832

Размер выборки для sd=0.276: 11959</code></pre>
</div>
</div>
<p>Можно видеть, что “правильное” значение размера выборки равно 1832, что примерно на 700 человек меньше, чем вышло в прошлых расчётах. Уменьшение <span class="math inline">\(s\)</span> до 0.007 (в 15.5 раз) привело к уменьшению размера выборки до 9 наблюдений (в 203.6 раз). В свою очередь, увеличение <span class="math inline">\(s\)</span> до 0.276 (в 2.6 раз) привело к увеличению размера выборки до 11959 наблюдений (в 6.5 раз). Как видите, размер выборки может очень серьёзно колебаться – с дисперсией не забалуешь.</p>
<p>Остался последний метод.</p>
</section>
<section id="доля-успехов-линеаризованная" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="доля-успехов-линеаризованная">2.3 Доля успехов линеаризованная</h3>
<p>В анализе метрик-отношений есть подход, который считается наиболее простым, элегантным и удобным, при этом являясь теоретически обоснованным<a href="#fn26" class="footnote-ref" id="fnref26" role="doc-noteref"><sup>26</sup></a>. Называется он <strong>линеаризацией</strong>, и при нём исходные показатели преобразуются следующим образом:</p>
<div class="no-row-height column-margin column-container"><div id="fn26"><p><sup>26</sup>&nbsp;Со всей математической подоплёкой метода можно ознакомиться <a href="https://www.researchgate.net/publication/322969314_Consistent_Transformation_of_Ratio_Metrics_for_Efficient_Online_Controlled_Experiments">тут</a>.</p></div></div><p><span class="math display">\[
L(X(u_i), Y(u_i)) = X(u_i) - R_{U_{ctrl}} \cdot Y(u_i)
\]</span></p>
<p>Здесь:</p>
<ul>
<li><p><span class="math inline">\(u_i\)</span> – пользователь <span class="math inline">\(i\)</span>.</p></li>
<li><p><span class="math inline">\(X(u_i)\)</span> и <span class="math inline">\(Y(u_i)\)</span> – значения числителя и знаменателя для пользователя <span class="math inline">\(i\)</span>.</p></li>
<li><p><span class="math inline">\(R_{U_{ctrl}}\)</span> – значение метрики-отношения в контрольной группе.</p></li>
</ul>
<p>Переведём на человеческий, используя наш пример. Глобальная доля успехов у нас равна 0.988, как мы посчитали выше – это как раз значение метрики-отношения в контрольной группе. Числитель у неё – число успешных заказов, знаменатель – число всех заказов.</p>
<p>Допустим, у нас есть пользователь с 2 заказами, из которых 1 успешен. Тогда его значение линеаризованной метрики будет таким:</p>
<p><span class="math display">\[
X(u_i) - R_{U_{ctrl}} \cdot Y(u_i) = 1 - 0.988 \cdot 2 = -0.976
\]</span></p>
<p>Знак полученной метрики показывает, в какую сторону доля пользователя отличается от глобальной доли; так как доля пользователя равна 0.5, то значение метрики отрицательное. В зависимости от размера числителя и знаменателя число будет больше или меньше по модулю – таким образом пользователи с б<strong>о</strong>льшим числом заказов будут иметь б<strong>о</strong>льший вес в подсчёте метрики.</p>
<p>Посчитаем её для наших данных:</p>
<div class="cell">
<details class="code-fold">
<summary>Расчёт линеаризованной метрики</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>user_metrics <span class="sc">%&gt;%</span> </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lin_metric =</span> total_successes <span class="sc">-</span> <span class="fl">0.988</span> <span class="sc">*</span> total_orders) <span class="ot">-&gt;</span> lin_data</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>lin_data <span class="sc">%&gt;%</span> </span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(customer_unique_id, total_orders, total_successes, lin_metric) <span class="sc">%&gt;%</span> </span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"ID покупателя"</span>, <span class="st">"Число всех заказов"</span>, </span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"Число успешных заказов"</span>, <span class="st">"Лин. метрика"</span>), </span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_material</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>, </span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>                 <span class="at">font_size =</span> <span class="dv">14</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class=" lightable-material" style="font-size: 14px; font-family: &quot;Source Sans Pro&quot;, helvetica, sans-serif; width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:center;"> ID покупателя </th>
   <th style="text-align:center;"> Число всех заказов </th>
   <th style="text-align:center;"> Число успешных заказов </th>
   <th style="text-align:center;"> Лин. метрика </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:center;"> 7c396fd4830fd04220f754e42b4e5bff </td>
   <td style="text-align:center;"> 2 </td>
   <td style="text-align:center;"> 2 </td>
   <td style="text-align:center;"> 0.024 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> af07308b275d755c9edb36a90c618231 </td>
   <td style="text-align:center;"> 1 </td>
   <td style="text-align:center;"> 1 </td>
   <td style="text-align:center;"> 0.012 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 3a653a41f6f9fc3d2a113cf8398680e8 </td>
   <td style="text-align:center;"> 1 </td>
   <td style="text-align:center;"> 1 </td>
   <td style="text-align:center;"> 0.012 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 7c142cf63193a1473d2e66489a9ae977 </td>
   <td style="text-align:center;"> 1 </td>
   <td style="text-align:center;"> 1 </td>
   <td style="text-align:center;"> 0.012 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 72632f0f9dd73dfee390c9b22eb56dd6 </td>
   <td style="text-align:center;"> 1 </td>
   <td style="text-align:center;"> 1 </td>
   <td style="text-align:center;"> 0.012 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 80bb27c7c16e8f973207a5086ab329e2 </td>
   <td style="text-align:center;"> 1 </td>
   <td style="text-align:center;"> 1 </td>
   <td style="text-align:center;"> 0.012 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>Можно посмотреть на то, какое среднее и стандартное отклонение у этой метрики:</p>
<div class="cell">
<details class="code-fold">
<summary>Матожидание и дисперсия линеаризованной метрики</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>user_metrics <span class="sc">%&gt;%</span> </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lin_metric =</span> total_successes <span class="sc">-</span> <span class="fl">0.988</span> <span class="sc">*</span> total_orders) <span class="ot">-&gt;</span> lin_data</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>user_metrics <span class="sc">%&gt;%</span> </span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lin_metric =</span> total_successes <span class="sc">-</span> <span class="fl">0.988</span> <span class="sc">*</span> total_orders) <span class="sc">%&gt;%</span> </span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean =</span> <span class="fu">mean</span>(lin_metric), <span class="at">std =</span> <span class="fu">sd</span>(lin_metric)) <span class="sc">%&gt;%</span> </span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Среднее"</span>, <span class="st">"SD"</span>), </span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">align =</span> <span class="st">"c"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_material</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>, </span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>                 <span class="at">font_size =</span> <span class="dv">14</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class=" lightable-material" style="font-size: 14px; font-family: &quot;Source Sans Pro&quot;, helvetica, sans-serif; width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:center;"> Среднее </th>
   <th style="text-align:center;"> SD </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:center;"> -0.0004236 </td>
   <td style="text-align:center;"> 0.113847 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>Полученную таким образом линеаризованную метрику можно спокойно помещать в t-тест и делать по ней выводы. Соответственно, и размер выборки по ней тоже можно считать. Однако в таком случае возникает вопрос: что именно нужно указать в качестве MDE?</p>
<p>В нашем курсе “<a href="https://karpov.courses/simulator-ab">Симулятор A/B-тестов</a>” рассказывают, что нам нужно величину различия поделить на среднее значение знаменателя – тогда получится различие в единицах линаризованной метрики. Соответственно, после этого нужно поделить результат на <span class="math inline">\(s\)</span> линеаризованной метрики – и мы получим наш <span class="math inline">\(d\)</span> Коэна<a href="#fn27" class="footnote-ref" id="fnref27" role="doc-noteref"><sup>27</sup></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn27"><p><sup>27</sup>&nbsp;На самом деле я не до конца уверен, что делаю это правильно. Если вы шарите за линеаризацию и я допустил ошибку в расчётах линеаризованного MDE – напишите мне!</p></div></div><div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">#делим MDE на среднее число заказов</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>lin_mde <span class="ot">&lt;-</span> <span class="fl">0.01</span> <span class="sc">/</span> <span class="fu">mean</span>(user_metrics<span class="sc">$</span>total_orders) </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"MDE линеаризованной метрики: {lin_mde}"</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MDE линеаризованной метрики: 0.00966361963375268</code></pre>
</div>
</div>
<p>Итого получаем:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pwr.t.test</span>(<span class="at">d =</span> (lin_mde)<span class="sc">/</span> <span class="fl">0.114</span>, <span class="at">sig.level =</span> <span class="fl">0.05</span>, <span class="at">power =</span> <span class="fl">0.8</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
     Two-sample t test power calculation 

              n = 2185.534
              d = 0.08476859
      sig.level = 0.05
          power = 0.8
    alternative = two.sided

NOTE: n is number in *each* group</code></pre>
</div>
</div>
<p>У нас получилось 2186 человек – больше, чем для средней доли на пользователя (1832), но меньше, чем для анализа глобальной доли как пропорции (2566). Вопрос: <strong>какое из этих трёх чисел в итоге правильное?</strong></p>
<p>И вот для ответа на этот вопрос нам и потребуются симуляции.</p>
</section>
</section>
<section id="симуляции-подготовка" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="симуляции-подготовка">3. Симуляции: подготовка</h2>
<p>Идея симуляционного подхода – в том, чтобы создать данные, идентичные натуральным. Чем больше похожа симуляция на реальную жизнь, тем более оправданно мы сможем судить по её результатам о реальной жизни.</p>
<p>Естественно, нам не нужно здесь пытаться воспроизводить реальный мир до единой детали. Всё, что нам нужно – это породить распределения данных, чьи характеристики будут похожи на реальность с точки зрения статистики. Для этого нам понадобятся три компонента:</p>
<ol type="1">
<li>Число заказов на пользователя – как много заказов делает каждый пользователь за период исследования и как часто встречается определённое число заказов?</li>
<li>Вероятность успеха на пользователя – насколько вероятно, что конкретный заказ конкретного пользователя не будет отменён?</li>
<li>Число успешных заказов на пользователя – какое количество заказов конкретного пользователя по итогу оказались успешными?<a href="#fn28" class="footnote-ref" id="fnref28" role="doc-noteref"><sup>28</sup></a></li>
</ol>
<div class="no-row-height column-margin column-container"><div id="fn28"><p><sup>28</sup>&nbsp;Обратите внимание, что этот показатель <span class="math inline">\(\neq\)</span> вероятность успеха на пользователя. Он является производным от числа заказов и вероятности успеха, тем самым внося дополнительный уровень случайности в данные.</p></div></div><p>Рассмотрим каждый из них отдельно.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Предупреждение
</div>
</div>
<div class="callout-body-container callout-body">
<p>Начиная с этого раздела, количество кода и его обсуждений начнёт расти. Будьте к этому готовы.</p>
</div>
</div>
<section id="число-заказов-на-пользователя" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="число-заказов-на-пользователя">3.1 Число заказов на пользователя</h3>
<p>Раньше мы уже выводили эту информацию в виде таблички, но полезно будет взглянуть на эти данные в формате столбиковой диаграммы.</p>
<div class="cell">
<details class="code-fold">
<summary>Рисуем:</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>user_metrics <span class="sc">%&gt;%</span> </span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> total_orders)) <span class="sc">+</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>() <span class="sc">+</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Число заказов"</span>, <span class="at">y =</span> <span class="st">"Количество"</span>, </span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Распределение числа заказов на пользователя"</span>) <span class="sc">+</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  see<span class="sc">::</span><span class="fu">theme_lucid</span>(<span class="at">axis.text.size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  title_theme</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/orders%20per%20user-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Стоит подчеркнуть несколько очевидных моментов об этом распределении – оно:</p>
<ul>
<li><p><em>Строго неотрицательное</em> – отрицательного числа заказов у человека быть не может.</p></li>
<li><p><em>Асимметричное</em> – как мы уже видели ранее, большая часть пользователей сделала всего один заказ, намного меньшая – 2 заказа, и есть длинный хвост пользователей с большим числом повторных заказов.</p></li>
<li><p><em>Дискретное</em>, то есть содержит в себе только целые числа. Пользователь не может сделать 2.278 заказа.</p></li>
</ul>
<p>Всё это напрочь дисквалифицирует нормальное распределение как возможную модель числа заказов. Но в таком случае какая модель будет адекватной? Здесь мы также попробуем три подхода – два из них предполагают конкретную модель, а третьему модель не нужна. С него и начнём.</p>
<section id="бутстрап-симуляции" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="бутстрап-симуляции">3.1.1 Бутстрап-симуляции</h4>
<p>Если вы когда-нибудь пытались решать задачки по теории вероятностей, то наверняка могли сталкиваться с задачами наподобие этой:</p>
<blockquote class="blockquote">
<p>В корзине лежат 5 шаров – 3 чёрных и 2 белых. Вы достаёте один шар, <strong>кладёте его обратно, тщательно перемешиваете шары</strong> и повторяете процедуру. Какова вероятность, что вы достанете чёрный и белый шар?</p>
</blockquote>
<p>Эту задачу решать необязательно<a href="#fn29" class="footnote-ref" id="fnref29" role="doc-noteref"><sup>29</sup></a> – главным образом обратите внимание на выделенную часть. Подобная процедура гарантирует, что при каждом новом взятии шара в корзине всё ещё остаётся 3 чёрных и 2 белых шара. Иными словами, каждое взятие шара является независимым, и вероятность взятия каждого типа шара остаётся той же.</p>
<div class="no-row-height column-margin column-container"><div id="fn29"><p><sup>29</sup>&nbsp;Но можете попробовать, она несложная :)</p></div></div><p>Такая процедура называется <strong>взятием выборки с повторениями (sampling with replacement)</strong>, и это идеализация того, как формируются выборки в экспериментах. В R её легко реализовать с помощью функции <code>sample()</code>, имеющей 3 основных аргумента:</p>
<ul>
<li><p><code>x</code> – генеральная совокупность, из которой мы берём выборку.</p></li>
<li><p><code>size</code> – размер выборки, которую мы берём.</p></li>
<li><p><code>replace</code> – берём ли мы наблюдения с повторениями (<code>TRUE</code>) или без повторений<a href="#fn30" class="footnote-ref" id="fnref30" role="doc-noteref"><sup>30</sup></a> (<code>FALSE</code>).</p></li>
</ul>
<div class="no-row-height column-margin column-container"><div id="fn30"><p><sup>30</sup>&nbsp;Это если бы мы достали шар, но не убирали его обратно перед взятием следующего. Само собой, в таком случае вероятность взятия каждого шара будет меняться.</p></div><div id="fn31"><p><sup>31</sup>&nbsp;Функция <code>set.seed()</code> задаёт начальное значение (“зерно”) генератора псевдослучайных чисел и гарантирует, что при выполнении того же кода с тем же “зерном” результат будет одинаковый. О том, как работает генерация псевдослучайных чисел в R, можно почитать <a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/Random.html">тут</a>.</p></div></div><p>Реализуем процедуру из задачи выше<a href="#fn31" class="footnote-ref" id="fnref31" role="doc-noteref"><sup>31</sup></a>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2112</span>) <span class="co">#чтобы результаты были одинаковые</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>balls <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"чёрный"</span>, <span class="st">"чёрный"</span>, <span class="st">"чёрный"</span>, <span class="st">"белый"</span>, <span class="st">"белый"</span>) <span class="co">#шары</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="fu">sample</span>(<span class="at">x =</span> balls, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "чёрный" "белый" </code></pre>
</div>
</div>
<p>В таком варианте функция предполагает, что у каждого из элементов вектора одинаковая вероятность попасть в выборку. Однако в случае, если это не так, мы можем задать ещё один аргумент – <code>prob</code>, в котором для каждого значения нужно указать вероятность его попадания в выборку.</p>
<p>Так как у нас всего 5 элементов, то вероятность взять чёрный шар равняется <span class="math inline">\(\frac{3}{5} = 0.6\)</span>, а вероятность взять белый – <span class="math inline">\(0.4\)</span>. Соответственно, мы можем выполнить эту же процедуру следующим образом<a href="#fn32" class="footnote-ref" id="fnref32" role="doc-noteref"><sup>32</sup></a>:</p>
<div class="no-row-height column-margin column-container"><div id="fn32"><p><sup>32</sup>&nbsp;Обратите внимание, что несмотря на то же “зерно”, результат кода другой – это потому, что изменился сам код. Статистически же эти два варианта кода идентичны.</p></div></div><div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2112</span>) <span class="co">#чтобы результаты были одинаковые</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>balls <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"чёрный"</span>,<span class="st">"белый"</span>) <span class="co">#шары</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="fu">sample</span>(<span class="at">x =</span> balls, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.6</span>, <span class="fl">0.4</span>))</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "белый"  "чёрный"</code></pre>
</div>
</div>
<p>На процедуре взятия выборки с повторениями основан важный статистический метод – <strong>бутстрап (bootstrap)</strong><a href="#fn33" class="footnote-ref" id="fnref33" role="doc-noteref"><sup>33</sup></a>. Фактически он основан на повторных симуляциях: мы берём нашу выборку в качестве генеральной совокупности<a href="#fn34" class="footnote-ref" id="fnref34" role="doc-noteref"><sup>34</sup></a>, генерируем из неё подвыборки с повторениями и для этих подвыборок считаем интересующий нас показатель.</p>
<div class="no-row-height column-margin column-container"><div id="fn33"><p><sup>33</sup>&nbsp;Более подробно с методом и его применением в статистике можно ознакомиться <a href="https://seeing-theory.brown.edu/frequentist-inference/index.html">тут</a>, <a href="https://habr.com/ru/companies/X5Tech/articles/679842/">тут</a> и <a href="https://arxiv.org/abs/1411.5279">тут</a>.</p></div><div id="fn34"><p><sup>34</sup>&nbsp;Естественно, чем меньше выборка похожа на генеральную совокупность – тем хуже метод. Поэтому считается, что точнее всего бутстрап работает на больших выборках, так как выше вероятность, что такая выборка будет отражать все нужные характеристики генеральной совокупности.</p></div></div><p>И вот это как раз и будет первым способом симуляции распределения заказов – просто возьмём нашу выборку и будем таскать из неё подвыборки с повторениями, как если бы это была генеральная совокупность. Дёшево и сердито.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2112</span>) <span class="co">#чтобы результаты были одинаковые</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>boot_orders <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="at">x =</span> user_metrics<span class="sc">$</span>total_orders, </span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">size =</span> <span class="fu">length</span>(user_metrics<span class="sc">$</span>total_orders), </span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">replace =</span> <span class="cn">TRUE</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>В результате мы получим вот такое распределение:</p>
<div class="cell">
<details class="code-fold">
<summary>Рисуем:</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_tibble</span>(boot_orders) <span class="sc">%&gt;%</span> </span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">value =</span> <span class="fu">factor</span>(value))<span class="sc">%&gt;%</span> </span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>() <span class="sc">+</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Число заказов"</span>, <span class="at">y =</span> <span class="st">"Количество"</span>, </span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Распределение числа заказов на пользователя</span><span class="sc">\n</span><span class="st">(бутстрап-симуляция)"</span>) <span class="sc">+</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  see<span class="sc">::</span><span class="fu">theme_lucid</span>(<span class="at">axis.text.size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  title_theme</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/sampled%20orders%20plot-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>И сравним его с оригиналом:</p>
<div class="cell">
<details class="code-fold">
<summary>Сравниваем:</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>user_metrics <span class="sc">%&gt;%</span> </span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> total_orders)) <span class="sc">+</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>() <span class="sc">+</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">""</span>, </span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Оригинал"</span>) <span class="sc">+</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  see<span class="sc">::</span><span class="fu">theme_lucid</span>(<span class="at">axis.text.size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  title_theme <span class="sc">+</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">18</span>)) <span class="ot">-&gt;</span> original</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="fu">as_tibble</span>(boot_orders) <span class="sc">%&gt;%</span> </span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">boot_orders =</span> <span class="fu">as.integer</span>(boot_orders)) <span class="sc">%&gt;%</span> </span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>() <span class="sc">+</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">""</span>, </span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Симуляция"</span>) <span class="sc">+</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>  see<span class="sc">::</span><span class="fu">theme_lucid</span>(<span class="at">axis.text.size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>  title_theme <span class="sc">+</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">18</span>)) <span class="ot">-&gt;</span> simulated</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>original <span class="sc">+</span> simulated</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/compare%20boot%20orders-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Ожидаемо, симуляция очень похожа на оригинал – хотя и не является идентичной (в частности, более редкие значения представлены здесь в меньшей степени). Значит, мы можем использовать это в качестве модели числа заказов на пользователя!</p>
<p>Однако прежде чем мы пойдём дальше, поговорим немного про скорость. Сейчас код работает так, что его скорость зависит от размера ГС – так как там 9000+ наблюдений, то процедура взятия подвыборки может оказаться медленной при множественных повторениях.</p>
<p>И вот именно здесь нам на помощь придёт аргумент <code>prob</code>! Помните табличку с числом заказов и вероятностью получить такое число заказов?</p>
<div class="cell">
<details class="code-fold">
<summary>Число заказов и их вероятность</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>user_metrics <span class="sc">%&gt;%</span> </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(total_orders) <span class="sc">%&gt;%</span> </span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="ot">-&gt;</span> prob_table </span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>prob_table <span class="sc">%&gt;%</span> </span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Количество заказов"</span>, <span class="st">"Доля"</span>), </span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">align =</span> <span class="st">"c"</span>, <span class="at">digits =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_material</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>, </span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">font_size =</span> <span class="dv">16</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class=" lightable-material" style="font-size: 16px; font-family: &quot;Source Sans Pro&quot;, helvetica, sans-serif; width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:center;"> Количество заказов </th>
   <th style="text-align:center;"> Доля </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:center;"> 1 </td>
   <td style="text-align:center;"> 0.969 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 2 </td>
   <td style="text-align:center;"> 0.029 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 3 </td>
   <td style="text-align:center;"> 0.002 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 4 </td>
   <td style="text-align:center;"> 0.000 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 5 </td>
   <td style="text-align:center;"> 0.000 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 6 </td>
   <td style="text-align:center;"> 0.000 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 7 </td>
   <td style="text-align:center;"> 0.000 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 9 </td>
   <td style="text-align:center;"> 0.000 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 17 </td>
   <td style="text-align:center;"> 0.000 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>Возьмём первую колонку в качестве генеральной совокупности, а вторую – в качестве вероятностей каждого её элемента, и мы получим тот же с точки зрения результатов, но более быстрый код:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>boot_orders <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="at">x =</span> prob_table<span class="sc">$</span>total_orders, </span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">size =</span> <span class="fu">length</span>(user_metrics<span class="sc">$</span>total_orders), </span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> prob_table<span class="sc">$</span>n)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Чтобы доказать, что этот код реально работает быстрее, используем пакет <code>microbenchmark</code> – с его помощью мы можем многократно запустить оба алгоритма и сравнить время выполнения.</p>
<div class="cell">
<details class="code-fold">
<summary>Сравниваем скорость кода</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>microbenchmark<span class="sc">::</span><span class="fu">microbenchmark</span>(<span class="at">full_sample =</span> <span class="fu">sample</span>(<span class="at">x =</span> user_metrics<span class="sc">$</span>total_orders, </span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>                                                    <span class="at">size =</span> <span class="dv">2700</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>), </span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>                               <span class="at">prob_sample =</span> <span class="fu">sample</span>(<span class="at">x =</span> prob_table<span class="sc">$</span>total_orders, </span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>                                                    <span class="at">size =</span> <span class="dv">2700</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>, </span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>                                                    <span class="at">prob =</span> prob_table<span class="sc">$</span>n), </span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>                               </span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>                               <span class="at">times =</span> <span class="dv">1000</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
        expr   min    lq     mean median    uq   max neval cld
 full_sample 178.6 184.7 188.4247  187.3 190.3 252.4  1000  a 
 prob_sample  23.8  24.6  26.0244   25.2  26.3  47.2  1000   b</code></pre>
</div>
</div>
<p>В целом табличка говорит сама за себя, однако пару моментов проговорю:</p>
<ul>
<li><p><em>full_sample</em> – это алгоритм без аргумента <code>prob</code>, <em>prob_sample</em> – с ним.</p></li>
<li><p><em>lq</em> и <em>hq</em> – это 25% и 75% квантили распределения.</p></li>
<li><p><em>neval</em> – число повторений (каждую функцию мы запустили 1000 раз).</p></li>
<li><p><em>cld</em> – так называемый Compact Letter Display, взятый из пакета <code>multcomp</code>. Разные буквы означают, что алгоритмы статистически значимо отличаются по своей скорости<a href="#fn35" class="footnote-ref" id="fnref35" role="doc-noteref"><sup>35</sup></a>.</p></li>
<li><p>Единицы измерения – микросекунды, как написано в верхней части отчёта. Может показаться, что это не такое уж большое отличие, однако при многократных повторениях кода эти микросекунды быстро превратятся в секунды, а там и в минуты, если не часы.</p></li>
</ul>
<div class="no-row-height column-margin column-container"><div id="fn35"><p><sup>35</sup>&nbsp;Чуть подробнее <a href="https://schmidtpaul.github.io/DSFAIR/compactletterdisplay.html">тут</a>.</p></div></div><p>С этим разобрались. Время попробовать конкретную модель данных.</p>
</section>
<section id="распределение-пуассона" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="распределение-пуассона">3.1.2 Распределение Пуассона</h4>
<p><a href="https://en.wikipedia.org/wiki/Poisson_distribution">Распределение Пуассона</a> – достаточно популярное распределение для моделирования дискретных, неотрицательных данных, прямо как у нас. Выглядит оно так:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/poisson-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Одна из причин популярности этого распределения – его простота: у него всего один параметр, <span class="math inline">\(\lambda\)</span>, являющийся одновременно средним и дисперсией. Как его оценить? Есть сложные способы, и есть простой.</p>
<p>Один из сложных способов – это оценить его с помощью <strong>обобщённой линейной модели (Generalized Linear Model, GLM)</strong><a href="#fn36" class="footnote-ref" id="fnref36" role="doc-noteref"><sup>36</sup></a>. Если классическая линейная регрессия предполагает нормальное распределение ошибок, то GLM позволяет заменить его на другое – и распределение Пуассона является одним из стандартных вариантов во многих статистических пакетах.</p>
<div class="no-row-height column-margin column-container"><div id="fn36"><p><sup>36</sup>&nbsp;У меня давным-давно был <a href="https://www.youtube.com/watch?v=1-ADJNE1WNc">вебинар</a> на тему, где я немного о них рассказывал.</p></div></div><p>Для этого воспользуемся стандартной функцией под говорящим названием <code>glm()</code>. Нам понадобятся три её аргумента:</p>
<ul>
<li><p><code>formula</code> – формула<a href="#fn37" class="footnote-ref" id="fnref37" role="doc-noteref"><sup>37</sup></a>, описывающая регрессионную модель, формата <code>зависимая_переменная ~ независимые_переменные</code>. В данном случае формула имеет вид <code>total_orders ~ 1</code>, где <code>total_orders</code> – название переменной с заказами на пользователя, <code>1</code> означает, что моделироваться будет только свободный член регрессии (фактически среднее зависимой переменной).</p></li>
<li><p><code>data</code> – набор данных, откуда берутся переменные.</p></li>
<li><p><code>family</code> – семейство распределений, которым мы будем моделировать (здесь указываем объект <code>poisson(),</code> который говорит сам за себя).</p></li>
</ul>
<div class="no-row-height column-margin column-container"><div id="fn37"><p><sup>37</sup>&nbsp;С формульным синтаксисом R можно ознакомиться <a href="https://www.econometrics.blog/post/the-r-formula-cheatsheet/">тут</a>.</p></div></div><p>Для полученной модели выведем её параметры с помощью функции <code>model_parameters()</code> из пакета <code>parameters</code> – их также можно видеть ниже:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glm</span>(<span class="at">formula =</span> total_orders <span class="sc">~</span> <span class="dv">1</span>, </span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> user_metrics, </span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="fu">poisson</span>()) <span class="ot">-&gt;</span> pois_model</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>pois_model <span class="sc">%&gt;%</span> </span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  parameters<span class="sc">::</span><span class="fu">model_parameters</span>()</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Profiled confidence intervals may take longer time to compute.
  Use `ci_method="wald"` for faster computation of CIs.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Parameter   | Log-Mean |       SE |       95% CI |     z |      p
-----------------------------------------------------------------
(Intercept) |     0.03 | 3.17e-03 | [0.03, 0.04] | 10.79 | &lt; .001</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Uncertainty intervals (profile-likelihood) and p-values (two-tailed)
  computed using a Wald z-distribution approximation.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
The model has a log- or logit-link. Consider using `exponentiate =
  TRUE` to interpret coefficients as ratios.</code></pre>
</div>
</div>
<p>Здесь много всякой информации, но нас в первую очередь интересует колонка под названием <em>Log-Mean</em>, где и указано оценённое значение параметра <span class="math inline">\(\lambda\)</span>. Как можно понять по её названию, сейчас оно представлено в логарифмической шкале. Чтобы перевести его в оригинальные единицы измерения, достаточно указать аргумент <code>exponentiate = TRUE</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>pois_model <span class="sc">%&gt;%</span> </span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  parameters<span class="sc">::</span><span class="fu">model_parameters</span>(<span class="at">exponentiate =</span> <span class="cn">TRUE</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Parameter   |  IRR |       SE |       95% CI |     z |      p
-------------------------------------------------------------
(Intercept) | 1.03 | 3.28e-03 | [1.03, 1.04] | 10.79 | &lt; .001</code></pre>
</div>
</div>
<p>1.03 – это и есть значение параметра <span class="math inline">\(\lambda\)</span><a href="#fn38" class="footnote-ref" id="fnref38" role="doc-noteref"><sup>38</sup></a>. На самом деле мы могли бы не мучиться со всем этим, а просто взять и посчитать среднее значение числа заказов:</p>
<div class="no-row-height column-margin column-container"><div id="fn38"><p><sup>38</sup>&nbsp;Обратите внимание, что теперь колонка называется <em>IRR</em> – <em>Incidence Rate Ratio</em>. Это название имело бы больше смысла в полноценной регрессионной модели, так как в таком случае мы бы наблюдали увеличение/уменьшение в некоторое число раз относительно среднего.</p></div></div><div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(user_metrics<span class="sc">$</span>total_orders) <span class="sc">%&gt;%</span> <span class="fu">round</span>(<span class="dv">2</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.03</code></pre>
</div>
</div>
<p>Как видите, результаты совпадают! Но это прокатило только с этой моделью – с другими распределениями ситуация может быть гораздо сложнее, как мы скоро увидим.</p>
<p>Итак, 1.03. Как же выглядит такое распределение?</p>
<div class="cell">
<details class="code-fold">
<summary>Рисуем:</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2112</span>) <span class="co">#чтобы результаты были одинаковые</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rpois</span>(<span class="at">n =</span> <span class="fu">length</span>(user_metrics<span class="sc">$</span>total_orders), </span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">lambda =</span> <span class="fl">1.03</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">value =</span> <span class="fu">factor</span>(value)) <span class="sc">%&gt;%</span> </span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>() <span class="sc">+</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Число заказов"</span>, <span class="at">y =</span> <span class="st">"Количество"</span>, </span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Распределение числа заказов на пользователя</span><span class="sc">\n</span><span class="st">(Пуассон)"</span>) <span class="sc">+</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>  see<span class="sc">::</span><span class="fu">theme_lucid</span>(<span class="at">axis.text.size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>  title_theme</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/sim%20poisson-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Ой-ой. Давайте сравним с реальными данными:</p>
<div class="cell">
<details class="code-fold">
<summary>Сравниваем:</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2112</span>) <span class="co">#чтобы результаты были одинаковые</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rpois</span>(<span class="at">n =</span> <span class="fu">length</span>(user_metrics<span class="sc">$</span>total_orders), </span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">lambda =</span> <span class="fl">1.03</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>() <span class="sc">+</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">""</span>, </span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Симуляция"</span>) <span class="sc">+</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>  see<span class="sc">::</span><span class="fu">theme_lucid</span>(<span class="at">axis.text.size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>  title_theme <span class="sc">+</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">18</span>)) <span class="ot">-&gt;</span> simulated</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>original <span class="sc">+</span> simulated</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/compare%20poisson%20orders-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Ой-ой (2). Похоже, распределение Пуассона не так хорошо описывает наши данные – и у этого есть два аспекта:</p>
<ol type="1">
<li>Распределение Пуассона начинается с нуля, в то время как наши данные начинаются с 1.</li>
<li>Дисперсия распределения Пуассона намного выше, чем у наших данных – если у нас распределение явно сконцентрировано в районе 1, то распределение Пуассона идёт на спад гораздо более плавно.</li>
</ol>
<p>Что мы будем с этим делать? Рассмотрим обе проблемы по очереди.</p>
<section id="лишние-нули" class="level5 page-columns page-full">
<h5 class="anchored" data-anchor-id="лишние-нули">3.1.2.1 Лишние нули</h5>
<p>Отсутствие нулей в наших данных вполне закономерно: у нас есть информация лишь о тех пользователях, которые сделали хотя бы один заказ<a href="#fn39" class="footnote-ref" id="fnref39" role="doc-noteref"><sup>39</sup></a>. К сожалению, так как этой информации у нас нет, то придётся с этими нулями что-то делать.</p>
<div class="no-row-height column-margin column-container"><div id="fn39"><p><sup>39</sup>&nbsp;Если бы у нас были нули, то очень возможно, что нам бы пригодились zero-inflated и hurdle модели. Подробнее о том, что это такое, можно почитать <a href="https://stats.oarc.ucla.edu/wp-content/uploads/2024/03/Zero_inf_2024_2.html">тут</a>.</p></div><div id="fn40"><p><sup>40</sup>&nbsp;Более серьёзным подходом было бы использование урезанных (truncated) распределений – оценить их параметры можно было бы, например, с помощью пакета <a href="https://cran.r-project.org/web/packages/gamlss.tr/index.html">gamlss.tr</a>. Но это ещё та крольичья нора, в которую я боюсь лезть – этот документ и так слишком большой.</p></div></div><p>Поступим мы просто: возьмём и выкинем нули из выборки<a href="#fn40" class="footnote-ref" id="fnref40" role="doc-noteref"><sup>40</sup></a>. Однако если сделать это просто так, то наша выборка станет меньше, и это скажется на оценке мощности. Соответственно, надо как-то этот факт скомпенсировать.</p>
<p>К счастью, есть функция <code>dpois()</code>. Она позволяет оценить вероятность получить конкретное значение в распределении с заданными параметрами. Соответственно, с помощью неё мы можем узнать вероятность 0 в нашем распределении Пуассона:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dpois</span>(<span class="at">x =</span> <span class="dv">0</span>, <span class="at">lambda =</span> <span class="fl">1.03</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.357007</code></pre>
</div>
</div>
<p>А если вычесть это из 1, то мы узнаем вероятность получить любое другое значение, кроме 0:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>(prob_nonzero_pois <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">dpois</span>(<span class="at">x =</span> <span class="dv">0</span>, <span class="at">lambda =</span> <span class="fl">1.03</span>))</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.642993</code></pre>
</div>
</div>
<p>И если мы поделим интересующий нас размер выборки на эту вероятность, то мы получим скорректированный размер выборки! В качестве размера выборки возьмём 2700:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="dv">2700</span> <span class="sc">/</span> prob_nonzero_pois)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4199</code></pre>
</div>
</div>
<p>Новый размер выборки – 4199. Если мы сгенерируем распределение Пуассона такого размера, а затем выкинем оттуда все нули, то получится <em>примерно</em> 2700 наблюдений. Ключевое слово “примерно” – в реальности число нулей будет варьировать, поэтому реальный размер выборки будет то меньше, то больше нужного. Давайте попробуем оценить, насколько.</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-40"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-40-1"><a href="#annotated-cell-40-1" aria-hidden="true" tabindex="-1"></a><span class="co">#функция</span></span>
<span id="annotated-cell-40-2"><a href="#annotated-cell-40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-40-3"><a href="#annotated-cell-40-3" aria-hidden="true" tabindex="-1"></a>diff_pois <span class="ot">&lt;-</span> <span class="cf">function</span>(full_size, expected_size, lambda){</span>
<span id="annotated-cell-40-4"><a href="#annotated-cell-40-4" aria-hidden="true" tabindex="-1"></a>  </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-40" data-target-annotation="1" onclick="event.preventDefault();" href="">1</a><span id="annotated-cell-40-5" class="code-annotation-target"><a href="#annotated-cell-40-5" aria-hidden="true" tabindex="-1"></a>  full_data <span class="ot">&lt;-</span> <span class="fu">rpois</span>(<span class="at">n =</span> full_size, <span class="at">lambda =</span> lambda)</span>
<span id="annotated-cell-40-6"><a href="#annotated-cell-40-6" aria-hidden="true" tabindex="-1"></a>  </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-40" data-target-annotation="2" onclick="event.preventDefault();" href="">2</a><span id="annotated-cell-40-7" class="code-annotation-target"><a href="#annotated-cell-40-7" aria-hidden="true" tabindex="-1"></a>  reduced_data <span class="ot">&lt;-</span> full_data[full_data <span class="sc">&gt;</span> <span class="dv">0</span>]</span>
<span id="annotated-cell-40-8"><a href="#annotated-cell-40-8" aria-hidden="true" tabindex="-1"></a>  </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-40" data-target-annotation="3" onclick="event.preventDefault();" href="">3</a><span id="annotated-cell-40-9" class="code-annotation-target"><a href="#annotated-cell-40-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">length</span>(reduced_data) <span class="sc">-</span> expected_size)</span>
<span id="annotated-cell-40-10"><a href="#annotated-cell-40-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-40-11"><a href="#annotated-cell-40-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="annotated-cell-40-12"><a href="#annotated-cell-40-12" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-40" data-target-annotation="4" onclick="event.preventDefault();" href="">4</a><span id="annotated-cell-40-13" class="code-annotation-target"><a href="#annotated-cell-40-13" aria-hidden="true" tabindex="-1"></a>all_diffs_pois <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(<span class="at">.x =</span> <span class="dv">1</span><span class="sc">:</span><span class="fl">1e6</span>,</span>
<span id="annotated-cell-40-14"><a href="#annotated-cell-40-14" aria-hidden="true" tabindex="-1"></a>                          <span class="at">.f =</span> \(x) <span class="fu">diff_pois</span>(<span class="at">full_size =</span> <span class="dv">4199</span>,</span>
<span id="annotated-cell-40-15"><a href="#annotated-cell-40-15" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">expected_size =</span> <span class="dv">2700</span>,</span>
<span id="annotated-cell-40-16"><a href="#annotated-cell-40-16" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">lambda =</span> <span class="fl">1.03</span>))</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-40" data-target-annotation="5" onclick="event.preventDefault();" href="">5</a><span id="annotated-cell-40-17" class="code-annotation-target"><a href="#annotated-cell-40-17" aria-hidden="true" tabindex="-1"></a><span class="fu">write_rds</span>(all_diffs_pois, <span class="st">"all_diffs_pois.rds"</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-40" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-40" data-code-lines="5" data-code-annotation="1">Генерируем распределение необходимого размера.</span>
</dd>
<dt data-target-cell="annotated-cell-40" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-40" data-code-lines="7" data-code-annotation="2">Выкидываем из него нули.</span>
</dd>
<dt data-target-cell="annotated-cell-40" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-40" data-code-lines="9" data-code-annotation="3">Считаем разницу между реальным и ожидаемым размером выборки.</span>
</dd>
<dt data-target-cell="annotated-cell-40" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-40" data-code-lines="13,14,15,16" data-code-annotation="4">Повторяем эту процедру миллион раз.</span>
</dd>
<dt data-target-cell="annotated-cell-40" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-40" data-code-lines="17" data-code-annotation="5">Сохраняем результат.</span>
</dd>
</dl>
</div>
</div>
<p>Думаю, стоит оговориться о том, что такое <code>map_dbl()</code>. Это функция из пакета <code>purrr</code>, и в этом случае она является более компактным и надёжным аналогом цикла <code>for</code>. У неё два основных аргумента:</p>
<ul>
<li><p><code>.x</code> – тот набор данных, по которому итерируется функция. Здесь она итерируется по набору чисел от 1 до 1_000_000 “вхолостую” – сами числа никак не идут на вход функции, это нужно лишь затем, чтобы она выполнилась миллион раз.</p></li>
<li><p><code>.f</code> – функция, которая исполняется в рамках <code>map_dbl()</code>.</p></li>
</ul>
<p>Ещё пара уточняющих вещей:</p>
<ul>
<li><p>Синтаксис вида <code>\(x) func(x)</code> – это так называемая анонимная функция. Питонистам должна быть знакома родственная конструкция <code>lambda x: func(x)</code>.</p></li>
<li><p>Приписка <code>_dbl</code> означает, что результатом функции гарантированно будет набор чисел. Если это условие не будет соблюдаться, то функция выдаст ошибку. Это сигнал разработчику, что его функция по каким-то причинам возвращает не числа, а что-то другое.</p></li>
</ul>
<p>Итого что у нас вышло?</p>
<div class="cell">
<details class="code-fold">
<summary>Рисуем:</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>all_diffs_pois <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"Data/all_diffs_pois.rds"</span>)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="fu">as_tibble</span>(all_diffs_pois) <span class="sc">%&gt;%</span> </span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>() <span class="sc">+</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Отклонение"</span>, <span class="at">y =</span> <span class="st">"n"</span>, </span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Распределение отклонений от ожидаемого размера</span><span class="sc">\n</span><span class="st">(2700)"</span>) <span class="sc">+</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>  see<span class="sc">::</span><span class="fu">theme_lucid</span>(<span class="at">axis.text.size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>  title_theme</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/poisson%20plot%20var-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>По всей видимости, стоит ожидать колебаний размера выборки примерно от 2600 до 2800. При этом распределение чуть смещено вправо: это значит, что в среднем выборка будет даже чуть больше того, что мы ожидаем (но не сильно).</p>
</section>
<section id="некорректная-дисперсия" class="level5">
<h5 class="anchored" data-anchor-id="некорректная-дисперсия">3.1.2.2 Некорректная дисперсия</h5>
<p>Как мы уже видели, разброс значений в распределении Пуассона оказался выше, чем в нашем реальном распределении. Просто так это не исправить: как я уже писал выше, параметр <span class="math inline">\(\lambda\)</span> является и средним, и дисперсией. Нельзя изменить одно, не изменив другое. Значит, нужно искать другое распределение.</p>
<p>Довольно распространённой альтернативой на практике является так называемое <a href="https://en.wikipedia.org/wiki/Negative_binomial_distribution"><strong>отрицательное биномиальное распределение</strong></a>. У него есть много вариаций, но одна из них является по сути надстройкой над распределением Пуассона: к параметру <span class="math inline">\(\lambda\)</span> добавляется параметр <span class="math inline">\(\theta\)</span>, позволяющий дополнительно модифицировать дисперсию распределения.</p>
<p>Однако есть проблема: этот метод работает только в том случае, если распределение Пуассона <em>недооценивает</em> дисперсию (меньше, чем в реальных данных). У нас же ситуация ровно обратная – дисперсия <em>переоценивается</em>. Если мы попробуем подобрать параметры распределения с помощью GLM, то <span class="math inline">\(\lambda\)</span> вычислится без проблем, а вот <span class="math inline">\(\theta\)</span> нормально не посчитается:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>MASS<span class="sc">::</span><span class="fu">glm.nb</span>(total_orders <span class="sc">~</span> <span class="dv">1</span>, </span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> user_metrics) <span class="sc">%&gt;%</span> </span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
MASS::glm.nb(formula = total_orders ~ 1, data = user_metrics, 
    init.theta = 397377.9116, link = log)

Coefficients:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept) 0.034217   0.003171   10.79   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for Negative Binomial(397377.9) family taken to be 1)

    Null deviance: 2951.8  on 96095  degrees of freedom
Residual deviance: 2951.8  on 96095  degrees of freedom
AIC: 197104

Number of Fisher Scoring iterations: 1

              Theta:  397378 
          Std. Err.:  442334 
Warning while fitting theta: iteration limit reached 

 2 x log-likelihood:  -197100 </code></pre>
</div>
</div>
<p>Обратите внимание на фразу <code>Warning while fitting theta: iteration limit reached</code>. Это предупреждение говорит о том, что параметр <span class="math inline">\(\theta\)</span> оценить не удалось. Соответственно, этот метод нам не поможет.</p>
<p>К счастью, в мире существует такое теоретическое распределение, которое позволяет нам решить эту проблему. И оно является третьим методом, который я планировал использовать.</p>
</section>
</section>
<section id="распределение-конвея-максвелла-пуассона" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="распределение-конвея-максвелла-пуассона">3.1.3 Распределение Конвея-Максвелла-Пуассона</h4>
<p><a href="https://en.wikipedia.org/wiki/Conway%E2%80%93Maxwell%E2%80%93Poisson_distribution">Это распределение</a> (далее для краткости я буду называть его CMP) уже гораздо хитрее предыдущих двух. Выглядит оно так:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/cmp-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>У него два параметра – <span class="math inline">\(\lambda\)</span> и <span class="math inline">\(\nu\)</span>. Однако не ведитесь на знакомые символы: эти два параметра связаны со средним и дисперсией не так прямолинейно, как может показаться.</p>
<p><span class="math display">\[
\text{Среднее} = \sum_{j=0}^{\infty}\frac{j\lambda^j}{(j!)^{\nu}Z(\lambda, \nu)}; \text{Дисперсия} = \sum_{j=0}^{\infty}\frac{j^2\lambda^j}{(j!)^{\nu}Z(\lambda, \nu)} - \text{Среднее}^2
\]</span></p>
<p>Я даже не буду пытаться это расшифровать. Человеку это вручную оценить не дано, а значит, дополнительных инструментов нам не избежать. К счастью, существует пакет <code>COMPoissonReg</code> с функцией <code>glm.cmp()</code>:<a href="#fn41" class="footnote-ref" id="fnref41" role="doc-noteref"><sup>41</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn41"><p><sup>41</sup>&nbsp;По сравнению с прошлыми моделями, эта штука считается в разы медленнее – 16-17 секунд. Поэтому я просто сохранил её результаты, чтобы не пересчитывать заново каждый раз.</p></div></div><div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>model_cmp <span class="ot">&lt;-</span> <span class="fu">glm.cmp</span>(<span class="at">formula.lambda =</span> total_orders <span class="sc">~</span> <span class="dv">1</span>, </span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>                     <span class="at">data =</span> user_metrics)</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="fu">write_rds</span>(model_cmp, <span class="st">"cmp_est.rds"</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Какие параметры нам она даст?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>model_cmp <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"Data/cmp_est.rds"</span>)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>model_cmp</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CMP coefficients
              Estimate     SE  z-value p-value
X:(Intercept)   5.8049 0.0601  96.6463       0
S:(Intercept)   2.5684 0.0069 371.2223       0
--
Transformed intercept-only parameters
       Estimate      SE
lambda 331.9074 19.9353
nu      13.0447  0.0903
--
Chi-squared test for equidispersion
X^2 = 162450.2606, df = 1, p-value = 0.0000e+00
--
Elapsed: 16.30 sec   Sample size: 96096   formula interface
LogLik: -17324.7168   AIC: 34653.4335   BIC: 34672.3797   
Optimization Method: L-BFGS-B   Converged status: 0
Message: CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH</code></pre>
</div>
</div>
<p>Функция очень любезно предоставляет нам параметры не только на лог-шкале, но и в оригинальных единицах измерения. 331.9074 – наша <span class="math inline">\(\lambda\)</span>, 13.0447 – наша <span class="math inline">\(\nu\)</span>. Как это выглядит?</p>
<div class="cell">
<details class="code-fold">
<summary>Рисуем:</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2112</span>) <span class="co">#чтобы результаты были одинаковые</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rcmp</span>(<span class="at">n =</span> <span class="fu">length</span>(user_metrics<span class="sc">$</span>total_orders), </span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">lambda =</span> <span class="fl">331.9074</span>, <span class="at">nu =</span> <span class="fl">13.0447</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">value =</span> <span class="fu">factor</span>(value)) <span class="sc">%&gt;%</span> </span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>() <span class="sc">+</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Число заказов"</span>, <span class="at">y =</span> <span class="st">"Количество"</span>, </span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Распределение числа заказов на пользователя</span><span class="sc">\n</span><span class="st">(CMP)"</span>) <span class="sc">+</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>  see<span class="sc">::</span><span class="fu">theme_lucid</span>(<span class="at">axis.text.size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>  title_theme</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/sim%20cmp-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>И в сравнении с оригиналом:</p>
<div class="cell">
<details class="code-fold">
<summary>Сравниваем:</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2112</span>) <span class="co">#чтобы результаты были одинаковые</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rcmp</span>(<span class="at">n =</span> <span class="fu">length</span>(user_metrics<span class="sc">$</span>total_orders), </span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">lambda =</span> <span class="fl">331.9074</span>, <span class="at">nu =</span> <span class="fl">13.0447</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>() <span class="sc">+</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">""</span>, </span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Симуляция"</span>) <span class="sc">+</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>  see<span class="sc">::</span><span class="fu">theme_lucid</span>(<span class="at">axis.text.size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>  title_theme <span class="sc">+</span></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">18</span>)) <span class="ot">-&gt;</span> simulated</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>original <span class="sc">+</span> simulated</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/compare%20cmp%20orders-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Этот результат намного лучше того, что было! Хотя он тоже неидеальный – теперь дисперсия будто бы даже меньше, чем была, с акцентом на 1 и 2 заказа. Впрочем, это довольно близко к тому, как выглядит большая часть нашей выборки, так что может, не всё так и плохо!</p>
<p>Дальше делаем то же самое, что и с Пуассоном – разберёмся с нулями, используя функцию <code>dcmp()</code>. Доля значений, не равных нулю, здесь намного выше:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>prob_nonzero_cmp <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">dcmp</span>(<span class="at">x =</span> <span class="dv">0</span>, </span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>                              <span class="at">lambda =</span> <span class="fl">331.9074</span>, </span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">nu =</span> <span class="fl">13.0447</span>)</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>prob_nonzero_cmp</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9971094</code></pre>
</div>
</div>
<p>И скорректированный размер выборки не сильно отличается от исходного:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="dv">2700</span> <span class="sc">/</span> prob_nonzero_cmp)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2708</code></pre>
</div>
</div>
<p>Сделаем аналогичную симуляцию отклонений:</p>
<div class="cell">
<details class="code-fold">
<summary>Код для CMP:</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>diff_cmp <span class="ot">&lt;-</span> <span class="cf">function</span>(x, full_size, expected_size, lambda, nu){</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>  full_data <span class="ot">&lt;-</span> <span class="fu">rcmp</span>(<span class="at">n =</span> full_size, <span class="at">lambda =</span> lambda, <span class="at">nu =</span> nu)</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>  reduced_data <span class="ot">&lt;-</span> full_data[full_data <span class="sc">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">length</span>(reduced_data) <span class="sc">-</span> expected_size)</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>all_diffs_cmp <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(<span class="at">.x =</span> <span class="dv">1</span><span class="sc">:</span><span class="fl">1e6</span>, </span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>                         <span class="at">.f =</span> \(x) <span class="fu">diff_cmp</span>(<span class="at">full_size =</span> <span class="dv">2708</span>, </span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>                          <span class="at">expected_size =</span> <span class="dv">2700</span>, <span class="at">lambda =</span> <span class="fl">331.9074</span>, </span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>                          <span class="at">nu =</span> <span class="fl">13.0447</span>))</span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a><span class="fu">write_rds</span>(all_diffs_cmp, <span class="st">"all_diffs_cmp.rds"</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>И получаем результат в <span class="math inline">\(\pm\)</span> 10 наблюдений – хотя это распределение уже не такое симметричное, как было с распределением Пуассона:</p>
<div class="cell">
<details class="code-fold">
<summary>Рисуем:</summary>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>all_diffs_cmp <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"Data/all_diffs_cmp.rds"</span>)</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="fu">as_tibble</span>(all_diffs_cmp) <span class="sc">%&gt;%</span> </span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">20</span>) <span class="sc">+</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Отклонение"</span>, <span class="at">y =</span> <span class="st">"n"</span>, </span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Распределение отклонений от ожидаемого размера</span><span class="sc">\n</span><span class="st">(2700)"</span>) <span class="sc">+</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>  see<span class="sc">::</span><span class="fu">theme_lucid</span>(<span class="at">axis.text.size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>  title_theme</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/cmp%20plot%20var-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Во время симуляций мы попробуем все три модели числа заказов, описанные выше, и сравним их. А пока переходим к следующему компоненту нашей симуляции.</p>
</section>
</section>
<section id="вероятность-успешного-заказа-на-пользователя" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="вероятность-успешного-заказа-на-пользователя">3.2 Вероятность успешного заказа на пользователя</h3>
<p>Теперь попробуем прикинуть, с какой вероятностью каждый пользователь делает успешный заказ! Посмотрим, как выглядит распределение доли успешных заказов на пользователя:</p>
<div class="cell">
<details class="code-fold">
<summary>Рисуем:</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>user_metrics <span class="sc">%&gt;%</span> </span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> ratio)) <span class="sc">+</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>() <span class="sc">+</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Доля успешных заказов"</span>, <span class="at">y =</span> <span class="st">"Количество"</span>, </span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Распределение доли успешных заказов на пользователя"</span>) <span class="sc">+</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>  see<span class="sc">::</span><span class="fu">theme_lucid</span>(<span class="at">axis.text.size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>  title_theme</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/ratio%20per%20user-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Виден огромный пик в районе 1, пик поменьше в районе 0 и совсем небольшой в районе 0.5. В целом ожидаемо, учитывая распределение числа заказов:</p>
<ol type="1">
<li>Если у пользователя всего один заказ, то его доля может быть либо 0, либо 1 – вне зависимости от реальной вероятности успеха<a href="#fn42" class="footnote-ref" id="fnref42" role="doc-noteref"><sup>42</sup></a>.</li>
<li>Если у пользователя два заказа, то доля может быть равна 0, 0.5 либо 1.</li>
</ol>
<div class="no-row-height column-margin column-container"><div id="fn42"><p><sup>42</sup>&nbsp;Само собой, чем ближе вероятность успеха к 1 – тем выше вероятность, что доля успехов на пользователя будет равна 1 (и наоборот). Здесь я говорю про возможный диапазон значений.</p></div></div><p>Давайте уберём все 0 и 1, а затем посмотрим, что останется:</p>
<div class="cell">
<details class="code-fold">
<summary>Рисуем:</summary>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>user_metrics <span class="sc">%&gt;%</span> </span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ratio <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> ratio <span class="sc">&lt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> ratio)) <span class="sc">+</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>() <span class="sc">+</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Доля успешных заказов"</span>, <span class="at">y =</span> <span class="st">"Количество"</span>, </span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Распределение доли успешных заказов на пользователя</span><span class="sc">\n</span><span class="st">между 0 и 1"</span>) <span class="sc">+</span></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>  see<span class="sc">::</span><span class="fu">theme_lucid</span>(<span class="at">axis.text.size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>  title_theme</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/ratio%20per%20user%20filt-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Пик в районе 0.5 – как раз то, чего стоило ожидать от пользователей с 2 заказами. Остальные доли, по всей видимости, у нас от пользователей с большим числом заказов. Какой вывод мы можем сделать?</p>
<p><strong>Эти данные нельзя использовать в качестве вероятностей успеха. Они слишком неточные.</strong></p>
<p>Если бы у нас были пользователи с десятками заказов, то мы могли бы получить более-менее точные оценки их вероятностей (пусть и с выраженными погрешностями) – достаточными по крайней мере для оценки примерной формы распределения. Здесь же всё настолько грубо, что мы скорее навредим себе, если попытаемся напрямую использовать эти данные.</p>
<p>Значит, нам придётся сделать серьёзное допущение и самостоятельно предположить вероятный вариант этого распределения. И в этом нам поможет <a href="https://en.wikipedia.org/wiki/Beta_distribution"><strong>бета-распределение</strong></a> – частый кандидат для распределений пропорций! Оно обладает следующими свойствами:</p>
<ul>
<li><p>Оно непрерывное – дробные значения принимать вполне может.</p></li>
<li><p>Диапазон значений – от 0 до 1 (обе границы невключительно). Это делает его отличным вариантом для моделирования пропорций<a href="#fn43" class="footnote-ref" id="fnref43" role="doc-noteref"><sup>43</sup></a>.</p></li>
<li><p>Имеет два параметра – <span class="math inline">\(\alpha\)</span> и <span class="math inline">\(\beta\)</span>. Первый смещает распределение в сторону 1, второй – в сторону 0; чем больше каждый из них, тем меньше дисперсия распределения.</p></li>
</ul>
<div class="no-row-height column-margin column-container"><div id="fn43"><p><sup>43</sup>&nbsp;В случае, когда у нас есть 0 и 1, можно использовать <a href="https://talks.andrewheiss.com/2024-04-25_ksu-bayes/examples/zoib.html">zero/one-inflated beta</a>. Но здесь мы с такими штуками возиться не будем.</p></div></div><p>Оно может принимать много разных форм – посмотрите на 4 примера ниже:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/beta-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Наша задача – подобрать такую форму распределения, чтобы оно более-менее согласовывалось с нашими данными. Беда в том, что среднее и дисперсия бета-распределения считаются вот так:</p>
<p><span class="math display">\[
\text{Среднее} = \frac{\alpha}{\alpha + \beta}; \text{Дисперсия} = \frac{\alpha\beta}{(\alpha + \beta)^2(\alpha + \beta + 1)}
\]</span></p>
<p>Как видите, просто так их тут не подобрать – нужно ещё догадаться, каким значениям <span class="math inline">\(\alpha\)</span> и <span class="math inline">\(\beta\)</span> это соответствует. Тот фокус, который мы сделали с CMP, тут тоже не прокатит – как я уже писал, доли на пользователя мы использовать не можем. Что делать?</p>
<p>К счастью, это не единственный вариант записи бета-распределения. Есть <a href="https://www.ime.usp.br/~sferrari/beta.pdf">альтернативная параметризация</a> как раз для удобного моделирования пропорций, имеющая следующие два параметра:</p>
<ul>
<li><p><span class="math inline">\(\mu\)</span> – среднее значение.</p></li>
<li><p><span class="math inline">\(\phi\)</span> – “точность” (precision). Фактически это дисперсия наоборот – чем выше <span class="math inline">\(\phi\)</span>, тем ниже дисперсия.</p></li>
</ul>
<p>Вот три примера с одинаковым средним, но разной точностью:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/beta%20alt-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Такое распределение есть в пакете <code>extraDistr</code>, и создаётся оно функцией <code>rprop()</code> с параметрами <code>mean</code> и <code>size</code> соответственно<a href="#fn44" class="footnote-ref" id="fnref44" role="doc-noteref"><sup>44</sup></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn44"><p><sup>44</sup>&nbsp;<code>mean</code> понятно, а почему <code>size</code>? Объяснение довольно забористое, тут лучше смотреть <a href="https://search.r-project.org/CRAN/refmans/extraDistr/html/PropBeta.html">документацию</a> функции – но там привязка к числу испытаний в биномиальном распределении. В R аргумент биномиального распределения, отвечающий за число испытаний, как раз и называется <code>size</code>.</p></div></div><p>Какими мы зададим эти параметры? С <code>mean</code> понятно – зададим его равным 0.988. А вот с <code>size</code> нам придётся просто взять то, что ближе к душе лежит. Я указал его равным 2 – и получившееся распределение выглядит так:</p>
<div class="cell">
<details class="code-fold">
<summary>Рисуем:</summary>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>ggfortify<span class="sc">::</span><span class="fu">ggdistribution</span>(<span class="at">func =</span> dprop, </span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>                          <span class="at">x =</span> x_vals, </span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">mean =</span> <span class="fl">0.988</span>, <span class="at">size =</span> <span class="dv">2</span>, </span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>                          <span class="at">xlab =</span> <span class="st">"Вероятность успеха"</span>, <span class="at">ylab =</span> <span class="st">"Плотность"</span>) <span class="sc">+</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>  see<span class="sc">::</span><span class="fu">theme_modern</span>() <span class="sc">+</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Распределение вероятностей успеха"</span>) <span class="sc">+</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>  title_theme</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/beta%20sim-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Как видите, основная масса распределения лежит как раз в районе 0.98-1.00, но при этом оно обладает довольно длинным хвостом в левую сторону – так как я не уверен, насколько высок разброс реальных вероятностей, то пусть он будет реально большим. Лучше недооценить мощность, чем указать слишком малую дисперсию и переоценить её.</p>
<p>Остался последний компонент симуляции.</p>
</section>
<section id="число-и-доля-успешных-доставок-на-пользователя" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="число-и-доля-успешных-доставок-на-пользователя">3.3 Число и доля успешных доставок на пользователя</h3>
<p>Число заказов для каждого пользователя у нас есть, вероятность успешного заказа тоже. Осталось превратить это в число успешных заказов – и, соответственно, в доли успешных доставок.</p>
<p>Здесь на арену выходит <a href="https://en.wikipedia.org/wiki/Binomial_distribution"><strong>биномиальное распределение</strong></a>…которое мы уже и так знаем. Распределение Бернулли, про которое мы говорили в секции <a href="#sec-ref_bernoulli">2.1 Доля успехов как общая пропорция</a>, является его вариантом, когда у нас всего одна попытка (и результатом может быть либо 0 успехов, либо 1 успех). При повторных попытках у нас и будет возникать биномиальное распределение.</p>
<p>Генерируется такое распределение функцией <code>rbinom()</code>, у которой (помимо размера выборки) два основных аргумента:</p>
<ul>
<li><p><code>prob</code> – вероятность успеха.</p></li>
<li><p><code>size</code> – число попыток.</p></li>
</ul>
<p>В нашем случае есть нюанс: так как у каждого пользователя число попыток (=число заказов) и вероятность успеха своя, то мы имеем дело не с одним биномиальным распределением, а смесью биномиальных распределений<a href="#fn45" class="footnote-ref" id="fnref45" role="doc-noteref"><sup>45</sup></a>. К счастью, функция <code>rbinom()</code> векторизована: если подать ей на вход наборы чисел попыток и вероятностей успеха, то она обработает каждую пару “число-вероятность” как отдельное распределение.</p>
<div class="no-row-height column-margin column-container"><div id="fn45"><p><sup>45</sup>&nbsp;По сути, у нас получился изощрённый вариант так называемого <a href="https://en.wikipedia.org/wiki/Beta-binomial_distribution">бета-биномиального распределения</a> – только в бета-биномиальном число попыток фиксировано, а у нас варьирует.</p></div></div><p>Итого имеем следующий код:</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-54"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><a class="code-annotation-anchor" data-target-cell="annotated-cell-54" data-target-annotation="1" onclick="event.preventDefault();" href="">1</a><span id="annotated-cell-54-1" class="code-annotation-target"><a href="#annotated-cell-54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2112</span>)</span>
<span id="annotated-cell-54-2"><a href="#annotated-cell-54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-54-3"><a href="#annotated-cell-54-3" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-54" data-target-annotation="2" onclick="event.preventDefault();" href="">2</a><span id="annotated-cell-54-4" class="code-annotation-target"><a href="#annotated-cell-54-4" aria-hidden="true" tabindex="-1"></a>res_orders <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="at">x =</span> prob_table<span class="sc">$</span>total_orders,</span>
<span id="annotated-cell-54-5"><a href="#annotated-cell-54-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">size =</span> <span class="fu">length</span>(user_metrics<span class="sc">$</span>total_orders),</span>
<span id="annotated-cell-54-6"><a href="#annotated-cell-54-6" aria-hidden="true" tabindex="-1"></a>                      <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> prob_table<span class="sc">$</span>n)</span>
<span id="annotated-cell-54-7"><a href="#annotated-cell-54-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-54-8"><a href="#annotated-cell-54-8" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-54" data-target-annotation="3" onclick="event.preventDefault();" href="">3</a><span id="annotated-cell-54-9" class="code-annotation-target"><a href="#annotated-cell-54-9" aria-hidden="true" tabindex="-1"></a>res_prob <span class="ot">&lt;-</span> <span class="fu">rprop</span>(<span class="at">n =</span> <span class="fu">length</span>(res_orders),</span>
<span id="annotated-cell-54-10"><a href="#annotated-cell-54-10" aria-hidden="true" tabindex="-1"></a>                     <span class="at">size =</span> <span class="dv">2</span>, <span class="at">mean =</span> <span class="fl">0.988</span>)</span>
<span id="annotated-cell-54-11"><a href="#annotated-cell-54-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-54-12"><a href="#annotated-cell-54-12" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-54" data-target-annotation="4" onclick="event.preventDefault();" href="">4</a><span id="annotated-cell-54-13" class="code-annotation-target"><a href="#annotated-cell-54-13" aria-hidden="true" tabindex="-1"></a>res_successes <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n =</span> <span class="fu">length</span>(res_orders),</span>
<span id="annotated-cell-54-14"><a href="#annotated-cell-54-14" aria-hidden="true" tabindex="-1"></a>                        <span class="at">size =</span> res_orders, <span class="at">prob =</span> res_prob)</span>
<span id="annotated-cell-54-15"><a href="#annotated-cell-54-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-54-16"><a href="#annotated-cell-54-16" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-54" data-target-annotation="5" onclick="event.preventDefault();" href="">5</a><span id="annotated-cell-54-17" class="code-annotation-target"><a href="#annotated-cell-54-17" aria-hidden="true" tabindex="-1"></a>res_proportion <span class="ot">&lt;-</span> res_successes <span class="sc">/</span> res_orders</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-54" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-54" data-code-lines="1" data-code-annotation="1">Фиксируем “зерно”, чтобы результаты были воспроизводимы</span>
</dd>
<dt data-target-cell="annotated-cell-54" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-54" data-code-lines="4,5,6" data-code-annotation="2">Генерируем число заказов на пользователя – в данном случае методом бутстрапа</span>
</dd>
<dt data-target-cell="annotated-cell-54" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-54" data-code-lines="9,10" data-code-annotation="3">Генерируем вероятность успеха на пользователя</span>
</dd>
<dt data-target-cell="annotated-cell-54" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-54" data-code-lines="13,14" data-code-annotation="4">Генерируем число успешных заказов на пользователя</span>
</dd>
<dt data-target-cell="annotated-cell-54" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-54" data-code-lines="17" data-code-annotation="5">Делим (2) на (4) – и получаем долю успешных заказов на пользователя</span>
</dd>
</dl>
</div>
</div>
<p>Соответственно, распределение долей успехов выглядит так:</p>
<div class="cell">
<details class="code-fold">
<summary>Рисуем:</summary>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>res_proportion <span class="sc">%&gt;%</span> </span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>() <span class="sc">+</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Доля успешных заказов"</span>, <span class="at">y =</span> <span class="st">"Количество"</span>, </span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Распределение доли успешных заказов на пользователя</span><span class="sc">\n</span><span class="st">(симуляция)"</span>) <span class="sc">+</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>  see<span class="sc">::</span><span class="fu">theme_lucid</span>(<span class="at">axis.text.size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>  title_theme</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/ratio%20per%20user%20sim-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>В целом похоже на то, что у нас есть в данных! Если убрать 0 и 1, то получим это:</p>
<div class="cell">
<details class="code-fold">
<summary>Рисуем:</summary>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>res_proportion <span class="sc">%&gt;%</span> </span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(value <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> value <span class="sc">&lt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>() <span class="sc">+</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Доля успешных заказов"</span>, <span class="at">y =</span> <span class="st">"Количество"</span>, </span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Распределение доли успешных заказов на пользователя</span><span class="sc">\n</span><span class="st">между 0 и 1 (симуляция)"</span>) <span class="sc">+</span></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>  see<span class="sc">::</span><span class="fu">theme_lucid</span>(<span class="at">axis.text.size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>  title_theme</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/ratio%20per%20user%20filt%20sim-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Имеем всё такой же пик в районе 0.5. Стоит заметить, что разброс долей тут меньше, так как редкие значения количества заказов (3+) могли не попасть в симуляцию. Но общую структуру данных мы сохранили!</p>
</section>
<section id="как-будем-действовать" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="как-будем-действовать">3.4 Как будем действовать</h3>
<p>Вот мы и получили модель наших данных!<a href="#fn46" class="footnote-ref" id="fnref46" role="doc-noteref"><sup>46</sup></a> Осталось обернуть её в функцию, которую мы затем будем использовать в наших экспериментах<a href="#fn47" class="footnote-ref" id="fnref47" role="doc-noteref"><sup>47</sup></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn46"><p><sup>46</sup>&nbsp;Эту модель можно назвать <em>генеративной</em> – так как она позволяет генерировать новые данные.</p></div><div id="fn47"><p><sup>47</sup>&nbsp;Ближе к концу мы её немного модифицируем, так как изменится интересующий нас вопрос.</p></div></div><p>У нас будет четыре основных аргумента:</p>
<ul>
<li><p><code>size</code> – размер выборки.</p></li>
<li><p><code>type</code> – тип модели для числа заказов. Есть варианты <code>'pois'</code> (Пуассон), <code>'cmp'</code> (CMP) и <code>'boot'</code> (бутстрап).</p></li>
<li><p><code>mean_prob</code> – средняя вероятность успеха.</p></li>
<li><p><code>template</code> – если вариант генерации <code>'boot'</code>, то здесь мы указываем данные, на основе которых и делается бутстрап.</p></li>
</ul>
<p>Сама функция будет работать так:</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-57"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-57-1"><a href="#annotated-cell-57-1" aria-hidden="true" tabindex="-1"></a>sim_buyer_data <span class="ot">&lt;-</span> <span class="cf">function</span>(size, type, mean_prob, template){</span>
<span id="annotated-cell-57-2"><a href="#annotated-cell-57-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-57-3"><a href="#annotated-cell-57-3" aria-hidden="true" tabindex="-1"></a>  </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-57" data-target-annotation="1" onclick="event.preventDefault();" href="">1</a><span id="annotated-cell-57-4" class="code-annotation-target"><a href="#annotated-cell-57-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"pois"</span>){</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-57" data-target-annotation="2" onclick="event.preventDefault();" href="">2</a><span id="annotated-cell-57-5" class="code-annotation-target"><a href="#annotated-cell-57-5" aria-hidden="true" tabindex="-1"></a>    orders <span class="ot">&lt;-</span> <span class="fu">rpois</span>(<span class="at">n =</span> <span class="fu">round</span>(size <span class="sc">/</span> <span class="fl">0.6447736</span>),</span>
<span id="annotated-cell-57-6"><a href="#annotated-cell-57-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">lambda =</span> <span class="fl">1.03</span>)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-57" data-target-annotation="3" onclick="event.preventDefault();" href="">3</a><span id="annotated-cell-57-7" class="code-annotation-target"><a href="#annotated-cell-57-7" aria-hidden="true" tabindex="-1"></a>    orders <span class="ot">&lt;-</span> orders[orders <span class="sc">&gt;</span> <span class="dv">0</span>]</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-57" data-target-annotation="4" onclick="event.preventDefault();" href="">4</a><span id="annotated-cell-57-8" class="code-annotation-target"><a href="#annotated-cell-57-8" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"cmp"</span>){</span>
<span id="annotated-cell-57-9"><a href="#annotated-cell-57-9" aria-hidden="true" tabindex="-1"></a>    orders <span class="ot">&lt;-</span> <span class="fu">rcmp</span>(<span class="at">n =</span> <span class="fu">round</span>(size <span class="sc">/</span> <span class="fl">0.9971094</span>),</span>
<span id="annotated-cell-57-10"><a href="#annotated-cell-57-10" aria-hidden="true" tabindex="-1"></a>                   <span class="at">lambda =</span> <span class="fl">331.9074</span>, <span class="at">nu =</span> <span class="fl">13.0447</span>)</span>
<span id="annotated-cell-57-11"><a href="#annotated-cell-57-11" aria-hidden="true" tabindex="-1"></a>    orders <span class="ot">&lt;-</span> orders[orders <span class="sc">&gt;</span> <span class="dv">0</span>]</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-57" data-target-annotation="5" onclick="event.preventDefault();" href="">5</a><span id="annotated-cell-57-12" class="code-annotation-target"><a href="#annotated-cell-57-12" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"boot"</span>){</span>
<span id="annotated-cell-57-13"><a href="#annotated-cell-57-13" aria-hidden="true" tabindex="-1"></a>    orders <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="at">x =</span> template<span class="sc">$</span>total_orders,</span>
<span id="annotated-cell-57-14"><a href="#annotated-cell-57-14" aria-hidden="true" tabindex="-1"></a>                     <span class="at">size =</span> size, <span class="at">replace =</span> <span class="cn">TRUE</span>,</span>
<span id="annotated-cell-57-15"><a href="#annotated-cell-57-15" aria-hidden="true" tabindex="-1"></a>                     <span class="at">prob =</span> template<span class="sc">$</span>n)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-57" data-target-annotation="6" onclick="event.preventDefault();" href="">6</a><span id="annotated-cell-57-16" class="code-annotation-target"><a href="#annotated-cell-57-16" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="fu">stop</span>(<span class="st">"unknown type"</span>)</span>
<span id="annotated-cell-57-17"><a href="#annotated-cell-57-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-57-18"><a href="#annotated-cell-57-18" aria-hidden="true" tabindex="-1"></a>  </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-57" data-target-annotation="7" onclick="event.preventDefault();" href="">7</a><span id="annotated-cell-57-19" class="code-annotation-target"><a href="#annotated-cell-57-19" aria-hidden="true" tabindex="-1"></a>  succ_prob <span class="ot">&lt;-</span> <span class="fu">rprop</span>(<span class="at">n =</span> <span class="fu">length</span>(orders),</span>
<span id="annotated-cell-57-20"><a href="#annotated-cell-57-20" aria-hidden="true" tabindex="-1"></a>                     <span class="at">size =</span> <span class="dv">2</span>, <span class="at">mean =</span> mean_prob)</span>
<span id="annotated-cell-57-21"><a href="#annotated-cell-57-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-57-22"><a href="#annotated-cell-57-22" aria-hidden="true" tabindex="-1"></a>  </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-57" data-target-annotation="8" onclick="event.preventDefault();" href="">8</a><span id="annotated-cell-57-23" class="code-annotation-target"><a href="#annotated-cell-57-23" aria-hidden="true" tabindex="-1"></a>  successes <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n =</span> <span class="fu">length</span>(orders),</span>
<span id="annotated-cell-57-24"><a href="#annotated-cell-57-24" aria-hidden="true" tabindex="-1"></a>                      <span class="at">size =</span> orders, <span class="at">prob =</span> succ_prob)</span>
<span id="annotated-cell-57-25"><a href="#annotated-cell-57-25" aria-hidden="true" tabindex="-1"></a>  </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-57" data-target-annotation="9" onclick="event.preventDefault();" href="">9</a><span id="annotated-cell-57-26" class="code-annotation-target"><a href="#annotated-cell-57-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">orders =</span> orders,</span>
<span id="annotated-cell-57-27"><a href="#annotated-cell-57-27" aria-hidden="true" tabindex="-1"></a>                <span class="at">successes =</span> successes,</span>
<span id="annotated-cell-57-28"><a href="#annotated-cell-57-28" aria-hidden="true" tabindex="-1"></a>                <span class="at">ratio =</span> successes <span class="sc">/</span> orders))</span>
<span id="annotated-cell-57-29"><a href="#annotated-cell-57-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-57-30"><a href="#annotated-cell-57-30" aria-hidden="true" tabindex="-1"></a>}</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-57" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-57" data-code-lines="4" data-code-annotation="1">Если указан тип генерации ‘pois’,</span>
</dd>
<dt data-target-cell="annotated-cell-57" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-57" data-code-lines="5,6" data-code-annotation="2">генерируем выборку в виде распределения Пуассона с заданными параметрами</span>
</dd>
<dt data-target-cell="annotated-cell-57" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-57" data-code-lines="7" data-code-annotation="3">и убираем из неё нули.</span>
</dd>
<dt data-target-cell="annotated-cell-57" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-57" data-code-lines="8,9,10,11" data-code-annotation="4">Если указан тип генерации ‘cmp’, то действуем аналогично, но с функциями и параметрами для распределения CMP.</span>
</dd>
<dt data-target-cell="annotated-cell-57" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-57" data-code-lines="12,13,14,15" data-code-annotation="5">Если указан тип генерации ‘boot’, то генерируем выборку бутстрапом на основе шаблона.</span>
</dd>
<dt data-target-cell="annotated-cell-57" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-57" data-code-lines="16" data-code-annotation="6">Если тип генерации не соответствует этим трём, то функция выдаёт ошибку.</span>
</dd>
<dt data-target-cell="annotated-cell-57" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-57" data-code-lines="19,20" data-code-annotation="7">Генерируем вероятности успеха.</span>
</dd>
<dt data-target-cell="annotated-cell-57" data-target-annotation="8">8</dt>
<dd>
<span data-code-cell="annotated-cell-57" data-code-lines="23,24" data-code-annotation="8">Генерируем число успехов.</span>
</dd>
<dt data-target-cell="annotated-cell-57" data-target-annotation="9">9</dt>
<dd>
<span data-code-cell="annotated-cell-57" data-code-lines="26,27,28" data-code-annotation="9">Возвращаем табличку с числом заказов, числом успехов и долей успехов на пользователя.</span>
</dd>
</dl>
</div>
</div>
<p>На этом мы закончили основные приготовления по части генерации данных. Осталось настроить сами симуляции и уже получать ответы на наши вопросы.</p>
</section>
</section>
<section id="симуляции-реализация" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="симуляции-реализация">4. Симуляции: реализация</h2>
<p>И вот теперь мы наконец-то перешли к тому этапу, ради которого это всё затевалось: мы проверим, контролируется ли вероятность ошибки I рода для конкретного теста, и если да, то какой мощностью он обладает для размера выборки в 2700 наблюдений.</p>
<section id="неправильный-тест" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="неправильный-тест">4.1 “Неправильный” тест</h3>
<p>Начнём с подхода, который мы ранее описывали как “неправильный” – анализ данных по заказам как обычной доли (конверсии), без учёта зависимости между наблюдениями. Мы можем это сделать (как минимум) тремя разными статтестами:</p>
<ol type="1">
<li><em>Z-тест пропорций</em>, для которого и считался размер выборки во втором разделе. Функция – <code>prop.test()</code>.</li>
<li><em>Тест хи-квадрат</em> – для таблицы сопряжённости 2x2 он будет идентичен z-тесту пропорций. Функция – <code>chisq.test()</code>.</li>
<li><em>T-тест средних</em> – так как пропорции являются разновидностью средних, и с ростом размера выборки он будет давать очень близкие к z-тесту результаты<a href="#fn48" class="footnote-ref" id="fnref48" role="doc-noteref"><sup>48</sup></a>. Функция – <code>t.test()</code>.</li>
</ol>
<div class="no-row-height column-margin column-container"><div id="fn48"><p><sup>48</sup>&nbsp;На самом деле z-тест тоже является тестом средних, просто в иной обёртке. Основное отличие z-теста и t-теста заключается в распределении тестовой статистики: у z-теста она распределена нормально, у t-теста – согласно <a href="https://en.wikipedia.org/wiki/Student%27s_t-distribution">распределению Стьюдента</a>. С ростом размера выборки распределение Стьюдента становится всё больше похожим на нормальное, поэтому и результаты двух тестов должны примерно совпадать.</p></div></div><p>Почему пропорции являются разновидностью средних? Давайте посмотрим на конкретном примере:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2112</span>)</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>(conv_example <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n =</span> <span class="dv">10</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> <span class="fl">0.5</span>))</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 1 0 0 0 0 1 0 0 1 0</code></pre>
</div>
</div>
<p>Здесь у нас типичное распределение Бернулли: нолики и единички. Всего чисел 10, единичек 3 – а значит, их пропорция равна <span class="math inline">\(\frac{3}{10} = 0.3\)</span>.</p>
<p>Что насчёт среднего? Оно считается по этой формуле:</p>
<p><span class="math display">\[
\frac{\sum_{i=1}^{n}x_i}{n} = \frac{\text{сумма значений}}{\text{число значений}}
\]</span></p>
<p>Сумма значений у нас равна 3 – так как сумма всех 0 у нас тоже даст 0, а единичек у нас 3 (1 + 1 + 1 = 3). Число значений у нас, опять же, 10. Так у нас снова получилось <span class="math inline">\(\frac{3}{10}\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Пропорция единиц: {3/10}</span><span class="sc">\n</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="st">                  Среднее: {mean(conv_example)}"</span>))</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Пропорция единиц: 0.3

Среднее: 0.3</code></pre>
</div>
</div>
<p>Давайте теперь посмотрим на p-значения трёх тестов и оценим степень их схожести. В случае t-теста мы можем просто поместить на вход наборы 0 и 1. В случае z-теста и хи-квадрата ситуация сложнее – данные нужно представить в формате таблицы сопряжённости:</p>
<table class="caption-top table">
<tbody>
<tr class="odd">
<td>Число успехов в контрольной группе</td>
<td>Число успехов в тестовой группе</td>
</tr>
<tr class="even">
<td>Число неудач в контрольной группе</td>
<td>Число неудач в тестовой группе</td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2112</span>)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="co">#симулированные данные конверсии</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>control <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n =</span> <span class="dv">1000</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> <span class="fl">0.5</span>)</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n =</span> <span class="dv">1000</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> <span class="fl">0.5</span>)</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>(cont_table <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">data =</span> <span class="fu">c</span>(<span class="fu">sum</span>(control), <span class="fu">sum</span>(test), </span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>                              <span class="dv">1000</span> <span class="sc">-</span> <span class="fu">sum</span>(control), <span class="dv">1000</span> <span class="sc">-</span> <span class="fu">sum</span>(test)), </span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>                      <span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">ncol =</span> <span class="dv">2</span>))</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2]
[1,]  499  501
[2,]  518  482</code></pre>
</div>
</div>
<p>И теперь скормим эти данные тестам. Вот что получается<a href="#fn49" class="footnote-ref" id="fnref49" role="doc-noteref"><sup>49</sup></a>:</p>
<div class="no-row-height column-margin column-container"><div id="fn49"><p><sup>49</sup>&nbsp;Обратите внимание на аргумент <code>correct = FALSE</code> в функциях хи-квадрата и z-теста. Это так называемая <a href="https://en.wikipedia.org/wiki/Yates%27s_correction_for_continuity">поправка Йетса</a> для малых размеров выборок – в нашем случае она бы избыточно завысила p-значение.</p></div></div><div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>t_results <span class="ot">&lt;-</span> <span class="fu">t.test</span>(control, test) <span class="co">#t-тест</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>chi_results <span class="ot">&lt;-</span> <span class="fu">chisq.test</span>(cont_table, <span class="at">correct =</span> <span class="cn">FALSE</span>) <span class="co">#хи-квадрат</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>z_results <span class="ot">&lt;-</span> <span class="fu">prop.test</span>(cont_table, <span class="at">correct =</span> <span class="cn">FALSE</span>) <span class="co">#z-тест пропорций</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"P-значение t-теста: {t_results$p.value}</span><span class="sc">\n</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a><span class="st">                  P-значение хи-квадрата: {chi_results$p.value}</span><span class="sc">\n</span></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a><span class="st">                  P-значение z-теста пропорций: {z_results$p.value}"</span>))</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>P-значение t-теста: 0.395673196861856

P-значение хи-квадрата: 0.39542036385128

P-значение z-теста пропорций: 0.39542036385128</code></pre>
</div>
</div>
<p>Хорошо видно, что хи-квадрат и z-тест выдали идеально идентичные результаты. P-значение t-теста немного отличается, но различия начинаются с 4 знака после запятой – для наших целей это более чем достаточное приближение.</p>
<p>Для удобства дальше мы будем использовать как раз t-тест – не нужно будет мучиться с созданием таблиц сопряжённости. Но всё ещё нужно разобраться с другой проблемой: наши данные могут содержать не только 0-1, но ещё и другие значения.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2112</span>)</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sim_buyer_data</span>(<span class="at">size =</span> <span class="dv">1000</span>, <span class="at">type =</span> <span class="st">"boot"</span>, </span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">mean_prob =</span> <span class="fl">0.5</span>, <span class="at">template =</span> prob_table) <span class="sc">%&gt;%</span> </span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(orders <span class="sc">&gt;</span> <span class="dv">1</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 27 × 3
   orders successes ratio
    &lt;int&gt;     &lt;int&gt; &lt;dbl&gt;
 1      2         1 0.5  
 2      2         2 1    
 3      2         2 1    
 4     17         2 0.118
 5      2         1 0.5  
 6      2         1 0.5  
 7      2         0 0    
 8      2         1 0.5  
 9      2         0 0    
10      3         2 0.667
# ℹ 17 more rows</code></pre>
</div>
</div>
<p>Разберёмся с этим с помощью функции <code>rep()</code>, которая повторяет значения: повторим 0 и 1 необходимое нам число раз, и получим нужную выборку. Например, если у нас было суммарно 20 заказов и из них 5 успешные, то код будет примерно такой:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rep</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">times =</span> <span class="fu">c</span>(<span class="dv">20</span> <span class="sc">-</span> <span class="dv">5</span>, <span class="dv">5</span>))</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 1 1 1</code></pre>
</div>
</div>
<p>Порядок чисел нам не важен, так как на статистический тест он не влияет – нужно только необходимое число нулей и единиц.</p>
<p>Пишем функцию, которая будет генерировать данные теста и контроля, а затем сравнивать их! Фактически это и будет синтетическим A/B-тестом. Аргументы те же, что и у функции генерации данных, однако вместо <code>mean_prob</code> будут два аргумента: <code>mean_control</code> и <code>mean_test</code>. Это будет означать среднюю вероятность успеха в контрольной и тестовой группе, соответственно.</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-64"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-64-1"><a href="#annotated-cell-64-1" aria-hidden="true" tabindex="-1"></a>test_wrong_test <span class="ot">&lt;-</span> <span class="cf">function</span>(size, type, mean_control, mean_test, template){</span>
<span id="annotated-cell-64-2"><a href="#annotated-cell-64-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-64-3"><a href="#annotated-cell-64-3" aria-hidden="true" tabindex="-1"></a>  </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-64" data-target-annotation="1" onclick="event.preventDefault();" href="">1</a><span id="annotated-cell-64-4" class="code-annotation-target"><a href="#annotated-cell-64-4" aria-hidden="true" tabindex="-1"></a>  control <span class="ot">&lt;-</span> <span class="fu">sim_buyer_data</span>(<span class="at">size =</span> size, <span class="at">type =</span> type,</span>
<span id="annotated-cell-64-5"><a href="#annotated-cell-64-5" aria-hidden="true" tabindex="-1"></a>                            <span class="at">mean_prob =</span> mean_control,</span>
<span id="annotated-cell-64-6"><a href="#annotated-cell-64-6" aria-hidden="true" tabindex="-1"></a>                            <span class="at">template =</span> template)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-64" data-target-annotation="2" onclick="event.preventDefault();" href="">2</a><span id="annotated-cell-64-7" class="code-annotation-target"><a href="#annotated-cell-64-7" aria-hidden="true" tabindex="-1"></a>  test <span class="ot">&lt;-</span> <span class="fu">sim_buyer_data</span>(<span class="at">size =</span> size, <span class="at">type =</span> type,</span>
<span id="annotated-cell-64-8"><a href="#annotated-cell-64-8" aria-hidden="true" tabindex="-1"></a>                            <span class="at">mean_prob =</span> mean_test,</span>
<span id="annotated-cell-64-9"><a href="#annotated-cell-64-9" aria-hidden="true" tabindex="-1"></a>                            <span class="at">template =</span> template)</span>
<span id="annotated-cell-64-10"><a href="#annotated-cell-64-10" aria-hidden="true" tabindex="-1"></a>  </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-64" data-target-annotation="3" onclick="event.preventDefault();" href="">3</a><span id="annotated-cell-64-11" class="code-annotation-target"><a href="#annotated-cell-64-11" aria-hidden="true" tabindex="-1"></a>  control_conv <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="annotated-cell-64-12"><a href="#annotated-cell-64-12" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">c</span>(<span class="fu">sum</span>(control<span class="sc">$</span>orders) <span class="sc">-</span> <span class="fu">sum</span>(control<span class="sc">$</span>successes),</span>
<span id="annotated-cell-64-13"><a href="#annotated-cell-64-13" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">sum</span>(control<span class="sc">$</span>successes)))</span>
<span id="annotated-cell-64-14"><a href="#annotated-cell-64-14" aria-hidden="true" tabindex="-1"></a>  test_conv <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="annotated-cell-64-15"><a href="#annotated-cell-64-15" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">c</span>(<span class="fu">sum</span>(test<span class="sc">$</span>orders) <span class="sc">-</span> <span class="fu">sum</span>(test<span class="sc">$</span>successes),</span>
<span id="annotated-cell-64-16"><a href="#annotated-cell-64-16" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">sum</span>(test<span class="sc">$</span>successes)))</span>
<span id="annotated-cell-64-17"><a href="#annotated-cell-64-17" aria-hidden="true" tabindex="-1"></a>  </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-64" data-target-annotation="4" onclick="event.preventDefault();" href="">4</a><span id="annotated-cell-64-18" class="code-annotation-target"><a href="#annotated-cell-64-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">t.test</span>(control_conv, test_conv)<span class="sc">$</span>p.value)</span>
<span id="annotated-cell-64-19"><a href="#annotated-cell-64-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-64-20"><a href="#annotated-cell-64-20" aria-hidden="true" tabindex="-1"></a>}</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-64" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-64" data-code-lines="4,5,6" data-code-annotation="1">Генерируем данные контрольной группы.</span>
</dd>
<dt data-target-cell="annotated-cell-64" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-64" data-code-lines="7,8,9" data-code-annotation="2">Генерируем данные тестовой группы.</span>
</dd>
<dt data-target-cell="annotated-cell-64" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-64" data-code-lines="11,12,13,14,15,16" data-code-annotation="3">Преобразовываем данные контрольной и тестовой группы в формат 0 и 1.</span>
</dd>
<dt data-target-cell="annotated-cell-64" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-64" data-code-lines="18" data-code-annotation="4">Сравниваем группы t-тестом и возвращаем p-значение.</span>
</dd>
</dl>
</div>
</div>
<p>Если выполнить функцию выше много-много раз, то у нас будет много-много p-значений. Если посчитать среди них долю статистически значимых различий (=долю p-значений &lt; 0.05), то мы получим значение <strong>мощности</strong><a href="#fn50" class="footnote-ref" id="fnref50" role="doc-noteref"><sup>50</sup></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn50"><p><sup>50</sup>&nbsp;Если мы будем генерировать данные с одинаковыми средними (т.е. без различий), то вместо мощности мы получим FPR.</p></div></div><p>Сделаем и под это функцию – аргументы все те же, что и у предыдущей, но есть два новых:</p>
<ul>
<li><p><code>func</code> – функция, имитирующая A/B-тест и генерирующая p-значения (вроде той, которую мы написали выше).</p></li>
<li><p><code>iter</code> – количество повторений. По умолчанию поставим значение 1000.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-65"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-65-1"><a href="#annotated-cell-65-1" aria-hidden="true" tabindex="-1"></a>power_sim <span class="ot">&lt;-</span> <span class="cf">function</span>(func, size, type, mean_control, mean_test, </span>
<span id="annotated-cell-65-2"><a href="#annotated-cell-65-2" aria-hidden="true" tabindex="-1"></a>                             template, <span class="at">iter =</span> <span class="dv">1000</span>){</span>
<span id="annotated-cell-65-3"><a href="#annotated-cell-65-3" aria-hidden="true" tabindex="-1"></a>  </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-65" data-target-annotation="1" onclick="event.preventDefault();" href="">1</a><span id="annotated-cell-65-4" class="code-annotation-target"><a href="#annotated-cell-65-4" aria-hidden="true" tabindex="-1"></a>  pvals <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(<span class="at">.x =</span> <span class="dv">1</span><span class="sc">:</span>iter,</span>
<span id="annotated-cell-65-5"><a href="#annotated-cell-65-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">.f =</span> \(x) <span class="fu">func</span>(<span class="at">size =</span> size, <span class="at">type =</span> type,</span>
<span id="annotated-cell-65-6"><a href="#annotated-cell-65-6" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">mean_control =</span> mean_control,</span>
<span id="annotated-cell-65-7"><a href="#annotated-cell-65-7" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">mean_test =</span> mean_test,</span>
<span id="annotated-cell-65-8"><a href="#annotated-cell-65-8" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">template =</span> template))</span>
<span id="annotated-cell-65-9"><a href="#annotated-cell-65-9" aria-hidden="true" tabindex="-1"></a>  </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-65" data-target-annotation="2" onclick="event.preventDefault();" href="">2</a><span id="annotated-cell-65-10" class="code-annotation-target"><a href="#annotated-cell-65-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">mean</span>(pvals <span class="sc">&lt;</span> <span class="fl">0.05</span>))</span>
<span id="annotated-cell-65-11"><a href="#annotated-cell-65-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-65-12"><a href="#annotated-cell-65-12" aria-hidden="true" tabindex="-1"></a>}</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-65" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-65" data-code-lines="4,5,6,7,8" data-code-annotation="1">Генерируем p-значения, число которых равно <code>iter</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-65" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-65" data-code-lines="10" data-code-annotation="2">Возвращаем долю p-значений, равную 0.05.</span>
</dd>
</dl>
</div>
</div>
<p>Само собой, оценённая мощность может не совпадать с реальной мощностью. Чтобы оценить её точнее, мы можем увеличить число A/B-тестов – а ещё мы можем <strong>посчитать мощность несколько раз</strong>. В таком случае у нас получится не одно значение мощности, а целое распределение, которое будет кучковаться вокруг истинного значения мощности. Таким образом мы сможем оценить не только мощность, но и дисперсию этой мощности.</p>
<p>Опять же, делаем функцию!</p>
<ul>
<li><p>Аргумент <code>func</code> делим на два – <code>power_func</code> для функции расчёта мощности и <code>test_func</code> для функции синтетического A/B-теста.</p></li>
<li><p><code>repeats</code> – число повторных расчётом мощности (по умолчанию тоже 1000).</p></li>
<li><p><code>prog</code> – аргумент для шкалы прогресса (подробнее в следующем разделе).</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-66"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-66-1"><a href="#annotated-cell-66-1" aria-hidden="true" tabindex="-1"></a>var_power_sim <span class="ot">&lt;-</span> <span class="cf">function</span>(power_func, test_func, </span>
<span id="annotated-cell-66-2"><a href="#annotated-cell-66-2" aria-hidden="true" tabindex="-1"></a>                          size, type, mean_control, mean_test, template, </span>
<span id="annotated-cell-66-3"><a href="#annotated-cell-66-3" aria-hidden="true" tabindex="-1"></a>                          prog, <span class="at">iter =</span> <span class="dv">1000</span>, <span class="at">repeats =</span> <span class="dv">1000</span>){</span>
<span id="annotated-cell-66-4"><a href="#annotated-cell-66-4" aria-hidden="true" tabindex="-1"></a>  </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-66" data-target-annotation="1" onclick="event.preventDefault();" href="">1</a><span id="annotated-cell-66-5" class="code-annotation-target"><a href="#annotated-cell-66-5" aria-hidden="true" tabindex="-1"></a>  powers <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(<span class="at">.x =</span> <span class="dv">1</span><span class="sc">:</span>repeats,</span>
<span id="annotated-cell-66-6"><a href="#annotated-cell-66-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">.f =</span> \(x) <span class="fu">power_func</span>(<span class="at">func =</span> test_func,</span>
<span id="annotated-cell-66-7"><a href="#annotated-cell-66-7" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">size =</span> size, <span class="at">type =</span> type,</span>
<span id="annotated-cell-66-8"><a href="#annotated-cell-66-8" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">mean_control =</span> mean_control,</span>
<span id="annotated-cell-66-9"><a href="#annotated-cell-66-9" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">mean_test =</span> mean_test,</span>
<span id="annotated-cell-66-10"><a href="#annotated-cell-66-10" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">template =</span> template, <span class="at">iter =</span> iter))</span>
<span id="annotated-cell-66-11"><a href="#annotated-cell-66-11" aria-hidden="true" tabindex="-1"></a>  </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-66" data-target-annotation="2" onclick="event.preventDefault();" href="">2</a><span id="annotated-cell-66-12" class="code-annotation-target"><a href="#annotated-cell-66-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prog</span>()</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-66" data-target-annotation="3" onclick="event.preventDefault();" href="">3</a><span id="annotated-cell-66-13" class="code-annotation-target"><a href="#annotated-cell-66-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">type =</span> type, <span class="at">powers =</span> powers))</span>
<span id="annotated-cell-66-14"><a href="#annotated-cell-66-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-66-15"><a href="#annotated-cell-66-15" aria-hidden="true" tabindex="-1"></a>}</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-66" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-66" data-code-lines="5,6,7,8,9,10" data-code-annotation="1">Считаем мощность число раз, равное repeats.</span>
</dd>
<dt data-target-cell="annotated-cell-66" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-66" data-code-lines="12" data-code-annotation="2">Засчитываем итерацию для шкалы прогресса.</span>
</dd>
<dt data-target-cell="annotated-cell-66" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-66" data-code-lines="13" data-code-annotation="3">Возвращаем табличку, в которой будет указана модель для числа заказов и мощности.</span>
</dd>
</dl>
</div>
</div>
<p>Последние две функции будут фигурировать практически в каждом из раделом ниже, поэтому повторяться с ними не буду.</p>
<p>Давайте считать показатели!</p>
<section id="fpr" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="fpr">4.1.1 FPR</h4>
<p>Первым делом зададим в обеих группах среднее, равное 0.988, и посчитаем FPR для всех трёх моделей распределения числа заказов. Так мы получим ответ на вопрос: допустимо ли анализировать данные заказов как независимые или это будет ошибкой с нашей стороны?</p>
<p>Как вы можете догадаться, это не самый быстрый расчёт. Чтобы немного ускорить процесс, мы прибегнем к <strong>параллельным вычислениям</strong> – так как ноутбук у меня многоядерный, то мы можем выделить под дело 3 свободных ядра, чтобы они одновременно обсчитывали все три кейса.</p>
<p>В этом нам помогут два пакета:</p>
<ul>
<li><p><code>furrr</code> – как <code>purrr</code>, но поддерживающий параллелизацию. Построен на основе пакета <code>future</code> и является частью экосистемы <code>futureverse</code><a href="#fn51" class="footnote-ref" id="fnref51" role="doc-noteref"><sup>51</sup></a>.</p></li>
<li><p><code>progressr</code> – пакет для создания шкал прогресса при вычислениях. Пригодится, чтобы отслеживать прогресс выполнения наших расчётов.</p></li>
</ul>
<div class="no-row-height column-margin column-container"><div id="fn51"><p><sup>51</sup>&nbsp;Подробнее про то, что это такое и что эта экосистема даёт пользователям R, можно прочитать <a href="https://www.futureverse.org/">тут</a>.</p></div></div><p>Общая процедура для всех вычислений, которые мы будем делать далее, будет выглядеть так:</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-67"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><a class="code-annotation-anchor" data-target-cell="annotated-cell-67" data-target-annotation="1" onclick="event.preventDefault();" href="">1</a><span id="annotated-cell-67-1" class="code-annotation-target"><a href="#annotated-cell-67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession, <span class="at">workers =</span> <span class="dv">3</span>)</span>
<span id="annotated-cell-67-2"><a href="#annotated-cell-67-2" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-67" data-target-annotation="2" onclick="event.preventDefault();" href="">2</a><span id="annotated-cell-67-3" class="code-annotation-target"><a href="#annotated-cell-67-3" aria-hidden="true" tabindex="-1"></a><span class="fu">with_progress</span>({</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-67" data-target-annotation="3" onclick="event.preventDefault();" href="">3</a><span id="annotated-cell-67-4" class="code-annotation-target"><a href="#annotated-cell-67-4" aria-hidden="true" tabindex="-1"></a>  prog <span class="ot">&lt;-</span> <span class="fu">progressor</span>(<span class="at">steps =</span> <span class="dv">3</span>)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-67" data-target-annotation="4" onclick="event.preventDefault();" href="">4</a><span id="annotated-cell-67-5" class="code-annotation-target"><a href="#annotated-cell-67-5" aria-hidden="true" tabindex="-1"></a>  fpr_res <span class="ot">&lt;-</span> <span class="fu">future_map</span>(<span class="at">.x =</span> <span class="fu">c</span>(<span class="st">"pois"</span>, <span class="st">"cmp"</span>, <span class="st">"boot"</span>),</span>
<span id="annotated-cell-67-6"><a href="#annotated-cell-67-6" aria-hidden="true" tabindex="-1"></a>                        <span class="at">.f =</span> \(x) <span class="fu">var_power_sim</span>(<span class="at">power_func =</span> power_sim,</span>
<span id="annotated-cell-67-7"><a href="#annotated-cell-67-7" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">test_func =</span> test_wrong_test,</span>
<span id="annotated-cell-67-8"><a href="#annotated-cell-67-8" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">size =</span> <span class="dv">2700</span>, <span class="at">type =</span> x,</span>
<span id="annotated-cell-67-9"><a href="#annotated-cell-67-9" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">mean_control =</span> <span class="fl">0.988</span>,</span>
<span id="annotated-cell-67-10"><a href="#annotated-cell-67-10" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">mean_test =</span> <span class="fl">0.988</span>,</span>
<span id="annotated-cell-67-11"><a href="#annotated-cell-67-11" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">template =</span> prob_table,</span>
<span id="annotated-cell-67-12"><a href="#annotated-cell-67-12" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">prog =</span> prog),</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-67" data-target-annotation="5" onclick="event.preventDefault();" href="">5</a><span id="annotated-cell-67-13" class="code-annotation-target"><a href="#annotated-cell-67-13" aria-hidden="true" tabindex="-1"></a>                        <span class="at">.options =</span> <span class="fu">furrr_options</span>(<span class="at">seed =</span> <span class="cn">TRUE</span>))</span>
<span id="annotated-cell-67-14"><a href="#annotated-cell-67-14" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="annotated-cell-67-15"><a href="#annotated-cell-67-15" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-67" data-target-annotation="6" onclick="event.preventDefault();" href="">6</a><span id="annotated-cell-67-16" class="code-annotation-target"><a href="#annotated-cell-67-16" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(sequential)</span>
<span id="annotated-cell-67-17"><a href="#annotated-cell-67-17" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-67" data-target-annotation="7" onclick="event.preventDefault();" href="">7</a><span id="annotated-cell-67-18" class="code-annotation-target"><a href="#annotated-cell-67-18" aria-hidden="true" tabindex="-1"></a>fpr_res <span class="sc">%&gt;%</span></span>
<span id="annotated-cell-67-19"><a href="#annotated-cell-67-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>() <span class="sc">%&gt;%</span></span>
<span id="annotated-cell-67-20"><a href="#annotated-cell-67-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(<span class="st">"fpr_wrong_test.csv"</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-67" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-67" data-code-lines="1" data-code-annotation="1">Выделяем 3 процесса под параллельные вычисления.</span>
</dd>
<dt data-target-cell="annotated-cell-67" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-67" data-code-lines="3" data-code-annotation="2">Функцией <code>with_progress()</code> задаём контекст для шкалы прогресса.</span>
</dd>
<dt data-target-cell="annotated-cell-67" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-67" data-code-lines="4" data-code-annotation="3">Указываем три шага у этой шкалы – шкала будет обновляться при успешном выполнении каждой из трёх симуляций.</span>
</dd>
<dt data-target-cell="annotated-cell-67" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-67" data-code-lines="5,6,7,8,9,10,11,12" data-code-annotation="4">Делаем повторные симуляции для каждой из трёх моделей.</span>
</dd>
<dt data-target-cell="annotated-cell-67" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-67" data-code-lines="13" data-code-annotation="5">В опциях указываем <code>seed = TRUE</code> – это активирует специальный генератор псевдослучайных чисел, адаптированный для параллельных вычислений.</span>
</dd>
<dt data-target-cell="annotated-cell-67" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-67" data-code-lines="16" data-code-annotation="6">После завершения симуляции “освобождаем” три выделенных процесса.</span>
</dd>
<dt data-target-cell="annotated-cell-67" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-67" data-code-lines="18,19,20" data-code-annotation="7">Объединяем все таблички в одну и сохраняем её в csv-файл.</span>
</dd>
</dl>
</div>
</div>
<p>Получаем вот такой результат:</p>
<div class="cell">
<details class="code-fold">
<summary>Рисуем:</summary>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>fpr <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"Data/fpr_wrong_test.csv"</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>fpr <span class="sc">%&gt;%</span> </span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> powers, <span class="at">fill =</span> type)) <span class="sc">+</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"FPR"</span>, <span class="at">y =</span> <span class="st">"Плотность"</span>, </span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Распределение FPR (неправильный тест)"</span>, </span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">"Тип симуляции"</span>) <span class="sc">+</span></span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>  see<span class="sc">::</span><span class="fu">theme_lucid</span>(<span class="at">axis.text.size =</span> <span class="dv">12</span>, </span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>                   <span class="at">legend.text.size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>  title_theme <span class="sc">+</span></span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>  viridis<span class="sc">::</span><span class="fu">scale_fill_viridis</span>(<span class="at">discrete =</span> <span class="cn">TRUE</span>, <span class="at">option =</span> <span class="st">"D"</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/plot%20fpr%20wrong-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Смотрите, какая интересная ситуация получилась. Для распределения Пуассона (<code>'pois'</code>) средняя FPR находится в районе примерно 8-9% – что ощутимо выше 5% и явное свидетельство против использования такого теста.</p>
<p>Однако для двух других вариантов, более похожих на наши реальные данные, средняя FPR находится в районе заветных 5%. Более того, разброс её значений тоже ниже – видимо, даёт о себе знать менее высокая дисперсия по сравнению с Пуассоном.</p>
<p>Из этого факта мы делаем удивительный вывод: если большая часть выборки – это единичные заказы, то анализировать это как независимые наблюдения в целом валидно! По крайней мере, с точки зрения контроля ошибок I рода.</p>
</section>
<section id="мощность" class="level4">
<h4 class="anchored" data-anchor-id="мощность">4.1.2 Мощность</h4>
<p>Сделаем то же самое, но для мощности. Как и раньше, ищем различие между долями 0.988 и 0.978. Для распределения Пуассона мощность считать не будем – при завышенной FPR мощность также будет оценена некорректно.</p>
<div class="cell">
<details class="code-fold">
<summary>Код:</summary>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession, <span class="at">workers =</span> <span class="dv">2</span>)</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="fu">with_progress</span>({</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>  prog <span class="ot">&lt;-</span> <span class="fu">progressor</span>(<span class="at">steps =</span> <span class="dv">2</span>)</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>  power_res <span class="ot">&lt;-</span> <span class="fu">future_map</span>(<span class="at">.x =</span> <span class="fu">c</span>(<span class="st">"cmp"</span>, <span class="st">"boot"</span>), </span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>                        <span class="at">.f =</span> \(x) <span class="fu">var_power_sim</span>(<span class="at">power_func =</span> power_sim, </span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">test_func =</span> test_wrong_test,</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">size =</span> <span class="dv">2700</span>, <span class="at">type =</span> x, </span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">mean_control =</span> <span class="fl">0.988</span>, </span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">mean_test =</span> <span class="fl">0.978</span>,</span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">template =</span> prob_table, </span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">prog =</span> prog), </span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a>                        <span class="at">.options =</span> <span class="fu">furrr_options</span>(<span class="at">seed =</span> <span class="cn">TRUE</span>))</span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(sequential)</span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a>power_res <span class="sc">%&gt;%</span> </span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb91-20"><a href="#cb91-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(<span class="st">"power_wrong_test.csv"</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Получаем вот такой результат:</p>
<div class="cell">
<details class="code-fold">
<summary>Рисуем:</summary>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>power <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"Data/power_wrong_test.csv"</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>power <span class="sc">%&gt;%</span> </span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> powers, <span class="at">fill =</span> type)) <span class="sc">+</span></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Мощность"</span>, <span class="at">y =</span> <span class="st">"Плотность"</span>, </span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Распределение мощности (неправильный тест)"</span>, </span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">"Тип симуляции"</span>) <span class="sc">+</span></span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>  see<span class="sc">::</span><span class="fu">theme_lucid</span>(<span class="at">axis.text.size =</span> <span class="dv">12</span>, </span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>                   <span class="at">legend.text.size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>  title_theme <span class="sc">+</span></span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>  viridis<span class="sc">::</span><span class="fu">scale_fill_viridis</span>(<span class="at">discrete =</span> <span class="cn">TRUE</span>, <span class="at">option =</span> <span class="st">"H"</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/plot%20power%20wrong-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Для обеих симуляций мощность вышла одинаковой! Более того – её величина примерно в районе 82% (даже чуть выше), что примерно совпадает с посчитанным значением мощности в функции <code>pwr.2p.test()</code>. Значит, наши расчёты тогда в итоге оказались корректными, и для этой метрики мощность действительно именно такая.</p>
<p>Но что с другими вариантами?</p>
</section>
</section>
<section id="средняя-доля-на-пользователя" class="level3">
<h3 class="anchored" data-anchor-id="средняя-доля-на-пользователя">4.2 Средняя доля на пользователя</h3>
<p>Сделаем отдельный синтетический A/B-тест для долей успехов на пользователя. Эта функция будет по содержимому проще предыдущей – нам не нужно как-то специально что-то преобразовывать.</p>
<div class="cell">
<details class="code-fold">
<summary>Код:</summary>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>test_mean_ctr <span class="ot">&lt;-</span> <span class="cf">function</span>(size, type, mean_control, mean_test, template){</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>  control <span class="ot">&lt;-</span> <span class="fu">sim_buyer_data</span>(<span class="at">size =</span> size, <span class="at">type =</span> type, </span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>                            <span class="at">mean_prob =</span> mean_control, </span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>                            <span class="at">template =</span> template)</span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>  test <span class="ot">&lt;-</span> <span class="fu">sim_buyer_data</span>(<span class="at">size =</span> size, <span class="at">type =</span> type, </span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>                         <span class="at">mean_prob =</span> mean_test, </span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>                         <span class="at">template =</span> template)</span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">t.test</span>(control<span class="sc">$</span>ratio, test<span class="sc">$</span>ratio)<span class="sc">$</span>p.value)</span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Всё остальное неизменно.</p>
<section id="fpr-1" class="level4">
<h4 class="anchored" data-anchor-id="fpr-1">4.2.1 FPR</h4>
<p>Считаем FPR:</p>
<div class="cell">
<details class="code-fold">
<summary>Рисуем:</summary>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>fpr<span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"Data/fpr_mean_ctr.csv"</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>fpr <span class="sc">%&gt;%</span> </span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> powers, <span class="at">fill =</span> type)) <span class="sc">+</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"FPR"</span>, <span class="at">y =</span> <span class="st">"Плотность"</span>, </span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Распределение FPR (средняя доля на пользователя)"</span>, </span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">"Тип симуляции"</span>) <span class="sc">+</span></span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>  see<span class="sc">::</span><span class="fu">theme_lucid</span>(<span class="at">axis.text.size =</span> <span class="dv">12</span>, </span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>                   <span class="at">legend.text.size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a>  title_theme <span class="sc">+</span></span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a>  viridis<span class="sc">::</span><span class="fu">scale_fill_viridis</span>(<span class="at">discrete =</span> <span class="cn">TRUE</span>, <span class="at">option =</span> <span class="st">"D"</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/plot%20fpr%20ctr-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Вот теперь всё в порядке – все три типа симуляций кучкуются вокруг 5%-ой FPR с сопоставимым разбросом значений. Значит, ошибка I рода вполне себе контролируется.</p>
</section>
<section id="мощность-1" class="level4">
<h4 class="anchored" data-anchor-id="мощность-1">4.2.2 Мощность</h4>
<p>Провернём это же с мощностью:</p>
<div class="cell">
<details class="code-fold">
<summary>Рисуем:</summary>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>power <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"Data/power_mean_ctr.csv"</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>power <span class="sc">%&gt;%</span> </span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> powers, <span class="at">fill =</span> type)) <span class="sc">+</span></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Мощность"</span>, <span class="at">y =</span> <span class="st">"Плотность"</span>, </span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Распределение мощности (средняя доля на пользователя)"</span>, </span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">"Тип симуляции"</span>) <span class="sc">+</span></span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>  see<span class="sc">::</span><span class="fu">theme_lucid</span>(<span class="at">axis.text.size =</span> <span class="dv">12</span>, </span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a>                   <span class="at">legend.text.size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a>  title_theme <span class="sc">+</span></span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a>  viridis<span class="sc">::</span><span class="fu">scale_fill_viridis</span>(<span class="at">discrete =</span> <span class="cn">TRUE</span>, <span class="at">option =</span> <span class="st">"H"</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/plot%20power%20mean%20ctr-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Для бутстрапа и CMP мощность оказалась такая же, как и выше – дополнительное свидетельство в пользу корректности того подхода (а также того, что <code>pwr.t.test()</code> чудовищно недооценил размер выборки). Но с распределением Пуассона ситуация иная: при адекватном контроле ошибки I рода мощность оказалась выше – в районе 88%. Запомним это.</p>
</section>
</section>
<section id="линеаризованная-доля" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="линеаризованная-доля">4.3 Линеаризованная доля</h3>
<p>Осталось провернуть то же самое для метода линеаризации:</p>
<div class="cell">
<details class="code-fold">
<summary>Код:</summary>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>test_lin_ctr <span class="ot">&lt;-</span> <span class="cf">function</span>(size, type, mean_control, mean_test, template){</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>  control <span class="ot">&lt;-</span> <span class="fu">sim_buyer_data</span>(<span class="at">size =</span> size, <span class="at">type =</span> type, </span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>                            <span class="at">mean_prob =</span> mean_control, </span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>                            <span class="at">template =</span> template)</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>  test <span class="ot">&lt;-</span> <span class="fu">sim_buyer_data</span>(<span class="at">size =</span> size, <span class="at">type =</span> type, </span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>                         <span class="at">mean_prob =</span> mean_test, </span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>                         <span class="at">template =</span> template)</span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>  ctr_control <span class="ot">&lt;-</span> <span class="fu">sum</span>(control<span class="sc">$</span>successes) <span class="sc">/</span> <span class="fu">sum</span>(control<span class="sc">$</span>orders)       </span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>  control_lin <span class="ot">&lt;-</span> control<span class="sc">$</span>successes <span class="sc">-</span> ctr_control <span class="sc">*</span> control<span class="sc">$</span>orders   </span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a>  test_lin <span class="ot">&lt;-</span> test<span class="sc">$</span>successes <span class="sc">-</span> ctr_control <span class="sc">*</span> test<span class="sc">$</span>orders            </span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">t.test</span>(control_lin, test_lin)<span class="sc">$</span>p.value)</span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb96-18"><a href="#cb96-18" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Считаем.</p>
<section id="fpr-2" class="level4">
<h4 class="anchored" data-anchor-id="fpr-2">4.3.1 FPR</h4>
<p>Сначала FPR:</p>
<div class="cell">
<details class="code-fold">
<summary>Рисуем:</summary>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>fpr<span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"Data/fpr_lin.csv"</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>fpr <span class="sc">%&gt;%</span> </span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> powers, <span class="at">fill =</span> type)) <span class="sc">+</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"FPR"</span>, <span class="at">y =</span> <span class="st">"Плотность"</span>, </span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Распределение FPR (линеаризация)"</span>, </span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">"Тип симуляции"</span>) <span class="sc">+</span></span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>  see<span class="sc">::</span><span class="fu">theme_lucid</span>(<span class="at">axis.text.size =</span> <span class="dv">12</span>, </span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>                   <span class="at">legend.text.size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>  title_theme <span class="sc">+</span></span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a>  viridis<span class="sc">::</span><span class="fu">scale_fill_viridis</span>(<span class="at">discrete =</span> <span class="cn">TRUE</span>, <span class="at">option =</span> <span class="st">"D"</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/plot%20fpr%20lin-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Результат в целом идентичен предыдущему.</p>
</section>
<section id="мощность-2" class="level4">
<h4 class="anchored" data-anchor-id="мощность-2">4.3.2 Мощность</h4>
<p>И мощность:</p>
<div class="cell">
<details class="code-fold">
<summary>Рисуем:</summary>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>power <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"Data/power_lin.csv"</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>power <span class="sc">%&gt;%</span> </span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> powers, <span class="at">fill =</span> type)) <span class="sc">+</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Мощность"</span>, <span class="at">y =</span> <span class="st">"Плотность"</span>, </span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Распределение мощности (линеаризация)"</span>, </span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">"Тип симуляции"</span>) <span class="sc">+</span></span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>  see<span class="sc">::</span><span class="fu">theme_lucid</span>(<span class="at">axis.text.size =</span> <span class="dv">12</span>, </span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>                   <span class="at">legend.text.size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a>  title_theme <span class="sc">+</span></span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a>  viridis<span class="sc">::</span><span class="fu">scale_fill_viridis</span>(<span class="at">discrete =</span> <span class="cn">TRUE</span>, <span class="at">option =</span> <span class="st">"H"</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/plot%20power%20lin-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Аналогичный результат. Всё это свидетельствует в пользу анализа данных как обычной пропорции – и корректности расчётов “неправильным” тестом.</p>
</section>
<section id="кривая-мощности" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="кривая-мощности">4.3.3 Кривая мощности</h4>
<p>Выше мы считали мощность только для конкретного размера выборки (и оценивали её разброс). Но нам ничто не мешает посчитать её для диапазона размеров выборки и нарисовать кривую (уже без оценки разброса – хотя могли бы и это сделать).</p>
<p>Возьмём диапазон от 1600 до 2800 с шагом в 50:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>(samp_sizes <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1600</span>, <span class="dv">2800</span>, <span class="dv">50</span>))</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 1600 1650 1700 1750 1800 1850 1900 1950 2000 2050 2100 2150 2200 2250 2300
[16] 2350 2400 2450 2500 2550 2600 2650 2700 2750 2800</code></pre>
</div>
</div>
<p>Соответствующим образом поправим код симуляции:</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-78"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><a class="code-annotation-anchor" data-target-cell="annotated-cell-78" data-target-annotation="1" onclick="event.preventDefault();" href="">1</a><span id="annotated-cell-78-1" class="code-annotation-target"><a href="#annotated-cell-78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession, <span class="at">workers =</span> <span class="dv">5</span>)</span>
<span id="annotated-cell-78-2"><a href="#annotated-cell-78-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-78-3"><a href="#annotated-cell-78-3" aria-hidden="true" tabindex="-1"></a><span class="fu">with_progress</span>({</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-78" data-target-annotation="2" onclick="event.preventDefault();" href="">2</a><span id="annotated-cell-78-4" class="code-annotation-target"><a href="#annotated-cell-78-4" aria-hidden="true" tabindex="-1"></a>  prog <span class="ot">&lt;-</span> <span class="fu">progressor</span>(<span class="at">steps =</span> <span class="fu">length</span>(samp_sizes))</span>
<span id="annotated-cell-78-5"><a href="#annotated-cell-78-5" aria-hidden="true" tabindex="-1"></a>  lin_res <span class="ot">&lt;-</span> <span class="fu">future_map</span>(<span class="at">.x =</span> samp_sizes,</span>
<span id="annotated-cell-78-6"><a href="#annotated-cell-78-6" aria-hidden="true" tabindex="-1"></a>                        <span class="at">.f =</span> \(x) <span class="fu">power_sim</span>(<span class="at">func =</span> test_lin, </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-78" data-target-annotation="3" onclick="event.preventDefault();" href="">3</a><span id="annotated-cell-78-7" class="code-annotation-target"><a href="#annotated-cell-78-7" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">size =</span> x, <span class="at">type =</span> <span class="st">"boot"</span>,</span>
<span id="annotated-cell-78-8"><a href="#annotated-cell-78-8" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">mean_control =</span> <span class="fl">0.988</span>, </span>
<span id="annotated-cell-78-9"><a href="#annotated-cell-78-9" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">mean_test =</span> <span class="fl">0.978</span>, </span>
<span id="annotated-cell-78-10"><a href="#annotated-cell-78-10" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">template =</span> prob_table, </span>
<span id="annotated-cell-78-11"><a href="#annotated-cell-78-11" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">prog =</span> prog, </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-78" data-target-annotation="4" onclick="event.preventDefault();" href="">4</a><span id="annotated-cell-78-12" class="code-annotation-target"><a href="#annotated-cell-78-12" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">iter =</span> <span class="dv">10000</span>),</span>
<span id="annotated-cell-78-13"><a href="#annotated-cell-78-13" aria-hidden="true" tabindex="-1"></a>                        <span class="at">.options =</span> <span class="fu">furrr_options</span>(<span class="at">seed =</span> <span class="cn">TRUE</span>))</span>
<span id="annotated-cell-78-14"><a href="#annotated-cell-78-14" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="annotated-cell-78-15"><a href="#annotated-cell-78-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-78-16"><a href="#annotated-cell-78-16" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(sequential)</span>
<span id="annotated-cell-78-17"><a href="#annotated-cell-78-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-78-18"><a href="#annotated-cell-78-18" aria-hidden="true" tabindex="-1"></a>lin_res <span class="sc">%&gt;%</span> </span>
<span id="annotated-cell-78-19"><a href="#annotated-cell-78-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>() <span class="sc">%&gt;%</span> </span>
<span id="annotated-cell-78-20"><a href="#annotated-cell-78-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(<span class="st">"curve_lin.csv"</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-78" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-78" data-code-lines="1" data-code-annotation="1">Увеличим число потоков до 5.</span>
</dd>
<dt data-target-cell="annotated-cell-78" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-78" data-code-lines="4,5" data-code-annotation="2">Итерируемся теперь не по типам симуляции, а по размерам выборок – соответствующим образом поменяем шкалу прогресса.</span>
</dd>
<dt data-target-cell="annotated-cell-78" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-78" data-code-lines="7" data-code-annotation="3">В качестве типа симуляции выберем бутстрап – остальные смотреть не будем.</span>
</dd>
<dt data-target-cell="annotated-cell-78" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-78" data-code-lines="12" data-code-annotation="4">Увеличим число синтетических A/B-тестов до 10000, чтобы оценка мощности была точнее.</span>
</dd>
</dl>
</div>
</div>
<p>Рисуем кривую:</p>
<div class="cell">
<details class="code-fold">
<summary>Рисуем:</summary>
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>power_curve <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"Data/curve_lin.csv"</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>power_curve <span class="sc">%&gt;%</span> </span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> size, <span class="at">y =</span> power, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Размер выборки"</span>, <span class="at">y =</span> <span class="st">"Мощность"</span>, </span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Кривая мощности (бутстрап)"</span>) <span class="sc">+</span></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>  see<span class="sc">::</span><span class="fu">theme_lucid</span>(<span class="at">axis.text.size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>  title_theme</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/plot%20curve%20lin-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Вот таким образом мощность связана с размером выборки в нашей симуляции – при желании можно более точечно смотреть на отдельные сегменты этой кривой и выбирать нужный размер выборки.</p>
<p>Вот и всё…казалось бы. Но всё это время мы игнорировали один важный момент: этот результат останется валидным только при одном условии.</p>
<p><strong>Число заказов на пользователя не изменится.</strong></p>
<p>Что если в результате нововведения пользователи заинтересуются нашим продуктом и начнут делать больше заказов? В таком случае наши данные вполне могут оказаться похожими на распределение Пуассона – и это будет значить две вещи:</p>
<ol type="1">
<li>Анализ доли успешных заказов как независимых наблюдений будет некорректным.</li>
<li>Реальная мощность окажется выше, чем мы предполагали.</li>
</ol>
<p>Второй пункт очень интересен, так как он отражает очень важное допущение формул размера выборки: они предполагают, что <strong>интересующая нас метрика измерена достаточно точно</strong>. Однако как мы уже говорили, это не так: реальные вероятности успешности заказа скрываются за малым числом заказов<a href="#fn52" class="footnote-ref" id="fnref52" role="doc-noteref"><sup>52</sup></a>. Значит, можно предположить следующее: <strong>чем больше заказов на пользователя – тем выше мощность теста</strong>.</p>
<div class="no-row-height column-margin column-container"><div id="fn52"><p><sup>52</sup>&nbsp;Такие переменные в статистической литературе называют <em>латентными</em>, т.е. скрытыми от прямого наблюдения.</p></div></div><p>Давайте это дополнительно проверим.</p>
</section>
</section>
<section id="линеаризованная-доля-варианты-пуассона" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="линеаризованная-доля-варианты-пуассона">4.4 Линеаризованная доля: варианты Пуассона</h3>
<p>Попробуем в качестве модели числа заказов взять распределение Пуассона, но с разными значениями <span class="math inline">\(\lambda\)</span> – 1, 2, 3. Выглядят эти распределения так:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/several%20poissons-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Слегка модифицируем наш код для симуляций данных – уберём опции бутстрапа и CMP, а вместо них дадим возможность регулировать параметр <code>lambda</code>.</p>
<div class="cell">
<details class="code-fold">
<summary>Новый вариант симуляции:</summary>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>sim_buyer_data_pois <span class="ot">&lt;-</span> <span class="cf">function</span>(size, lambda, prop_discard, mean_prob){</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>  orders <span class="ot">&lt;-</span> <span class="fu">rpois</span>(<span class="at">n =</span> <span class="fu">round</span>(size <span class="sc">/</span> prop_discard), <span class="at">lambda =</span> lambda)</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>  orders <span class="ot">&lt;-</span> orders[orders <span class="sc">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>  succ_prob <span class="ot">&lt;-</span> <span class="fu">rprop</span>(<span class="at">n =</span> <span class="fu">length</span>(orders), <span class="at">size =</span> <span class="dv">2</span>, <span class="at">mean =</span> mean_prob)</span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a>  successes <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n =</span> <span class="fu">length</span>(orders), <span class="at">size =</span> orders, <span class="at">prob =</span> succ_prob)</span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">orders =</span> orders, </span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a>                <span class="at">successes =</span> successes, </span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a>                <span class="at">ratio =</span> successes <span class="sc">/</span> orders))</span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>И теперь ответим на последние вопросы этой работы.</p>
<section id="fpr-неправильный-тест-распределение" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="fpr-неправильный-тест-распределение">4.4.1 FPR (неправильный тест, распределение)</h4>
<p>Мы уже видели, что с распределением Пуассона анализ заказов как независимых наблюдений завышает FPR. Станет ли ситуация ещё хуже, если число заказов на пользователя увеличится?</p>
<p>Сделаем под это функцию синтетического A/B-теста<a href="#fn53" class="footnote-ref" id="fnref53" role="doc-noteref"><sup>53</sup></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn53"><p><sup>53</sup>&nbsp;Само собой, функции расчёта мощности тоже изменились, но я не буду их повторять – изменения в аргументах те же самые, логика в остальном сохранилась.</p></div></div><div class="cell">
<details class="code-fold">
<summary>Новый вариант симуляции</summary>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>test_wrong_pois <span class="ot">&lt;-</span> <span class="cf">function</span>(size, mean_control, mean_test, lambda){</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">#найдём пропорцию нулей</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>  prop_discard <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">dpois</span>(<span class="at">x =</span> <span class="dv">0</span>, <span class="at">lambda =</span> lambda)</span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">#генерируем данные</span></span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>  control <span class="ot">&lt;-</span> <span class="fu">sim_buyer_data_pois</span>(<span class="at">size =</span> size, </span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">lambda =</span> lambda, </span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">prop_discard =</span> prop_discard,</span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">mean_prob =</span> mean_control)</span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a>  test <span class="ot">&lt;-</span> <span class="fu">sim_buyer_data_pois</span>(<span class="at">size =</span> size, </span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a>                              <span class="at">lambda =</span> lambda, </span>
<span id="cb103-15"><a href="#cb103-15" aria-hidden="true" tabindex="-1"></a>                              <span class="at">prop_discard =</span> prop_discard, </span>
<span id="cb103-16"><a href="#cb103-16" aria-hidden="true" tabindex="-1"></a>                              <span class="at">mean_prob =</span> mean_test)</span>
<span id="cb103-17"><a href="#cb103-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb103-18"><a href="#cb103-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">#псевдо-конверсия</span></span>
<span id="cb103-19"><a href="#cb103-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb103-20"><a href="#cb103-20" aria-hidden="true" tabindex="-1"></a>  control_conv <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), </span>
<span id="cb103-21"><a href="#cb103-21" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">c</span>(<span class="fu">sum</span>(control<span class="sc">$</span>orders) <span class="sc">-</span> <span class="fu">sum</span>(control<span class="sc">$</span>successes), <span class="fu">sum</span>(control<span class="sc">$</span>successes)))</span>
<span id="cb103-22"><a href="#cb103-22" aria-hidden="true" tabindex="-1"></a>  test_conv <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), </span>
<span id="cb103-23"><a href="#cb103-23" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">c</span>(<span class="fu">sum</span>(test<span class="sc">$</span>orders) <span class="sc">-</span> <span class="fu">sum</span>(test<span class="sc">$</span>successes), <span class="fu">sum</span>(test<span class="sc">$</span>successes)))</span>
<span id="cb103-24"><a href="#cb103-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb103-25"><a href="#cb103-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">t.test</span>(control_conv, test_conv)<span class="sc">$</span>p.value)</span>
<span id="cb103-26"><a href="#cb103-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb103-27"><a href="#cb103-27" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Считаем и смотрим на результат:</p>
<div class="cell">
<details class="code-fold">
<summary>Рисуем:</summary>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>fpr<span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"Data/fpr_wrong_pois.csv"</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>fpr <span class="sc">%&gt;%</span> </span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lambda =</span> <span class="fu">factor</span>(lambda)) <span class="sc">%&gt;%</span> </span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> powers, <span class="at">fill =</span> lambda)) <span class="sc">+</span></span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"FPR"</span>, <span class="at">y =</span> <span class="st">"Плотность"</span>, </span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Распределение FPR</span><span class="sc">\n</span><span class="st">(неправильный тест, Пуассон)"</span>, </span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">lambda$"</span>)) <span class="sc">+</span></span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>  see<span class="sc">::</span><span class="fu">theme_lucid</span>(<span class="at">axis.text.size =</span> <span class="dv">12</span>, </span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>                   <span class="at">legend.text.size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>  title_theme <span class="sc">+</span></span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a>  viridis<span class="sc">::</span><span class="fu">scale_fill_viridis</span>(<span class="at">discrete =</span> <span class="cn">TRUE</span>, <span class="at">option =</span> <span class="st">"D"</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/plot%20fpr%20pois-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Действительно – чем выше <span class="math inline">\(\lambda\)</span>, тем хуже ситуация с FPR! В случае 3 заказов в среднем FPR доходит аж до 17%, что совсем ни в какие ворота. Примечательно, что разброс тоже вырос – по всей видимости, это следствие увеличения дисперсии в распределениях.</p>
</section>
<section id="fpr-линеаризация-кривая" class="level4">
<h4 class="anchored" data-anchor-id="fpr-линеаризация-кривая">4.4.1 FPR (линеаризация, кривая)</h4>
<p>Теперь давайте рассмотрим то же самое для линеаризации. Мы уже знаем, что FPR для распределения Пуассона должен быть в районе 0.05 – однако мы можем проверить следующее:</p>
<ol type="1">
<li>Зависит ли FPR от размера выборки?</li>
<li>Зависит ли FPR от <span class="math inline">\(\lambda\)</span>?</li>
</ol>
<p>Опять же, делаем под это функцию синтетического A/B-теста.</p>
<div class="cell">
<details class="code-fold">
<summary>Новый вариант симуляции</summary>
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>test_lin_pois <span class="ot">&lt;-</span> <span class="cf">function</span>(size, mean_control, mean_test, lambda){</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">#найдём пропорцию нулей</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>  prop_discard <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">dpois</span>(<span class="at">x =</span> <span class="dv">0</span>, <span class="at">lambda =</span> lambda)</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">#генерируем данные</span></span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>  control <span class="ot">&lt;-</span> <span class="fu">sim_buyer_data_pois</span>(<span class="at">size =</span> size, </span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">lambda =</span> lambda, </span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">prop_discard =</span> prop_discard,</span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">mean_prob =</span> mean_control)</span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a>  test <span class="ot">&lt;-</span> <span class="fu">sim_buyer_data_pois</span>(<span class="at">size =</span> size, </span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a>                              <span class="at">lambda =</span> lambda, </span>
<span id="cb105-15"><a href="#cb105-15" aria-hidden="true" tabindex="-1"></a>                              <span class="at">prop_discard =</span> prop_discard, </span>
<span id="cb105-16"><a href="#cb105-16" aria-hidden="true" tabindex="-1"></a>                              <span class="at">mean_prob =</span> mean_test)</span>
<span id="cb105-17"><a href="#cb105-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb105-18"><a href="#cb105-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">#контрольное значение метрики</span></span>
<span id="cb105-19"><a href="#cb105-19" aria-hidden="true" tabindex="-1"></a>  ctr_control <span class="ot">&lt;-</span> <span class="fu">sum</span>(control<span class="sc">$</span>successes) <span class="sc">/</span> <span class="fu">sum</span>(control<span class="sc">$</span>orders)</span>
<span id="cb105-20"><a href="#cb105-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb105-21"><a href="#cb105-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">#линеаризованная метрика</span></span>
<span id="cb105-22"><a href="#cb105-22" aria-hidden="true" tabindex="-1"></a>  control_lin <span class="ot">&lt;-</span> control<span class="sc">$</span>successes <span class="sc">-</span> ctr_control <span class="sc">*</span> control<span class="sc">$</span>orders</span>
<span id="cb105-23"><a href="#cb105-23" aria-hidden="true" tabindex="-1"></a>  test_lin <span class="ot">&lt;-</span> test<span class="sc">$</span>successes <span class="sc">-</span> ctr_control <span class="sc">*</span> test<span class="sc">$</span>orders</span>
<span id="cb105-24"><a href="#cb105-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb105-25"><a href="#cb105-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">t.test</span>(control_lin, test_lin)<span class="sc">$</span>p.value)</span>
<span id="cb105-26"><a href="#cb105-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb105-27"><a href="#cb105-27" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Смотрим на результаты:</p>
<div class="cell">
<details class="code-fold">
<summary>Рисуем:</summary>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>fpr_curve <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"Data/curve_lin_pois_fpr.csv"</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>fpr_curve <span class="sc">%&gt;%</span> </span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lambda =</span> <span class="fu">factor</span>(lambda)) <span class="sc">%&gt;%</span> </span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> size, <span class="at">y =</span> power, <span class="at">color =</span> lambda)) <span class="sc">+</span></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Размер выборки"</span>, <span class="at">y =</span> <span class="st">"FPR"</span>, </span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Кривая FPR (линеаризация, Пуассон)"</span>, </span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">lambda$"</span>)) <span class="sc">+</span></span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>  see<span class="sc">::</span><span class="fu">theme_lucid</span>(<span class="at">axis.text.size =</span> <span class="dv">12</span>, </span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>                   <span class="at">legend.text.size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>  title_theme <span class="sc">+</span></span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>  viridis<span class="sc">::</span><span class="fu">scale_color_viridis</span>(<span class="at">discrete =</span> <span class="cn">TRUE</span>, <span class="at">option =</span> <span class="st">"D"</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/plot%20curve%20fpr%20pois-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Может показаться, что FPR достаточно сильно варьирует – однако это не что иное как погрешность измерения. По факту видно, что все три кривые скачут вокруг значения 0.05 – а значит, вероятность ошибки I рода контролируется одинаково хорошо вне зависимости от <span class="math inline">\(\lambda\)</span> и размера выборки.</p>
</section>
<section id="мощность-линеаризация-кривая" class="level4">
<h4 class="anchored" data-anchor-id="мощность-линеаризация-кривая">4.4.2 Мощность (линеаризация, кривая)</h4>
<p>Осталось разобраться лишь с мощностью. Смотрим:</p>
<div class="cell">
<details class="code-fold">
<summary>Рисуем:</summary>
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>power_curve <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"Data/curve_lin_pois.csv"</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>power_curve <span class="sc">%&gt;%</span> </span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lambda =</span> <span class="fu">factor</span>(lambda)) <span class="sc">%&gt;%</span> </span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> size, <span class="at">y =</span> power, <span class="at">color =</span> lambda)) <span class="sc">+</span></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Размер выборки"</span>, <span class="at">y =</span> <span class="st">"Мощность"</span>, </span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Кривая мощности (линеаризация, Пуассон)"</span>, </span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">lambda$"</span>)) <span class="sc">+</span></span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a>  see<span class="sc">::</span><span class="fu">theme_lucid</span>(<span class="at">axis.text.size =</span> <span class="dv">12</span>, </span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a>                   <span class="at">legend.text.size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a>  title_theme <span class="sc">+</span></span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a>  viridis<span class="sc">::</span><span class="fu">scale_color_viridis</span>(<span class="at">discrete =</span> <span class="cn">TRUE</span>, <span class="at">option =</span> <span class="st">"H"</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="simulation-article_files/figure-html/plot%20curve%20lin%20pois-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>А вот на мощность <span class="math inline">\(\lambda\)</span> влияет довольно сильно! С <span class="math inline">\(\lambda = 3\)</span> мощности в 80% вполне себе можно было достичь и с размером выборки в 1800, даже меньше. Впрочем, обратите внимание, что расстояние между 1 и 2 больше, чем между 2 и 3 – это значит, что эффект <span class="math inline">\(\lambda\)</span> на мощность не будет постоянным, а будет постепенно убывать.</p>
</section>
</section>
</section>
<section id="выводы" class="level2">
<h2 class="anchored" data-anchor-id="выводы">5. Выводы</h2>
<p>Что можно сказать по итогу этой работы?</p>
<ol type="1">
<li>Если число заказов на пользователя так и останется в районе 1, то использовать тесты сравнения пропорций вполне допустимо. Однако это будет не лучшим вариантом для бизнеса – если пользователи не делают повторных покупок, то однажды поток заказов прекратится целиком.</li>
<li>Если число заказов на пользователя будет расти, то уже понадобятся полноценные методы работы с метриками-отношениями – иначе мы будем обнаруживать ложные различия чаще, чем хотели бы.</li>
<li>При этом чувствительность к изменениям в метрике “доля успешных заказов” будет расти вместе с ростом числа заказов на пользователя. Это закономерность, которую невозможно было оценить готовыми формулами для расчёта размера выборки.</li>
</ol>
<p>Конечно, это далеко не всё, что можно было бы вытащить из этих данных. Под конец работы у меня сформировались следующие вопросы:</p>
<ol type="1">
<li>Как долго увеличение числа заказов на пользователя будет иметь ощутимый эффект на мощность? В какой момент рост мощности станет нестерпимо медленным?</li>
<li>Как будет влиять на мощность изменение дисперсии вероятностей успеха? Насколько этот эффект будет зависеть от числа заказов на пользователя?</li>
<li>Что, если эффектом воздействия будет не изменение среднего, а изменение дисперсии? С какой мощностью мы сможем обнаруживать такие различия?</li>
</ol>
<p>На эти вопросы я буду искать ответ уже в следующих сериях :)</p>
</section>


</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Скопировано");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Скопировано");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>